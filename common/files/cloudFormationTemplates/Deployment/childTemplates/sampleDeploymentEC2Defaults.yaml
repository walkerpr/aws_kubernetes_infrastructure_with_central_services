AWSTemplateFormatVersion: 2010-09-09
Parameters:
  pAMIId:
    Type: AWS::EC2::Image::Id
    Description: The baseline AMI ID.
  pEnvironment:
    Type: String
    Description: Development? Test Upstream? Prod Upstream?
    AllowedValues:
      - dev
      - upprod
      - uptest
  pFleetInstanceType:
    Description: EC2 instance type
    Type: String
  pDeploymentNumber:
    ConstraintDescription: "The number of the deployment."
    MinValue: 0
    MaxValue: 20
    Description: "The number of the deployment."
    Type: Number
  pVpcPrefix:
    Description: Prefix for VPC.
    Type: String
  pVpcId:
    Description: Id for VPC.
    Type: String
Resources:
  ec2DefaultKey:
    Type: AWS::EC2::KeyPair
    Properties:
      KeyName: !Sub ${pEnvironment}-${pDeploymentNumber}-default-key
      KeyFormat: pem
      KeyType: rsa
  ec2DefaultRole:
    Type: AWS::IAM::Role
    Properties:
      ManagedPolicyArns:
        - "arn:aws-us-gov:iam::aws:policy/AmazonSSMManagedInstanceCore"
      AssumeRolePolicyDocument:
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - ec2.amazonaws.com
            Action:
              - sts:AssumeRole
      Path: /
      RoleName: !Sub ${pEnvironment}-${pDeploymentNumber}-DefaultEC2Role
  ec2DefaultRoleAdditionalPolicy:
    Type: AWS::IAM::ManagedPolicy
    Properties:
      Description: "ec2DefaultRoleAdditionalPolicy"
      ManagedPolicyName: !Sub ${pEnvironment}-${pDeploymentNumber}-ec2DefaultRoleAdditionalPolicy
      PolicyDocument:
        Version: 2012-10-17
        Statement:
          - Sid: VisualEditor3
            Effect: Allow
            Action: s3:PutObject
            Resource: "*"
      Roles:
        - !Ref ec2DefaultRole
  iamProfileDefault:
    Type: AWS::IAM::InstanceProfile
    Properties:
      Roles:
        - Ref: ec2DefaultRole
  ec2DefaultLinuxLaunchTemplate:
    Type: AWS::EC2::LaunchTemplate
    Properties:
      LaunchTemplateName: !Sub ${pEnvironment}-${pDeploymentNumber}-ec2DefaultLinuxLaunchTemplate
      LaunchTemplateData:
        ImageId: !Ref pAMIId
        IamInstanceProfile:
          Name: !Ref iamProfileDefault
        KeyName: !Ref ec2DefaultKey
        MetadataOptions:
          InstanceMetadataTags: enabled
          HttpTokens: required
        BlockDeviceMappings:
          - DeviceName: /dev/sda1
            Ebs:
              VolumeType: gp3
              DeleteOnTermination: "true"
              VolumeSize: "100"
        TagSpecifications:
          - ResourceType: instance
            Tags:
              - Key: "ec2DailyStart"
                Value: "true"
              - Key: "ec2DailyStop"
                Value: "true"
              - Key: "systemGroup"
                Value: "Red Hat Enterprise Linux"
        UserData:
          Fn::Base64: !Sub |
            #!/bin/bash
            TOKEN=`curl -X PUT "http://169.254.169.254/latest/api/token" -H "X-aws-ec2-metadata-token-ttl-seconds: 21600"`
            OSVERSION=$(grep -E '^(VERSION_ID)=' /etc/os-release | awk -F"\"" '{print $2}' | awk -F"." '{print $1}')
            COMPLIANCEID=$(aws ssm get-parameter --name /redhat/insights/rhel$OSVERSION/complianceid --query Parameter.Value --with-decryption --output=text)
            REDHATPASSWORD=$(aws ssm get-parameter --name /redhat/samplerheladmin/password --query Parameter.Value --with-decryption --output=text)
            ROOTPASSWORD=$(aws ssm get-parameter --name /sample/ec2/root/password --query Parameter.Value --with-decryption --output=text)
            InstanceName=`curl -H "X-aws-ec2-metadata-token: $TOKEN" http://169.254.169.254/latest/meta-data/tags/instance/Name`
            hostnamectl set-hostname $InstanceName --static
            dnf install python3.12 -y
            dnf install insights-client scap-security-guide openscap-scanner openscap -y
            subscription-manager register --force --username samplerheladmin --password "$REDHATPASSWORD"
            insights-client --register
            insights-client  --compliance-assign  "$COMPLIANCEID"
            echo "root:$ROOTPASSWORD" | chpasswd
  fleetEC2HostSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: "Enable access from devices within the VPC"
      VpcId: !Ref pVpcId
      SecurityGroupIngress:
        - IpProtocol: -1
          SourcePrefixListId: !Ref pVpcPrefix
  ec2FleetDefaultLinuxLaunchTemplate:
    Type: AWS::EC2::LaunchTemplate
    Properties:
      LaunchTemplateName: !Sub fleet-${pEnvironment}-${pDeploymentNumber}-ec2DefaultLinuxLaunchTemplate
      LaunchTemplateData:
        ImageId: !Ref pAMIId
        IamInstanceProfile:
          Name: !Ref iamProfileDefault
        KeyName: !Ref ec2DefaultKey
        InstanceType: !Ref pFleetInstanceType
        MetadataOptions:
          InstanceMetadataTags: enabled
          HttpTokens: required
        SecurityGroupIds:
          - !Ref fleetEC2HostSecurityGroup
        BlockDeviceMappings:
          - DeviceName: /dev/sda1
            Ebs:
              VolumeType: gp3
              DeleteOnTermination: "true"
              VolumeSize: "100"
        TagSpecifications:
          - ResourceType: instance
            Tags:
              - Key: "ec2DailyStart"
                Value: "true"
              - Key: "ec2DailyStop"
                Value: "true"
              - Key: "systemGroup"
                Value: "Red Hat Enterprise Linux"
              - Key: "deploymentType"
                Value: sampleDeployment
              - Key: "deploymentEnvironment"
                Value: !Ref pEnvironment
              - Key: "sampleDeploymentNumber"
                Value: !Ref pDeploymentNumber
        UserData:
          Fn::Base64: !Sub |
            #!/bin/bash
            OSVERSION=$(grep -E '^(VERSION_ID)=' /etc/os-release | awk -F"\"" '{print $2}' | awk -F"." '{print $1}')
            COMPLIANCEID=$(aws ssm get-parameter --name /redhat/insights/rhel$OSVERSION/complianceid --query Parameter.Value --with-decryption --output=text)
            REDHATPASSWORD=$(aws ssm get-parameter --name /redhat/samplerheladmin/password --query Parameter.Value --with-decryption --output=text)
            ROOTPASSWORD=$(aws ssm get-parameter --name /sample/ec2/root/password --query Parameter.Value --with-decryption --output=text)
            dnf install python3.12 -y
            dnf install insights-client scap-security-guide openscap-scanner openscap -y
            subscription-manager register --force --username samplerheladmin --password "$REDHATPASSWORD"
            insights-client --register
            insights-client  --compliance-assign  "$COMPLIANCEID"
            echo "root:$ROOTPASSWORD" | chpasswd
  ec2DefaultLinuxLaunchTemplateParameterID:
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub "/sample/ec2/sample-deployment-${pDeploymentNumber}/launchtemplate/linux/id"
      Type: String
      Value: !Ref ec2DefaultLinuxLaunchTemplate
      Description: SSM Parameter for ec2DefaultLinuxLaunchTemplate
  ec2DefaultLinuxLaunchTemplateParameterDefaultVersion:
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub "/sample/ec2/sample-deployment-${pDeploymentNumber}/launchtemplate/linux/ver"
      Type: String
      Value: !GetAtt ec2DefaultLinuxLaunchTemplate.LatestVersionNumber
      Description: SSM Parameter for ec2DefaultLinuxLaunchTemplate latest version number.
  ec2FleetDefaultLinuxLaunchTemplateParameterID:
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub "/sample/ec2/sample-deployment-${pDeploymentNumber}/fleetlaunchtemplate/linux/id"
      Type: String
      Value: !Ref ec2FleetDefaultLinuxLaunchTemplate
      Description: SSM Parameter for ec2FleetDefaultLinuxLaunchTemplate
  ec2FleetDefaultLinuxLaunchTemplateParameterDefaultVersion:
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub "/sample/ec2/sample-deployment-${pDeploymentNumber}/fleetlaunchtemplate/linux/ver"
      Type: String
      Value: !GetAtt ec2FleetDefaultLinuxLaunchTemplate.LatestVersionNumber
      Description: SSM Parameter for ec2FleetDefaultLinuxLaunchTemplate latest version number.
  ec2DefaultKeyParameter:
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub "/sample/ec2/sample-deployment-${pDeploymentNumber}/ec2/default-key/id"
      Type: String
      Value: !GetAtt ec2DefaultKey.KeyPairId
      Description: SSM Parameter for ec2DefaultLinuxLaunchTemplate latest version number.
  ec2DefaultKeyNameParameter:
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub "/sample/ec2/sample-deployment-${pDeploymentNumber}/ec2/default-key/name"
      Type: String
      Value: !Ref ec2DefaultKey
      Description: SSM Parameter for ec2DefaultLinuxLaunchTemplate latest version number.
Outputs:
  ec2DefaultKeyOutput:
    Value: !GetAtt ec2DefaultKey.KeyPairId
  ec2DefaultLinuxLaunchTemplateIdOutput:
    Value: !Ref ec2DefaultLinuxLaunchTemplate
  ec2DefaultLinuxLaunchTemplateVerOutput:
    Value: !GetAtt ec2DefaultLinuxLaunchTemplate.LatestVersionNumber
  ec2FleetDefaultLinuxLaunchTemplateIdOutput:
    Value: !Ref ec2FleetDefaultLinuxLaunchTemplate
  ec2FleetDefaultLinuxLaunchTemplateVerOutput:
    Value: !GetAtt ec2FleetDefaultLinuxLaunchTemplate.LatestVersionNumber