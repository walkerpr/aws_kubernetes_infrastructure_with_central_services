AWSTemplateFormatVersion: 2010-09-09
Description: Template for OpenShift Cluster Bootstrap (EC2 Instance, Security Groups and IAM)
Parameters:
  pSampleEnv:
    Type: String
    Description: Production? Test?
    AllowedValues:
      - prod
      - test
  pKubernetesType:
    Type: String
  pEnvironment:
    Type: String
    Description: Development? Test Upstream? Prod Upstream?
    AllowedValues:
      - dev
      - upprod
      - uptest
  pDeploymentNumber:
    ConstraintDescription: "The number of the deployment."
    MinValue: 0
    MaxValue: 20
    Description: "The number of the deployment."
    Type: Number
  pDomain:
    Description: The domain representing the environment (ex. sample.sample.dev or sample.sample.dev)
    Type: String
    AllowedValues:
      - sample
      - sample
  pInfrastructureName:
    AllowedPattern: ^([a-zA-Z][a-zA-Z0-9\-]{0,26})$
    MaxLength: 27
    MinLength: 1
    ConstraintDescription: Infrastructure name must be alphanumeric, start with a letter, and have a maximum of 27 characters.
    Description: A short, unique cluster ID used to tag cloud resources and identify items owned or used by the cluster.
    Type: String
  pRhcosAmiId:
    Description: Current Red Hat Enterprise Linux CoreOS AMI to use for bootstrap.
    Type: AWS::EC2::Image::Id
  pAllowedBootstrapSshCidr:
    Description: CIDR block to allow SSH access to the bootstrap node.
    Type: String
  pVpcId:
    Description: The VPC-scoped resources will belong to this VPC.
    Type: AWS::EC2::VPC::Id
  pBootstrapIgnitionLocation:
    Description: Ignition config file location.
    Type: String
  pAutoRegisterELB:
    AllowedValues:
      - "yes"
      - "no"
    Description: Do you want to invoke NLB registration, which requires a Lambda ARN parameter?
    Type: String
  pBootstrapInstanceType:
    Description: Instance type for the bootstrap EC2 instance
    Type: String
  pHostedZoneId:
    Description: The Route53 public zone ID to register the targets with, such as Z21IXYZABCZ2A4.
    Type: String
  pControlPlaneSecurityGroupId:
    Type: String
Metadata:
  AWS::CloudFormation::Interface:
    ParameterGroups:
      - Label:
          default: "Cluster Information"
        Parameters:
          - pInfrastructureName
      - Label:
          default: "Host Information"
        Parameters:
          - pRhcosAmiId
          - pBootstrapIgnitionLocation
          - pControlPlaneSecurityGroupId
      - Label:
          default: "Network Configuration"
        Parameters:
          - pVpcId
          - pAllowedBootstrapSshCidr
      - Label:
          default: "Load Balancer Automation"
        Parameters:
          - pAutoRegisterELB
          - pRegisterNlbIpTargetsLambdsamplern
          - pInternalApiTargetGroupArn
          - pInternalServiceTargetGroupArn
    ParameterLabels:
      pInfrastructureName:
        default: "Infrastructure Name"
      pVpcId:
        default: "VPC ID"
      pAllowedBootstrapSshCidr:
        default: "Allowed SSH Source"
      pRhcosAmiId:
        default: "Red Hat Enterprise Linux CoreOS AMI ID"
      pBootstrapIgnitionLocation:
        default: "Bootstrap Ignition Source"
      pControlPlaneSecurityGroupId:
        default: "ControlPlane Security Group ID"
      pAutoRegisterELB:
        default: "Use Provided ELB Automation"
Conditions:
  DoRegistration: !Equals ["yes", !Ref pAutoRegisterELB]
Resources:
  BootstrapIamRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: "Allow"
            Principal:
              Service:
                - "ec2.amazonaws.com"
            Action:
              - "sts:AssumeRole"
      Path: "/"
      Policies:
        - PolicyName:
            !Join ["-", [!Ref pInfrastructureName, "bootstrap", "policy"]]
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: "Allow"
                Action: "ec2:Describe*"
                Resource: "*"
              - Effect: "Allow"
                Action: "ec2:AttachVolume"
                Resource: "*"
              - Effect: "Allow"
                Action: "ec2:DetachVolume"
                Resource: "*"
              - Effect: "Allow"
                Action: "s3:GetObject"
                Resource: "*"
  BootstrapInstanceProfile:
    Type: AWS::IAM::InstanceProfile
    Properties:
      Path: "/"
      Roles:
        - Ref: "BootstrapIamRole"
  BootstrapSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Cluster Bootstrap Security Group
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          SourcePrefixListId: !Ref pAllowedBootstrapSshCidr
        - IpProtocol: tcp
          ToPort: 19531
          FromPort: 19531
          SourcePrefixListId: !Ref pAllowedBootstrapSshCidr
      VpcId: !Ref pVpcId
  KubernetesLaunchTemplate:
    Type: AWS::EC2::LaunchTemplate
    Properties:
      LaunchTemplateName: !Sub bootstrap-${pDeploymentNumber}-${pEnvironment}-${pKubernetesType}-launch-template
      LaunchTemplateData:
        KeyName: !Sub "{{resolve:ssm:/sample/ec2/sample-deployment-${pDeploymentNumber}/ec2/default-key/name}}"
        ImageId: !Ref pRhcosAmiId
        IamInstanceProfile:
          Name: !Ref BootstrapInstanceProfile
        InstanceType: !Ref pBootstrapInstanceType
        NetworkInterfaces:
          - AssociatePublicIpAddress: "false"
            DeviceIndex: "0"
            Groups:
              - !Ref "BootstrapSecurityGroup"
              - !Ref pControlPlaneSecurityGroupId
            SubnetId: !Sub "{{resolve:ssm:/sample/vpc/sample-${pEnvironment}-${pSampleEnv}-vpc/sample-deployment-${pDeploymentNumber}-subnet-0/id}}"
        UserData:
          Fn::Base64: !Sub
            - '{"ignition":{"config":{"replace":{"source":"${S3Loc}"}},"version":"3.1.0"}}'
            - { S3Loc: !Ref pBootstrapIgnitionLocation }
        TagSpecifications:
          - ResourceType: instance
            Tags:
              - Key: "deploymentType"
                Value: sampleDeployment
              - Key: "deploymentEnvironment"
                Value: !Ref pEnvironment
              - Key: "sampleDeploymentNumber"
                Value: !Ref pDeploymentNumber
              - Key: "systemGroup"
                Value: "RCHOS"
              - Key: "kubernetesPlatform"
                Value: !Ref pKubernetesType
              - Key: "version"
                Value: "1"
  BootstrapInstance:
    Type: AWS::EC2::Instance
    Properties:
      LaunchTemplate:
        LaunchTemplateId: !Ref KubernetesLaunchTemplate
        Version: !GetAtt KubernetesLaunchTemplate.LatestVersionNumber
      Tags:
        - Key: Name
          Value: !Sub "edge-bootstrap.${pDeploymentNumber}.${pKubernetesType}.${pEnvironment}.${pDomain}.dev"
  RegisterBootstrapInternalApiTarget:
    Condition: DoRegistration
    Type: Custom::NLBRegister
    Properties:
      ServiceTimeout: 300
      ServiceToken: !Sub "{{resolve:ssm:/sample/lambda/${pDeploymentNumber}-${pEnvironment}/${pKubernetesType}/registernlbiptargetslambda/arn}}"
      TargetArn: !Sub "{{resolve:ssm:/sample/elb/${pDeploymentNumber}-${pEnvironment}/${pKubernetesType}/internalapitargetgroup/arn}}"
      TargetIp: !GetAtt BootstrapInstance.PrivateIp
  RegisterBootstrapInternalServiceTarget:
    Condition: DoRegistration
    Type: Custom::NLBRegister
    Properties:
      ServiceTimeout: 300
      ServiceToken: !Sub "{{resolve:ssm:/sample/lambda/${pDeploymentNumber}-${pEnvironment}/${pKubernetesType}/registernlbiptargetslambda/arn}}"
      TargetArn: !Sub "{{resolve:ssm:/sample/elb/${pDeploymentNumber}-${pEnvironment}/${pKubernetesType}/internalservicetargetgroup/arn}}"
      TargetIp: !GetAtt BootstrapInstance.PrivateIp
  BootstrapEC2HostRoute53Record:
    Type: AWS::Route53::RecordSet
    Properties:
      HostedZoneId: !Ref pHostedZoneId
      Name: !Sub "edge-bootstrap.${pDeploymentNumber}.${pKubernetesType}.${pEnvironment}.${pDomain}.dev"
      ResourceRecords:
        - !GetAtt BootstrapInstance.PrivateIp
      TTL: 900
      Type: A
  BootstrapInstanceIdParameter:
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub "/sample/ec2/${pDeploymentNumber}-${pEnvironment}/${pKubernetesType}/bootstrap/instanceid"
      Type: String
      Value: !Ref BootstrapInstance
      Description: SSM Parameter for BootstrapInstanceId
  BootstrapPrivateIpParameter:
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub "/sample/ec2/${pDeploymentNumber}-${pEnvironment}/${pKubernetesType}/bootstrap/privateip"
      Type: String
      Value: !GetAtt BootstrapInstance.PrivateIp
      Description: SSM Parameter for BootstrapPrivateIp
