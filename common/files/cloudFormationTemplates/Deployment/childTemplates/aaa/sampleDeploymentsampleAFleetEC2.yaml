AWSTemplateFormatVersion: 2010-09-09
Parameters:
  pSAMPLEEnv:
    Type: String
    Description: Production? Test?
    AllowedValues:
      - prod
      - test
  pDeploymentNumber:
    ConstraintDescription: "The number of the deployment."
    MinValue: 0
    MaxValue: 20
    Description: "The number of the deployment."
    Type: Number
  pEnvironment:
    Type: String
    Description: Development? Test Upstream? Prod Upstream?
    AllowedValues:
      - dev
      - upprod
      - uptest
  pLaunchTemplateId:
    Type: String
  pLaunchTemplateVer:
    Type: String
  pInstanceAmount:
    Type: Number
Resources:
  sampleaFleet:
    Type: AWS::EC2::EC2Fleet
    Properties:
      LaunchTemplateConfigs:
        - LaunchTemplateSpecification:
            Version: !Ref pLaunchTemplateVer
            LaunchTemplateId: !Ref pLaunchTemplateId
          Overrides:
            - SubnetId: !Sub "{{resolve:ssm:/sample/vpc/sample-${pEnvironment}-${pSAMPLEEnv}-vpc/sample-deployment-${pDeploymentNumber}-subnet-0/id}}"
      TargetCapacitySpecification:
        DefaultTargetCapacityType: "on-demand"
        TotalTargetCapacity: !Ref pInstanceAmount
      Type: "instant"
      OnDemandOptions:
        SingleAvailabilityZone: "true"
        SingleInstanceType: "true"
      TagSpecifications:
        - ResourceType: instance
          Tags:
            - Key: Name
              Value: !Sub "samplea-fleet.deployment-${pDeploymentNumber}"
        - ResourceType: fleet
          Tags:
            - Key: Name
              Value: !Sub "samplea-fleet.deployment-${pDeploymentNumber}"
            - Key: "deploymentType"
              Value: sampleDeployment
            - Key: "sampleDeploymentNumber"
              Value: !Ref pDeploymentNumber