AWSTemplateFormatVersion: 2010-09-09
Parameters:
  pSampleEnv:
    Type: String
    Description: Production? Test?
    AllowedValues:
      - prod
      - test
  pDevCidr0:
    Type: String
    Default: 192.168.1.0/32
  pDevCidr1:
    Type: String
    Default: 192.168.1.1/32
  pDevCidr2:
    Type: String
    Default: 192.168.1.2/32
  pDevCidr3:
    Type: String
    Default: 192.168.1.3/32
  pUpprodPeeringID:
    Type: String
    Default: "null"
  pUptestPeeringID:
    Type: String
    Default: "null"
  pSubnetCIDR0:
    Type: String
  pSubnetCIDR1:
    Type: String
  pEnvironment:
    Type: String
    Description: Development? Test Upstream? Prod Upstream?
    AllowedValues:
      - dev
      - upprod
      - uptest
  pEc2DailyStop:
    Type: String
    Description: Do you want the EC2 resources to stop automatically Monday-Friday at 10PM EST, 7PM PST?
    AllowedValues:
      - "true"
      - "false"
  pEc2DailyStart:
    Type: String
    Description: Do you want the EC2 resources to stop automatically Monday-Friday at 4AM EST, 1AM PST?
    AllowedValues:
      - "true"
      - "false"
  pDomain:
    Description: The domain the environment is within (ex. sample.sample.dev or sample.sample.dev).
    Type: String
    AllowedValues:
      - sample
      - sample
  pDeploymentNumber:
    Description: The number of the deployment.
    Type: Number
  pBootstrapInstanceType:
    Description: Instance type for the bootstrap EC2 instance
    Type: String
  pControlPlaneInstanceTypeRKE:
    Type: String
  pControlPlaneInstanceTypeOCP:
    Type: String
  pControlPlaneInstanceTypeKUBERNETES:
    Type: String
  pControlPlaneInstanceTypeARMKUBERNETES:
    Type: String
  pWorkerInstanceTypeRKE:
    Type: String
  pWorkerInstanceTypeOCP:
    Type: String
  pWorkerInstanceTypeKUBERNETES:
    Type: String
  pWorkerInstanceTypeARMKUBERNETES:
    Type: String
  pUPInstanceType:
    Description: EC2 instance type for UP instances.
    Type: String
    AllowedValues:
      - c4.xlarge
      - c4.2xlarge
      - c4.4xlarge
      - c5.large
      - c5.xlarge
      - c5.2xlarge
      - c5.4xlarge
      - c5n.large
      - c5n.xlarge
      - c5n.2xlarge
      - c5n.4xlarge
      - c6i.large
      - c6i.xlarge
      - c6in.2xlarge
      - c6in.4xlarge
      - m4.large
      - m4.xlarge
      - m4.2xlarge
      - m4.4xlarge
      - m5.large
      - m5.xlarge
      - m5.2xlarge
      - m5.4xlarge
      - m5n.large
      - m5n.xlarge
      - m5n.2xlarge
      - m5n.4xlarge
      - m6i.xlarge
      - r4.large
      - r4.xlarge
      - r5.large
      - r5.xlarge
      - r6i.xlarge
      - r6i.2xlarge
      - r6i.4xlarge
      - r6i.8xlarge
      - r6i.12xlarge
      - r6in.xlarge
      - r6in.2xlarge
      - r6in.4xlarge
      - r6in.8xlarge
      - r6in.12xlarge
      - r7i.large
      - r7i.xlarge
      - t2.small (Testing / Not for Production Use)
      - t2.medium
      - t2.large
      - t3.small (Testing / Not for Production Use)
      - t3.medium
      - t3.large
      - t3.xlarge
      - t3.2xlarge
      - t3a.medium
    ConstraintDescription: Please choose a valid EC2 instance type
  pDOWNInstanceType:
    Description: EC2 instance type for UP instances.
    Type: String
    AllowedValues:
      - c4.xlarge
      - c4.2xlarge
      - c4.4xlarge
      - c5.large
      - c5.xlarge
      - c5.2xlarge
      - c5.4xlarge
      - c5n.large
      - c5n.xlarge
      - c5n.2xlarge
      - c5n.4xlarge
      - c6i.large
      - c6i.xlarge
      - c6in.2xlarge
      - c6in.4xlarge
      - m4.large
      - m4.xlarge
      - m4.2xlarge
      - m4.4xlarge
      - m5.large
      - m5.xlarge
      - m5.2xlarge
      - m5.4xlarge
      - m5n.large
      - m5n.xlarge
      - m5n.2xlarge
      - m5n.4xlarge
      - m6i.xlarge
      - r4.large
      - r4.xlarge
      - r5.large
      - r5.xlarge
      - r6i.xlarge
      - r6i.2xlarge
      - r6i.4xlarge
      - r6i.8xlarge
      - r6i.12xlarge
      - r6in.xlarge
      - r6in.2xlarge
      - r6in.4xlarge
      - r6in.8xlarge
      - r6in.12xlarge
      - r7i.large
      - r7i.xlarge
      - t2.small (Testing / Not for Production Use)
      - t2.medium
      - t2.large
      - t3.small (Testing / Not for Production Use)
      - t3.medium
      - t3.large
      - t3.xlarge
      - t3.2xlarge
      - t3a.medium
    ConstraintDescription: Please choose a valid EC2 instance type
  pEdgeInstanceType:
    Description: EC2 instance type for UP instances.
    Type: String
    AllowedValues:
      - c4.xlarge
      - c4.2xlarge
      - c4.4xlarge
      - c5.large
      - c5.xlarge
      - c5.2xlarge
      - c5.4xlarge
      - c5n.large
      - c5n.xlarge
      - c5n.2xlarge
      - c5n.4xlarge
      - c6i.large
      - c6i.xlarge
      - c6in.2xlarge
      - c6in.4xlarge
      - m4.large
      - m4.xlarge
      - m4.2xlarge
      - m4.4xlarge
      - m5.large
      - m5.xlarge
      - m5.2xlarge
      - m5.4xlarge
      - m5n.large
      - m5n.xlarge
      - m5n.2xlarge
      - m5n.4xlarge
      - m6i.xlarge
      - r4.large
      - r4.xlarge
      - r5.large
      - r5.xlarge
      - r6i.xlarge
      - r6i.2xlarge
      - r6i.4xlarge
      - r6i.8xlarge
      - r6i.12xlarge
      - r6in.xlarge
      - r6in.2xlarge
      - r6in.4xlarge
      - r6in.8xlarge
      - r6in.12xlarge
      - r7i.large
      - r7i.xlarge
      - t2.small (Testing / Not for Production Use)
      - t2.medium
      - t2.large
      - t3.small (Testing / Not for Production Use)
      - t3.medium
      - t3.large
      - t3.xlarge
      - t3.2xlarge
      - t3a.medium
    ConstraintDescription: Please choose a valid EC2 instance type
  pFleetInstanceType:
    Description: EC2 instance type for Fleet instances.
    Type: String
    AllowedValues:
      - c4.xlarge
      - c4.2xlarge
      - c4.4xlarge
      - c5.large
      - c5.xlarge
      - c5.2xlarge
      - c5.4xlarge
      - c5n.large
      - c5n.xlarge
      - c5n.2xlarge
      - c5n.4xlarge
      - c6i.large
      - c6i.xlarge
      - c6in.2xlarge
      - c6in.4xlarge
      - m4.large
      - m4.xlarge
      - m4.2xlarge
      - m4.4xlarge
      - m5.large
      - m5.xlarge
      - m5.2xlarge
      - m5.4xlarge
      - m5n.large
      - m5n.xlarge
      - m5n.2xlarge
      - m5n.4xlarge
      - m6i.xlarge
      - r4.large
      - r4.xlarge
      - r5.large
      - r5.xlarge
      - r6i.xlarge
      - r6i.2xlarge
      - r6i.4xlarge
      - r6i.8xlarge
      - r6i.12xlarge
      - r6in.xlarge
      - r6in.2xlarge
      - r6in.4xlarge
      - r6in.8xlarge
      - r6in.12xlarge
      - r7i.large
      - r7i.xlarge
      - t2.small (Testing / Not for Production Use)
      - t2.medium
      - t2.large
      - t3.small (Testing / Not for Production Use)
      - t3.medium
      - t3.large
      - t3.xlarge
      - t3.2xlarge
      - t3a.medium
    ConstraintDescription: Please choose a valid EC2 instance type
  pDeployEdgeResources:
    Type: String
    Description: Deploy Edge resources?
    AllowedValues:
    - "true"
    - "false"
  pDeployKUBERNETESResources:
    Type: String
    Description: Deploy KUBERNETES resources?
    AllowedValues:
    - "true"
    - "false"
  pDeployARMKUBERNETESResources:
    Type: String
    Description: Deploy ARM KUBERNETES resources?
    AllowedValues:
    - "true"
    - "false"
  pDeploysampleAFleetResources:
    Type: String
    Description: Deploy Fleet resources?
    AllowedValues:
    - "true"
    - "false"
  psampleAFleetInstanceAmount:
    Type: Number
    Default: "0"
  pEdgeClusterContainerPlatform:
    Type: String
    Description: What type of container hosting platform is being deployed on the Edge?
    AllowedValues:
    - "RKE"
    - "Neither"
  pDeployUPResources:
    Type: String
    Description: Deploy UP resources?
    AllowedValues:
    - "true"
    - "false"
  pDeployDOWNResources:
    Type: String
    Description: Deploy DOWN resources?
    AllowedValues:
    - "true"
    - "false"
Metadata:
  AWS::CloudFormation::Interface:
    ParameterGroups:
    - Label:
        default: "Environment Information"
      Parameters:
      - pSampleEnv
      - pDeploymentNumber
    - Label:
        default: "Deployment Information"
      Parameters:
      - pDeployEdgeResources
      - pEdgeClusterContainerPlatform
      - pDeployUPResources
      - pDeployDOWNResources
      - pDeployKUBERNETESResources
    - Label:
        default: "Cluster Information"
      Parameters:
      - pEnvironment
      - pDomain
      - pInfrastructureName
      - pBootstrapInstanceType
      - pControlPlaneInstanceType
      - pWorkerInstanceType
    - Label:
        default: "RKE Host Information"
    - Label:
        default: "Edge/UP/DOWN/KUBERNETES Host Information"
      Parameters:
      - pUPInstanceType
      - pDOWNInstanceType
      - pEdgeInstanceType
      - pEc2DailyStart
      - pEc2DailyStop
    ParameterLabels:
      pEc2DailyStart:
        default: "EC2 Daily Start Setting"
      pEc2DailyStop:
        default: "EC2 Daily Stop Setting"
      pSampleEnv:
        default: "sample Environment"
      pInfrastructureName:
        default: "Infrastructure Name"
      pEnvironment:
        default: "Deployment Environment"
      pDomain:
        default: "Deployment Domain"
      pDeploymentNumber:
        default: "Deployment Number"
      pControlPlaneInstanceType:
        default: "ControlPlane Instance Type"
      pWorkerInstanceType:
        default:  "Worker Instance Type"
      pBootstrapInstanceType:
        default:  "Bootstrap Instance Type"
      pUPInstanceType:
        default:  "UP Instance Type"
      pDOWNInstanceType:
        default:  "DOWN Instance Type"
      pEdgeInstanceType:
        default:  "Edge Instance Type"
      pEdgeClusterContainerPlatform:
        default: "Edge Container Platform"
      pDeployEdgeResources:
        default:  "Deploy Edge Resources"
      pDeployDOWNResources:
        default:  "Deploy DOWN Resources"
      pDeployUPResources:
        default:  "Deploy UP Resources"
      pDeployKUBERNETESResources:
        default:  "Deploy KUBERNETES Resources"
Conditions:
  DeployEdgeResources: !Equals
    - !Ref pDeployEdgeResources
    - "true"
  SelectRKEResources: !Equals
    - !Ref pEdgeClusterContainerPlatform
    - "RKE"
  DeployRKE: !And
    - !Condition SelectRKEResources
    - !Condition DeployEdgeResources
  DeployUPResources: !Equals
    - !Ref pDeployUPResources
    - "true"
  DeployDOWNResources: !Equals
    - !Ref pDeployDOWNResources
    - "true"
  DeployKUBERNETESResources: !Equals
    - !Ref pDeployKUBERNETESResources
    - "true"
  DeployARMKUBERNETESResources: !Equals
    - !Ref pDeployARMKUBERNETESResources
    - "true"
  DeploysampleAFleetResources: !Equals
    - !Ref pDeploysampleAFleetResources
    - "true"
Resources:
### EC2 Default Resources ###
  sampleDeploymentEC2Defaults:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: !Sub https://sample-${pSampleEnv}-${pEnvironment}-cloud-formation-templates.s3.us-gov-west-1.amazonaws.com/sampleDeployment/childTemplates/sampleDeploymentEC2Defaults.yaml
      Parameters:
        pAMIId: !Sub "{{resolve:ssm:/sample/ec2/ami/RHEL/baseline/ami/0.0.7/id}}"
        pEnvironment: !Ref pEnvironment
        pDeploymentNumber: !Ref pDeploymentNumber
        pVpcId: !Sub "{{resolve:ssm:/sample/vpc/sample-${pEnvironment}-${pSampleEnv}-vpc/id}}"
        pVpcPrefix: !Sub "{{resolve:ssm:/sample/vpc/cidr/prefix}}"
        pFleetInstanceType: !Ref pFleetInstanceType
  sampleDeploymentLambdaDefaults:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: !Sub https://sample-${pSampleEnv}-${pEnvironment}-cloud-formation-templates.s3.us-gov-west-1.amazonaws.com/sampleDeployment/childTemplates/sampleDeploymentLambdaDefaults.yaml
      Parameters:
        pEnvironment: !Ref pEnvironment
        pDeploymentNumber: !Ref pDeploymentNumber
        pKeyId: !GetAtt sampleDeploymentEC2Defaults.Outputs.ec2DefaultKeyOutput
### Base Resources ###
  sampleDeploymentNetwork:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: !Sub https://sample-${pSampleEnv}-${pEnvironment}-cloud-formation-templates.s3.us-gov-west-1.amazonaws.com/sampleDeployment/childTemplates/sampleDeploymentNetwork.yaml
      Parameters:
        pSubnetCidr0: !Ref pSubnetCIDR0
        pSubnetCidr1: !Ref pSubnetCIDR1
        pEnvironment: !Ref pEnvironment
        pDomain: !Ref pDomain
        pDeploymentNumber: !Ref pDeploymentNumber
        pVpcId: !Sub "{{resolve:ssm:/sample/vpc/sample-${pEnvironment}-${pSampleEnv}-vpc/id}}"
        pSampleEnv: !Ref pSampleEnv
        pDevCidr0: !Ref pDevCidr0
        pDevCidr1: !Ref pDevCidr1
        pDevCidr2: !Ref pDevCidr2
        pDevCidr3: !Ref pDevCidr3
        pUpprodPeeringID: !Ref pUpprodPeeringID
        pUptestPeeringID: !Ref pUptestPeeringID
### Edge Resources ###
  sampleDeploymentEdgeEC2:
    Condition: DeployEdgeResources
    DependsOn:
    - sampleDeploymentNetwork
    - sampleDeploymentEC2Defaults
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: !Sub https://sample-${pSampleEnv}-${pEnvironment}-cloud-formation-templates.s3.us-gov-west-1.amazonaws.com/sampleDeployment/childTemplates/edge/sampleDeploymentEdgeEC2.yaml
      Parameters:
        pHostedZoneId: !Sub "{{resolve:ssm:/sample/route53/${pEnvironment}-${pDomain}-dev/id}}"
        pEc2DailyStop: !Ref pEc2DailyStop
        pEc2DailyStart: !Ref pEc2DailyStart
        pEnvironment: !Ref pEnvironment
        pEdgeInstanceType: !Ref pEdgeInstanceType
        pDomain: !Ref pDomain
        pDeploymentNumber: !Ref pDeploymentNumber
        pVpcPrefix: !Sub "{{resolve:ssm:/sample/vpc/cidr/prefix}}"
        pCentralServicesSubnetPrefix: !Sub "{{resolve:ssm:/sample/vpc/central-services/subnet/cidr/prefix}}"
        pVpcId: !Sub "{{resolve:ssm:/sample/vpc/sample-${pEnvironment}-${pSampleEnv}-vpc/id}}"
        pSampleEnv: !Ref pSampleEnv
        pLaunchTemplateId: !GetAtt sampleDeploymentEC2Defaults.Outputs.ec2DefaultLinuxLaunchTemplateIdOutput
        pLaunchTemplateVer: !GetAtt sampleDeploymentEC2Defaults.Outputs.ec2DefaultLinuxLaunchTemplateVerOutput
### RKE Resources ###
  sampleDeploymentRKESecurity:
    Type: AWS::CloudFormation::Stack
    DependsOn: sampleDeploymentNetwork
    Condition: DeployRKE
    Properties:
      TemplateURL: !Sub https://sample-${pSampleEnv}-${pEnvironment}-cloud-formation-templates.s3.us-gov-west-1.amazonaws.com/sampleDeployment/childTemplates/rke/sampleDeploymentRKESecurity.yaml
      Parameters:
        pInfrastructureName: !Sub ${pEnvironment}${pDeploymentNumber}
        pVpcPrefix: !Sub "{{resolve:ssm:/sample/vpc/cidr/prefix}}"
        pCentralServicesSubnetPrefix: !Sub "{{resolve:ssm:/sample/vpc/central-services/subnet/cidr/prefix}}"
        pVpcId: !Sub "{{resolve:ssm:/sample/vpc/sample-${pEnvironment}-${pSampleEnv}-vpc/id}}"
        pEnvironment: !Ref pEnvironment
        pDeploymentNumber: !Ref pDeploymentNumber
        pDomain: !Ref pDomain
        pKubernetesType: "rke"
        pSampleEnv: !Ref pSampleEnv
  sampleDeploymentRKEEFS:
    Type: AWS::CloudFormation::Stack
    DependsOn: sampleDeploymentRKESecurity
    Condition: DeployRKE
    Properties:
      TemplateURL: !Sub https://sample-${pSampleEnv}-${pEnvironment}-cloud-formation-templates.s3.us-gov-west-1.amazonaws.com/sampleDeployment/childTemplates/rke/sampleDeploymentRKEEFS.yaml
      Parameters:
        pVpcId: !Sub "{{resolve:ssm:/sample/vpc/sample-${pEnvironment}-${pSampleEnv}-vpc/id}}"
        pSampleEnv: !Ref pSampleEnv
        pEnvironment: !Ref pEnvironment
        pDeploymentNumber: !Ref pDeploymentNumber
        pKubernetesType: "rke"
        pVpcPrefix: !Sub "{{resolve:ssm:/sample/vpc/cidr/prefix}}"
  sampleDeploymentRKEDNSELB:
    Type: AWS::CloudFormation::Stack
    DependsOn: sampleDeploymentRKESecurity
    Condition: DeployRKE
    Properties:
      TemplateURL: !Sub https://sample-${pSampleEnv}-${pEnvironment}-cloud-formation-templates.s3.us-gov-west-1.amazonaws.com/sampleDeployment/childTemplates/rke/sampleDeploymentRKEDNSELB.yaml
      Parameters:
        pSampleEnv: !Ref pSampleEnv
        pClusterName: !Sub ${pDeploymentNumber}.${pEnvironment}
        pDeploymentNumber: !Ref pDeploymentNumber
        pInfrastructureName: !Sub ${pEnvironment}${pDeploymentNumber}
        pHostedZoneId: !Sub "{{resolve:ssm:/sample/route53/${pEnvironment}-dev/id}}"
        pHostedZoneName: !Sub ${pEnvironment}.${pDomain}.sample.dev
        pVpcId: !Sub "{{resolve:ssm:/sample/vpc/sample-${pEnvironment}-${pSampleEnv}-vpc/id}}"
        pKubernetesType: "rke"
        pEnvironment: !Ref pEnvironment
        pDomain: !Ref pDomain
        pELBSecurityGroupGroupId: !GetAtt sampleDeploymentRKESecurity.Outputs.ELBSecurityGroupGroupId
  sampleDeploymentRKEEC2ControlPlane:
    Type: AWS::CloudFormation::Stack
    DependsOn:
    - sampleDeploymentRKEDNSELB
    - sampleDeploymentEC2Defaults
    Condition: DeployRKE
    Properties:
      TemplateURL: !Sub https://sample-${pSampleEnv}-${pEnvironment}-cloud-formation-templates.s3.us-gov-west-1.amazonaws.com/sampleDeployment/childTemplates/rke/sampleDeploymentRKEEC2ControlPlane.yaml
      Parameters:
        pEc2DailyStop: !Ref pEc2DailyStop
        pEc2DailyStart: !Ref pEc2DailyStart
        pEnvironment: !Ref pEnvironment
        pDeploymentNumber: !Ref pDeploymentNumber
        pDomain: !Ref pDomain
        pInfrastructureName: !Sub ${pEnvironment}${pDeploymentNumber}
        pHostedZoneId: !Sub "{{resolve:ssm:/sample/route53/${pEnvironment}-dev/id}}"
        pControlPlaneInstanceType: !Ref pControlPlaneInstanceTypeRKE
        pKubernetesType: "rke"
        pAMIId: !Sub "{{resolve:ssm:/sample/ec2/ami/RHEL9/baseline/ami/0.0.7/id}}"
        pAutoRegisterELB: "yes"
        pSampleEnv: !Ref pSampleEnv
        pControlPlaneSecurityGroupId: !GetAtt sampleDeploymentRKESecurity.Outputs.ControlPlaneSecurityGroupId
        pControlPlaneInstanceProfileId: !GetAtt sampleDeploymentRKESecurity.Outputs.ControlPlaneInstanceProfileId
  sampleDeploymentRKEEC2Worker:
    Type: AWS::CloudFormation::Stack
    Condition: DeployRKE
    DependsOn: sampleDeploymentRKEEC2ControlPlane
    Properties:
      TemplateURL: !Sub https://sample-${pSampleEnv}-${pEnvironment}-cloud-formation-templates.s3.us-gov-west-1.amazonaws.com/sampleDeployment/childTemplates/rke/sampleDeploymentRKEEC2Worker.yaml
      Parameters:
        pEc2DailyStop: !Ref pEc2DailyStop
        pEc2DailyStart: !Ref pEc2DailyStart
        pEnvironment: !Ref pEnvironment
        pDeploymentNumber: !Ref pDeploymentNumber
        pDomain: !Ref pDomain
        pInfrastructureName: !Sub ${pEnvironment}${pDeploymentNumber}
        pHostedZoneId: !Sub "{{resolve:ssm:/sample/route53/${pEnvironment}-dev/id}}"
        pWorkerInstanceType: !Ref pWorkerInstanceTypeRKE
        pKubernetesType: "rke"
        pAMIId: !Sub "{{resolve:ssm:/sample/ec2/ami/RHEL9/baseline/ami/0.0.7/id}}"
        pSampleEnv: !Ref pSampleEnv
        pWorkerSecurityGroupId: !GetAtt sampleDeploymentRKESecurity.Outputs.WorkerSecurityGroupId
        pWorkerInstanceProfileId: !GetAtt sampleDeploymentRKESecurity.Outputs.WorkerInstanceProfileId
### UP Resources ###
  sampleDeploymentUPEC2:
    Type: AWS::CloudFormation::Stack
    DependsOn:
    - sampleDeploymentNetwork
    - sampleDeploymentEC2Defaults
    Condition: DeployUPResources
    Properties:
      TemplateURL: !Sub https://sample-${pSampleEnv}-${pEnvironment}-cloud-formation-templates.s3.us-gov-west-1.amazonaws.com/sampleDeployment/childTemplates/upstream/sampleDeploymentUPEC2.yaml
      Parameters:
        pHostedZoneId: !Sub "{{resolve:ssm:/sample/route53/${pEnvironment}-${pDomain}-dev/id}}"
        pEc2DailyStop: !Ref pEc2DailyStop
        pEc2DailyStart: !Ref pEc2DailyStart
        pEnvironment: !Ref pEnvironment
        pUPInstanceType: !Ref pUPInstanceType
        pDomain: !Ref pDomain
        pDeploymentNumber: !Ref pDeploymentNumber
        pVpcPrefix: !Sub "{{resolve:ssm:/sample/vpc/cidr/prefix}}"
        pCentralServicesSubnetPrefix: !Sub "{{resolve:ssm:/sample/vpc/central-services/subnet/cidr/prefix}}"
        pVpcId: !Sub "{{resolve:ssm:/sample/vpc/sample-${pEnvironment}-${pSampleEnv}-vpc/id}}"
        pSampleEnv: !Ref pSampleEnv
        pLaunchTemplateId: !GetAtt sampleDeploymentEC2Defaults.Outputs.ec2DefaultLinuxLaunchTemplateIdOutput
        pLaunchTemplateVer: !GetAtt sampleDeploymentEC2Defaults.Outputs.ec2DefaultLinuxLaunchTemplateVerOutput
### DOWN Resources ###
  sampleDeploymentDOWNEC2:
    Type: AWS::CloudFormation::Stack
    DependsOn:
    - sampleDeploymentNetwork
    - sampleDeploymentEC2Defaults
    Condition: DeployDOWNResources
    Properties:
      TemplateURL: !Sub https://sample-${pSampleEnv}-${pEnvironment}-cloud-formation-templates.s3.us-gov-west-1.amazonaws.com/sampleDeployment/childTemplates/downstream/sampleDeploymentDOWNEC2.yaml
      Parameters:
        pHostedZoneId: !Sub "{{resolve:ssm:/sample/route53/${pEnvironment}-${pDomain}-dev/id}}"
        pEc2DailyStop: !Ref pEc2DailyStop
        pEc2DailyStart: !Ref pEc2DailyStart
        pEnvironment: !Ref pEnvironment
        pDOWNInstanceType: !Ref pDOWNInstanceType
        pDomain: !Ref pDomain
        pDeploymentNumber: !Ref pDeploymentNumber
        pVpcId: !Sub "{{resolve:ssm:/sample/vpc/sample-${pEnvironment}-${pSampleEnv}-vpc/id}}"
        pVpcPrefix: !Sub "{{resolve:ssm:/sample/vpc/cidr/prefix}}"
        pCentralServicesSubnetPrefix: !Sub "{{resolve:ssm:/sample/vpc/central-services/subnet/cidr/prefix}}"
        pSampleEnv: !Ref pSampleEnv
        pLaunchTemplateId: !GetAtt sampleDeploymentEC2Defaults.Outputs.ec2DefaultLinuxLaunchTemplateIdOutput
        pLaunchTemplateVer: !GetAtt sampleDeploymentEC2Defaults.Outputs.ec2DefaultLinuxLaunchTemplateVerOutput
### KUBERNETES Resources ###
  sampleDeploymentKUBERNETESSecurity:
    Type: AWS::CloudFormation::Stack
    DependsOn: sampleDeploymentNetwork
    Condition: DeployKUBERNETESResources
    Properties:
      TemplateURL: !Sub https://sample-${pSampleEnv}-${pEnvironment}-cloud-formation-templates.s3.us-gov-west-1.amazonaws.com/sampleDeployment/childTemplates/kubernetes/sampleDeploymentKUBERNETESSecurity.yaml
      Parameters:
        pInfrastructureName: !Sub ${pEnvironment}${pDeploymentNumber}
        pVpcId: !Sub "{{resolve:ssm:/sample/vpc/sample-${pEnvironment}-${pSampleEnv}-vpc/id}}"
        pVpcPrefix: !Sub "{{resolve:ssm:/sample/vpc/cidr/prefix}}"
        pCentralServicesSubnetPrefix: !Sub "{{resolve:ssm:/sample/vpc/central-services/subnet/cidr/prefix}}"
        pEnvironment: !Ref pEnvironment
        pDeploymentNumber: !Ref pDeploymentNumber
        pDomain: !Ref pDomain
        pKubernetesType: "kubernetes"
        pSampleEnv: !Ref pSampleEnv
  sampleDeploymentKUBERNETESEEFS:
    Type: AWS::CloudFormation::Stack
    DependsOn: sampleDeploymentKUBERNETESSecurity
    Condition: DeployKUBERNETESResources
    Properties:
      TemplateURL: !Sub https://sample-${pSampleEnv}-${pEnvironment}-cloud-formation-templates.s3.us-gov-west-1.amazonaws.com/sampleDeployment/childTemplates/kubernetes/sampleDeploymentKUBERNETESEFS.yaml
      Parameters:
        pVpcId: !Sub "{{resolve:ssm:/sample/vpc/sample-${pEnvironment}-${pSampleEnv}-vpc/id}}"
        pSampleEnv: !Ref pSampleEnv
        pEnvironment: !Ref pEnvironment
        pDeploymentNumber: !Ref pDeploymentNumber
        pKubernetesType: "kubernetes"
        pVpcPrefix: !Sub "{{resolve:ssm:/sample/vpc/cidr/prefix}}"
  sampleDeploymentKUBERNETESDNSELB:
    Type: AWS::CloudFormation::Stack
    DependsOn: sampleDeploymentKUBERNETESSecurity
    Condition: DeployKUBERNETESResources
    Properties:
      TemplateURL: !Sub https://sample-${pSampleEnv}-${pEnvironment}-cloud-formation-templates.s3.us-gov-west-1.amazonaws.com/sampleDeployment/childTemplates/kubernetes/sampleDeploymentKUBERNETESDNSELB.yaml
      Parameters:
        pSampleEnv: !Ref pSampleEnv
        pClusterName: !Sub ${pDeploymentNumber}.${pEnvironment}
        pDeploymentNumber: !Ref pDeploymentNumber
        pInfrastructureName: !Sub ${pEnvironment}${pDeploymentNumber}
        pHostedZoneId: !Sub "{{resolve:ssm:/sample/route53/${pEnvironment}-dev/id}}"
        pHostedZoneName: !Sub ${pEnvironment}.${pDomain}.sample.dev
        pVpcId: !Sub "{{resolve:ssm:/sample/vpc/sample-${pEnvironment}-${pSampleEnv}-vpc/id}}"
        pKubernetesType: "kubernetes"
        pEnvironment: !Ref pEnvironment
        pDomain: !Ref pDomain
        pELBSecurityGroupGroupId: !GetAtt sampleDeploymentKUBERNETESSecurity.Outputs.ELBSecurityGroupGroupId
  sampleDeploymentKUBERNETESEC2ControlPlane:
    Type: AWS::CloudFormation::Stack
    DependsOn:
    - sampleDeploymentEC2Defaults
    - sampleDeploymentKUBERNETESDNSELB
    Condition: DeployKUBERNETESResources
    Properties:
      TemplateURL: !Sub https://sample-${pSampleEnv}-${pEnvironment}-cloud-formation-templates.s3.us-gov-west-1.amazonaws.com/sampleDeployment/childTemplates/kubernetes/sampleDeploymentKUBERNETESEC2ControlPlane.yaml
      Parameters:
        pEc2DailyStop: !Ref pEc2DailyStop
        pEc2DailyStart: !Ref pEc2DailyStart
        pEnvironment: !Ref pEnvironment
        pDeploymentNumber: !Ref pDeploymentNumber
        pDomain: !Ref pDomain
        pInfrastructureName: !Sub ${pEnvironment}${pDeploymentNumber}
        pHostedZoneId: !Sub "{{resolve:ssm:/sample/route53/${pEnvironment}-dev/id}}"
        pControlPlaneInstanceType: !Ref pControlPlaneInstanceTypeKUBERNETES
        pKubernetesType: "kubernetes"
        pAMIId: !Sub "{{resolve:ssm:/sample/ec2/ami/RHEL/baseline/ami/0.0.7/id}}"
        pAutoRegisterELB: "yes"
        pSampleEnv: !Ref pSampleEnv
        pControlPlaneSecurityGroupId: !GetAtt sampleDeploymentKUBERNETESSecurity.Outputs.ControlPlaneSecurityGroupId
        pControlPlaneInstanceProfileId: !GetAtt sampleDeploymentKUBERNETESSecurity.Outputs.ControlPlaneInstanceProfileId
  sampleDeploymentKUBERNETESEC2Worker:
    Type: AWS::CloudFormation::Stack
    Condition: DeployKUBERNETESResources
    DependsOn: sampleDeploymentKUBERNETESEC2ControlPlane
    Properties:
      TemplateURL: !Sub https://sample-${pSampleEnv}-${pEnvironment}-cloud-formation-templates.s3.us-gov-west-1.amazonaws.com/sampleDeployment/childTemplates/kubernetes/sampleDeploymentKUBERNETESEC2Worker.yaml
      Parameters:
        pEc2DailyStop: !Ref pEc2DailyStop
        pEc2DailyStart: !Ref pEc2DailyStart
        pEnvironment: !Ref pEnvironment
        pDeploymentNumber: !Ref pDeploymentNumber
        pDomain: !Ref pDomain
        pInfrastructureName: !Sub ${pEnvironment}${pDeploymentNumber}
        pHostedZoneId: !Sub "{{resolve:ssm:/sample/route53/${pEnvironment}-dev/id}}"
        pWorkerInstanceType: !Ref pWorkerInstanceTypeKUBERNETES
        pKubernetesType: "kubernetes"
        pAMIId: !Sub "{{resolve:ssm:/sample/ec2/ami/RHEL/baseline/ami/0.0.7/id}}"
        pSampleEnv: !Ref pSampleEnv
        pWorkerSecurityGroupId: !GetAtt sampleDeploymentKUBERNETESSecurity.Outputs.WorkerSecurityGroupId
        pWorkerInstanceProfileId: !GetAtt sampleDeploymentKUBERNETESSecurity.Outputs.WorkerInstanceProfileId
### ARM KUBERNETES Resources ###
  sampleDeploymentARMKUBERNETESSecurity:
    Type: AWS::CloudFormation::Stack
    DependsOn: sampleDeploymentNetwork
    Condition: DeployARMKUBERNETESResources
    Properties:
      TemplateURL: !Sub https://sample-${pSampleEnv}-${pEnvironment}-cloud-formation-templates.s3.us-gov-west-1.amazonaws.com/sampleDeployment/childTemplates/armKubernetes/sampleDeploymentARMKUBERNETESSecurity.yaml
      Parameters:
        pInfrastructureName: !Sub ${pEnvironment}${pDeploymentNumber}
        pVpcId: !Sub "{{resolve:ssm:/sample/vpc/sample-${pEnvironment}-${pSampleEnv}-vpc/id}}"
        pVpcPrefix: !Sub "{{resolve:ssm:/sample/vpc/cidr/prefix}}"
        pCentralServicesSubnetPrefix: !Sub "{{resolve:ssm:/sample/vpc/central-services/subnet/cidr/prefix}}"
        pEnvironment: !Ref pEnvironment
        pDeploymentNumber: !Ref pDeploymentNumber
        pDomain: !Ref pDomain
        pKubernetesType: "kubernetes"
        pSampleEnv: !Ref pSampleEnv
  sampleDeploymentARMKUBERNETESEEFS:
    Type: AWS::CloudFormation::Stack
    DependsOn: sampleDeploymentARMKUBERNETESSecurity
    Condition: DeployARMKUBERNETESResources
    Properties:
      TemplateURL: !Sub https://sample-${pSampleEnv}-${pEnvironment}-cloud-formation-templates.s3.us-gov-west-1.amazonaws.com/sampleDeployment/childTemplates/armKubernetes/sampleDeploymentARMKUBERNETESEFS.yaml
      Parameters:
        pVpcId: !Sub "{{resolve:ssm:/sample/vpc/sample-${pEnvironment}-${pSampleEnv}-vpc/id}}"
        pSampleEnv: !Ref pSampleEnv
        pEnvironment: !Ref pEnvironment
        pDeploymentNumber: !Ref pDeploymentNumber
        pKubernetesType: "kubernetes"
        pVpcPrefix: !Sub "{{resolve:ssm:/sample/vpc/cidr/prefix}}"
  sampleDeploymentARMKUBERNETESDNSELB:
    Type: AWS::CloudFormation::Stack
    DependsOn: sampleDeploymentARMKUBERNETESSecurity
    Condition: DeployARMKUBERNETESResources
    Properties:
      TemplateURL: !Sub https://sample-${pSampleEnv}-${pEnvironment}-cloud-formation-templates.s3.us-gov-west-1.amazonaws.com/sampleDeployment/childTemplates/armKubernetes/sampleDeploymentARMKUBERNETESDNSELB.yaml
      Parameters:
        pSampleEnv: !Ref pSampleEnv
        pClusterName: !Sub ${pDeploymentNumber}.${pEnvironment}
        pDeploymentNumber: !Ref pDeploymentNumber
        pInfrastructureName: !Sub ${pEnvironment}${pDeploymentNumber}
        pHostedZoneId: !Sub "{{resolve:ssm:/sample/route53/${pEnvironment}-dev/id}}"
        pHostedZoneName: !Sub ${pEnvironment}.${pDomain}.sample.dev
        pVpcId: !Sub "{{resolve:ssm:/sample/vpc/sample-${pEnvironment}-${pSampleEnv}-vpc/id}}"
        pKubernetesType: "kubernetes"
        pEnvironment: !Ref pEnvironment
        pDomain: !Ref pDomain
        pELBSecurityGroupGroupId: !GetAtt sampleDeploymentARMKUBERNETESSecurity.Outputs.ELBSecurityGroupGroupId
  sampleDeploymentARMKUBERNETESEC2ControlPlane:
    Type: AWS::CloudFormation::Stack
    DependsOn:
    - sampleDeploymentEC2Defaults
    - sampleDeploymentARMKUBERNETESDNSELB
    Condition: DeployARMKUBERNETESResources
    Properties:
      TemplateURL: !Sub https://sample-${pSampleEnv}-${pEnvironment}-cloud-formation-templates.s3.us-gov-west-1.amazonaws.com/sampleDeployment/childTemplates/armKubernetes/sampleDeploymentARMKUBERNETESEC2ControlPlane.yaml
      Parameters:
        pEc2DailyStop: !Ref pEc2DailyStop
        pEc2DailyStart: !Ref pEc2DailyStart
        pEnvironment: !Ref pEnvironment
        pDeploymentNumber: !Ref pDeploymentNumber
        pDomain: !Ref pDomain
        pInfrastructureName: !Sub ${pEnvironment}${pDeploymentNumber}
        pHostedZoneId: !Sub "{{resolve:ssm:/sample/route53/${pEnvironment}-dev/id}}"
        pControlPlaneInstanceType: !Ref pControlPlaneInstanceTypeARMKUBERNETES
        pKubernetesType: "kubernetes"
        pAMIId: !Sub "{{resolve:ssm:/sample/ec2/ami/ALMA/baseline/ami/0.0.4/id}}"
        pAutoRegisterELB: "yes"
        pSampleEnv: !Ref pSampleEnv
        pControlPlaneSecurityGroupId: !GetAtt sampleDeploymentARMKUBERNETESSecurity.Outputs.ControlPlaneSecurityGroupId
        pControlPlaneInstanceProfileId: !GetAtt sampleDeploymentARMKUBERNETESSecurity.Outputs.ControlPlaneInstanceProfileId
  sampleDeploymentARMKUBERNETESEC2Worker:
    Type: AWS::CloudFormation::Stack
    Condition: DeployARMKUBERNETESResources
    DependsOn: sampleDeploymentARMKUBERNETESEC2ControlPlane
    Properties:
      TemplateURL: !Sub https://sample-${pSampleEnv}-${pEnvironment}-cloud-formation-templates.s3.us-gov-west-1.amazonaws.com/sampleDeployment/childTemplates/armKubernetes/sampleDeploymentARMKUBERNETESEC2Worker.yaml
      Parameters:
        pEc2DailyStop: !Ref pEc2DailyStop
        pEc2DailyStart: !Ref pEc2DailyStart
        pEnvironment: !Ref pEnvironment
        pDeploymentNumber: !Ref pDeploymentNumber
        pDomain: !Ref pDomain
        pInfrastructureName: !Sub ${pEnvironment}${pDeploymentNumber}
        pHostedZoneId: !Sub "{{resolve:ssm:/sample/route53/${pEnvironment}-dev/id}}"
        pWorkerInstanceType: !Ref pWorkerInstanceTypeARMKUBERNETES
        pKubernetesType: "kubernetes"
        pAMIId: !Sub "{{resolve:ssm:/sample/ec2/ami/ALMA/baseline/ami/0.0.4/id}}"
        pSampleEnv: !Ref pSampleEnv
        pWorkerSecurityGroupId: !GetAtt sampleDeploymentARMKUBERNETESSecurity.Outputs.WorkerSecurityGroupId
        pWorkerInstanceProfileId: !GetAtt sampleDeploymentARMKUBERNETESSecurity.Outputs.WorkerInstanceProfileId
### sampleA Fleet Resources ###
  sampleDeploymentsampleAFleet:
    Type: AWS::CloudFormation::Stack
    DependsOn: sampleDeploymentNetwork
    Condition: DeploysampleAFleetResources
    Properties:
      TemplateURL: !Sub https://sample-${pSampleEnv}-${pEnvironment}-cloud-formation-templates.s3.us-gov-west-1.amazonaws.com/sampleDeployment/childTemplates/samplea/sampleDeploymentsampleAFleetEC2.yaml
      Parameters:
        pSampleEnv: !Ref pSampleEnv
        pDeploymentNumber: !Ref pDeploymentNumber
        pEnvironment: !Ref pEnvironment
        pInstanceAmount: !Ref psampleAFleetInstanceAmount
        pLaunchTemplateId: !GetAtt sampleDeploymentEC2Defaults.Outputs.ec2FleetDefaultLinuxLaunchTemplateIdOutput
        pLaunchTemplateVer: !GetAtt sampleDeploymentEC2Defaults.Outputs.ec2FleetDefaultLinuxLaunchTemplateVerOutput
Outputs:
  ec2DefaultKeyOutput:
    Description: The name of the Parameter in the Parameter Store that contains the EC2-user private key.
    Value: !Sub  /ec2/keypair/${sampleDeploymentEC2Defaults.Outputs.ec2DefaultKeyOutput}
  ec2DefaultKeyPublicOutput:
    Description: The name of the Parameter in the Parameter Store that contains the EC2-user public key.
    Value: !Sub  /ec2/keypair/${sampleDeploymentEC2Defaults.Outputs.ec2DefaultKeyOutput}/public
  rkeEFSID:
    Condition: DeployRKE
    Description: The FileSystem ID for the RKE EFS.
    Value: !GetAtt sampleDeploymentRKEEFS.Outputs.kubernetesFileSystemResourceOutput
  kubeEFSID:
    Condition: DeployKUBERNETESResources
    Description: The FileSystem ID for the Kubernetes EFS.
    Value: !GetAtt sampleDeploymentKUBERNETESEEFS.Outputs.kubernetesFileSystemResourceOutput