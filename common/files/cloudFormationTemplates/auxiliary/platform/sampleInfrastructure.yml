AWSTemplateFormatVersion: 2010-09-09
Metadata:
  AWS::CloudFormation::Interface:
    ParameterGroups:
      - Label:
          default: "Network"
        Parameters:
          - pSubnetCidr0
      - Label:
          default: "Host Information"
        Parameters:
          - pRHEL7AMIId
          - psampleMGMTAMIId
          - pRHCOSAMIId
      - Label:
          default: "OpenShift Information"
        Parameters:
          - pDeployBootStrap
          - pDeployMasters
          - pDeployWorkers
          - InfrastructureName
          - pCluster
      - Label:
          default: "Management EC2 Information"
        Parameters:
          - pDeployManagementNode
          - pDeployAuxNodes
      - Label:
          default: "Node Start/Stop Information"
        Parameters:
          - pEc2DailyStart
          - pEc2DailyStop
Parameters:
  pSubnetCidr0:
    Type: String
    Default: "10.30.6.160/27"
  pRHEL7AMIId:
    Type: AWS::EC2::Image::Id
    Description: The baseline AMI ID.
    Default: "ami-0f96bdb00112d32d1"
  psampleMGMTAMIId:
    Type: AWS::EC2::Image::Id
    Description: Keep same as pRHEL7AMIId unless you are restoring sample MGMT.
    Default: "ami-0af450c59017d0687"
  pRHCOSAMIId:
    Type: AWS::EC2::Image::Id
    Description: The baseline AMI ID.
    Default: "ami-0c1c5acct3a472889818"
  InfrastructureName:
    MaxLength: 27
    MinLength: 1
    ConstraintDescription: Infrastructure name must be alphanumeric, start with a letter, and have a maximum of 27 characters.
    Description: A short, unique cluster ID used to tag nodes for the kubelet cloud provider.
    Type: String
    Default: ChangeAfterCreatingIgnFiles
  pDeploymentNumber:
    Type: Number
    Default: 0
  pDeployBootStrap:
    Type: String
    Default: "false"
    AllowedValues:
      - "true"
      - "false"
  pDeployManagementNode:
    Type: String
    Default: "true"
    AllowedValues:
      - "true"
      - "false"
  pDeployAuxNodes:
    Type: String
    Default: "false"
    Description: "All non-OpenShift nodes, excluding Management"
    AllowedValues:
      - "true"
      - "false"
  pDeployMasters:
    Type: String
    Default: "false"
    AllowedValues:
      - "true"
      - "false"
  pDeployWorkers:
    Type: String
    Default: "false"
    AllowedValues:
      - "true"
      - "false"
  pCluster:
    Type: String
    Description: Auto updated by playbook.
    Default: "null"
  pEc2DailyStop:
    Type: String
    Description: Do you want the EC2 resources to stop automatically Monday-Friday at 10PM EST, 7PM PST?
    AllowedValues:
      - "true"
      - "false"
  pEc2DailyStart:
    Type: String
    Description: Do you want the EC2 resources to stop automatically Monday-Friday at 4AM EST, 1AM PST?
    AllowedValues:
      - "true"
      - "false"
Conditions:
  DeployBootstrap: !Equals
    - !Ref pDeployBootStrap
    - "true"
  DeployMasters: !Equals
    - !Ref pDeployMasters
    - "true"
  DeployWorkers: !Equals
    - !Ref pDeployWorkers
    - "true"
  DeployAuxNodes: !Equals
    - !Ref pDeployAuxNodes
    - "true"
  DeployManagementNode: !Equals
    - !Ref pDeployManagementNode
    - "true"
Resources:
## Network
  PrivateSubnet0:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Sub "{{resolve:ssm:/sample/vpc/sample-dev-prod-vpc/id}}"
      CidrBlock: !Ref pSubnetCidr0
      AvailabilityZone: !Select
        - 0
        - Fn::GetAZs: !Ref "AWS::Region"
      Tags:
        - Key: "deploymentType"
          Value: sample
        - Key: Name
          Value: !Sub "sample-deployment-sample${pDeploymentNumber}-subnet-0"
  PrivateRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Sub "{{resolve:ssm:/sample/vpc/sample-dev-prod-vpc/id}}"
      Tags:
        - Key: Name
          Value: !Sub "sample-deployment-sample${pDeploymentNumber}-subnet-0-rt"
  PrivateSubnet0RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PrivateSubnet0
      RouteTableId: !Ref PrivateRouteTable
  Route:
    Type: AWS::EC2::Route
    Properties:
      RouteTableId: !Ref PrivateRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      TransitGatewayId: !Sub "{{resolve:ssm:/sample/sample-dev-prod-vpc/tgw/id}}"
## EC2 Defaults
  DefaultKey:
    Type: AWS::EC2::KeyPair
    Properties:
      KeyName: !Sub dev-sample-default-key
      KeyFormat: pem
      KeyType: rsa
  DefaultRole:
    Type: AWS::IAM::Role
    Properties:
      ManagedPolicyArns:
        - "arn:aws-us-gov:iam::aws:policy/AmazonSSMManagedInstanceCore"
      AssumeRolePolicyDocument:
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - "ec2.amazonaws.com"
            Action:
              - sts:AssumeRole
      Path: /
      RoleName: !Sub dev-sample-DefaultEC2Role
  DefaultRoleAdditionalPolicy:
    Type: AWS::IAM::ManagedPolicy
    Properties:
      Description: "ec2DefaultRoleAdditionalPolicy"
      ManagedPolicyName: !Sub dev-sample-ec2DefaultRoleAdditionalPolicy
      PolicyDocument:
        Version: 2012-10-17
        Statement:
          - Sid: VisualEditor0
            Effect: Allow
            Action: secretsmanager:GetRandomPassword
            Resource: "*"
          - Sid: VisualEditor1
            Effect: Allow
            Action: s3:*
            Resource: "*"
          - Sid: VisualEditor2
            Effect: Allow
            Action: ssm:GetParameter
            Resource: "*"
      Roles:
        - !Ref DefaultRole
  iamProfileDefault:
    Type: AWS::IAM::InstanceProfile
    Properties:
      Roles:
        - Ref: DefaultRole
  ManagementRole:
    Type: AWS::IAM::Role
    Properties:
      ManagedPolicyArns:
        - "arn:aws-us-gov:iam::aws:policy/AmazonSSMManagedInstanceCore"
        - "arn:aws-us-gov:iam::aws:policy/AdministratorAccess"
      AssumeRolePolicyDocument:
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - "ec2.amazonaws.com"
            Action:
              - sts:AssumeRole
      Path: /
      RoleName: !Sub dev-sample-ManagementEC2Role
  iamProfileManagement:
    Type: AWS::IAM::InstanceProfile
    Properties:
      Roles:
        - Ref: ManagementRole
  WindowsRole:
    Type: AWS::IAM::Role
    Properties:
      ManagedPolicyArns:
        - "arn:aws-us-gov:iam::aws:policy/AmazonSSMManagedInstanceCore"
      AssumeRolePolicyDocument:
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - "ec2.amazonaws.com"
            Action:
              - sts:AssumeRole
      Path: /
      RoleName: !Sub dev-sample-WindowsEC2Role
  WindowsRoleAdditionalPolicy:
    Type: AWS::IAM::ManagedPolicy
    Properties:
      Description: "ec2WindowsRoleAdditionalPolicy"
      ManagedPolicyName: !Sub dev-sample-ec2WindowsRoleAdditionalPolicy
      PolicyDocument:
        Version: 2012-10-17
        Statement:
          - Sid: VisualEditor0
            Effect: Allow
            Action: secretsmanager:GetRandomPassword
            Resource: "*"
          - Sid: VisualEditor1
            Effect: Allow
            Action: s3:*
            Resource: "*"
          - Sid: VisualEditor2
            Effect: Allow
            Action:
              - ssm:GetParameter
              - ds:DescribeDirectories
              - ds:CreateComputer
              - ec2:DescribeVpcs
              - ec2:DescribeSubnets
              - ec2:DescribeNetworkInterfaces
              - ec2:CreateNetworkInterface
              - ec2:AttachNetworkInterface
              - ec2:DescribeInstances
              - ec2:DescribeImages
              - ec2:DescribeInstanceTypes
              - ec2:RunInstances
              - ec2:CreateTags
              - ssm:DescribeInstanceInformation
              - ssm:SendCommand
              - ssm:GetCommandInvocation
              - ssm:CreateBatchAssociation
            Resource: "*"
      Roles:
        - !Ref WindowsRole
  iamProfileWindows:
    Type: AWS::IAM::InstanceProfile
    Properties:
      Roles:
        - Ref: WindowsRole
  DefaultLinuxLaunchTemplate:
    Type: AWS::EC2::LaunchTemplate
    Properties:
      LaunchTemplateName: !Sub dev-sample-ec2RedHat7LaunchTemplate
      LaunchTemplateData:
        ImageId: !Ref pRHEL7AMIId
        IamInstanceProfile:
          Name: !Ref iamProfileDefault
        KeyName: !Ref DefaultKey
        MetadataOptions:
          InstanceMetadataTags: enabled
          HttpTokens: required
        BlockDeviceMappings:
          - DeviceName: /dev/sda1
            Ebs:
              VolumeType: gp3
              DeleteOnTermination: "true"
              VolumeSize: "300"
        TagSpecifications:
          - ResourceType: instance
            Tags:
              - Key: "deploymentType"
                Value: sample
              - Key: "deploymentNumber"
                Value: !Sub sample${pDeploymentNumber}

              - Key: "systemGroup"
                Value: "Red Hat Enterprise Linux"
        UserData:
          Fn::Base64: !Sub |
            #!/bin/bash
            TOKEN=`curl -X PUT "http://169.254.169.254/latest/api/token" -H "X-aws-ec2-metadata-token-ttl-seconds: 21600"`
            OSVERSION=$(grep -E '^(VERSION_ID)=' /etc/os-release | awk -F"\"" '{print $2}' | awk -F"." '{print $1}')
            COMPLIANCEID=$(aws ssm get-parameter --name /redhat/insights/rhel$OSVERSION/complianceid --query Parameter.Value --with-decryption --output=text)
            REDHATPASSWORD=$(aws ssm get-parameter --name /redhat/samplerheladmin/password --query Parameter.Value --with-decryption --output=text)
            ROOTPASSWORD=$(aws ssm get-parameter --name /sample/ec2/root/password --query Parameter.Value --with-decryption --output=text)
            SYSADMINPASSWORD=$(aws ssm get-parameter --name /sample/ec2/sysadmin/password --query Parameter.Value --with-decryption --output=text)
            InstanceName=`curl -H "X-aws-ec2-metadata-token: $TOKEN" http://169.254.169.254/latest/meta-data/tags/instance/Name`
            hostnamectl set-hostname $InstanceName --static
            subscription-manager register --force --username samplerheladmin --password "$REDHATPASSWORD"
            insights-client --register
            insights-client  --compliance-assign  "$COMPLIANCEID"
            echo "root:$ROOTPASSWORD" | chpasswd
            sed -i 's/PasswordAuthentication no/PasswordAuthentication yes/g' /etc/ssh/sshd_config
            systemctl reload sshd
  RHEL8DefaultLinuxLaunchTemplate:
    Type: AWS::EC2::LaunchTemplate
    Properties:
      LaunchTemplateName: !Sub dev-sample-ec2RedHat8LaunchTemplate
      LaunchTemplateData:
        ImageId: !Sub "{{resolve:ssm:/sample/ec2/ami/RHEL/baseline/ami/0.0.7/id}}"
        IamInstanceProfile:
          Name: !Ref iamProfileDefault
        KeyName: !Ref DefaultKey
        MetadataOptions:
          InstanceMetadataTags: enabled
          HttpTokens: required
        BlockDeviceMappings:
          - DeviceName: /dev/sda1
            Ebs:
              VolumeType: gp3
              DeleteOnTermination: "true"
              VolumeSize: "100"
        TagSpecifications:
          - ResourceType: instance
            Tags:
              - Key: "systemGroup"
                Value: "Red Hat Enterprise Linux"
        UserData:
          Fn::Base64: !Sub |
            #!/bin/bash
            TOKEN=`curl -X PUT "http://169.254.169.254/latest/api/token" -H "X-aws-ec2-metadata-token-ttl-seconds: 21600"`
            OSVERSION=$(grep -E '^(VERSION_ID)=' /etc/os-release | awk -F"\"" '{print $2}' | awk -F"." '{print $1}')
            COMPLIANCEID=$(aws ssm get-parameter --name /redhat/insights/rhel$OSVERSION/complianceid --query Parameter.Value --with-decryption --output=text)
            REDHATPASSWORD=$(aws ssm get-parameter --name /redhat/samplerheladmin/password --query Parameter.Value --with-decryption --output=text)
            ROOTPASSWORD=$(aws ssm get-parameter --name /sample/ec2/root/password --query Parameter.Value --with-decryption --output=text)
            InstanceName=`curl -H "X-aws-ec2-metadata-token: $TOKEN" http://169.254.169.254/latest/meta-data/tags/instance/Name`
            hostnamectl set-hostname $InstanceName --static
            dnf install python3.12 -y
            dnf install insights-client scap-security-guide openscap-scanner openscap -y
            subscription-manager register --force --username samplerheladmin --password "$REDHATPASSWORD"
            insights-client --register
            insights-client  --compliance-assign  "$COMPLIANCEID"
            echo "root:$ROOTPASSWORD" | chpasswd
  BootstrapRHCOSLaunchTemplate:
    Type: AWS::EC2::LaunchTemplate
    Properties:
      LaunchTemplateName: !Sub dev-sample-BootstrapRHCOSLaunchTemplate
      LaunchTemplateData:
        ImageId: !Ref pRHCOSAMIId
        UserData:
          Fn::Base64: !Sub
          - '{"ignition":{"config":{"replace":{"source":"${S3Loc}"}},"version":"3.2.0"}}'
          - {
            S3Loc: !Sub "s3://${AWS::AccountId}-sample${pCluster}-ignition/bootstrap.ign"
          }
        IamInstanceProfile:
          Name: !Ref iamProfileDefault
        KeyName: !Ref DefaultKey
        MetadataOptions:
          InstanceMetadataTags: disabled
        BlockDeviceMappings:
          - DeviceName: /dev/xvda
            Ebs:
              VolumeType: gp3
              DeleteOnTermination: "true"
              VolumeSize: "300"
          - DeviceName: /dev/sdb
            Ebs:
              VolumeType: gp3
              DeleteOnTermination: "true"
              VolumeSize: "300"
        TagSpecifications:
          - ResourceType: instance
            Tags:
              - Key: "deploymentType"
                Value: sample

              - Key: "systemGroup"
                Value: "Red Hat Core OS"
              - Key: "deploymentNumber"
                Value: !Sub sample${pDeploymentNumber}
  MasterRHCOSLaunchTemplate:
    Type: AWS::EC2::LaunchTemplate
    Properties:
      LaunchTemplateName: !Sub dev-sample-MasterRHCOSLaunchTemplate
      LaunchTemplateData:
        ImageId: !Ref pRHCOSAMIId
        IamInstanceProfile:
          Name: !Ref iamProfileDefault
        KeyName: !Ref DefaultKey
        MetadataOptions:
          InstanceMetadataTags: disabled
        BlockDeviceMappings:
          - DeviceName: /dev/xvda
            Ebs:
              VolumeType: gp3
              DeleteOnTermination: "true"
              VolumeSize: "300"
          - DeviceName: /dev/sdb
            Ebs:
              VolumeType: gp3
              DeleteOnTermination: "true"
              VolumeSize: "300"
        UserData:
          Fn::Base64: !Sub
          - '{"ignition":{"config":{"replace":{"source":"${S3Loc}"}},"version":"3.2.0"}}'
          - {
            S3Loc: !Sub "s3://${AWS::AccountId}-sample${pCluster}-ignition/master.ign"
          }
        TagSpecifications:
          - ResourceType: instance
            Tags:
              - Key: "deploymentType"
                Value: sample

              - Key: "systemGroup"
                Value: "Red Hat Core OS"
              - Key: !Join ["", ["kubernetes.io/cluster/", !Ref InfrastructureName]]
                Value: "shared"
              - Key: "deploymentNumber"
                Value: !Sub sample${pDeploymentNumber}
  WorkerRHCOSLaunchTemplate:
    Type: AWS::EC2::LaunchTemplate
    Properties:
      LaunchTemplateName: !Sub dev-sample-workerRHCOSLaunchTemplate
      LaunchTemplateData:
        ImageId: !Ref pRHCOSAMIId
        IamInstanceProfile:
          Name: !Ref iamProfileDefault
        KeyName: !Ref DefaultKey
        MetadataOptions:
          InstanceMetadataTags: disabled
        BlockDeviceMappings:
          - DeviceName: /dev/xvda
            Ebs:
              VolumeType: gp3
              DeleteOnTermination: "true"
              VolumeSize: "300"
          - DeviceName: /dev/sdb
            Ebs:
              VolumeType: gp3
              DeleteOnTermination: "true"
              VolumeSize: "300"
        UserData:
          Fn::Base64: !Sub
          - '{"ignition":{"config":{"replace":{"source":"${S3Loc}"}},"version":"3.2.0"}}'
          - {
            S3Loc: !Sub "s3://${AWS::AccountId}-sample${pCluster}-ignition/worker.ign"
          }
        TagSpecifications:
          - ResourceType: instance
            Tags:
              - Key: "deploymentType"
                Value: sample

              - Key: "systemGroup"
                Value: "Red Hat Core OS"
              - Key: !Join ["", ["kubernetes.io/cluster/", !Ref InfrastructureName]]
                Value: "shared"
              - Key: "deploymentNumber"
                Value: !Sub sample${pDeploymentNumber}
## Security
  BootstrapSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Cluster Bootstrap Security Group
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          SourcePrefixListId: !Sub "{{resolve:ssm:/sample/vpc/cidr/prefix}}"
        - IpProtocol: tcp
          ToPort: 19531
          FromPort: 19531
          SourcePrefixListId: !Sub "{{resolve:ssm:/sample/vpc/cidr/prefix}}"
      VpcId: !Sub "{{resolve:ssm:/sample/vpc/sample-dev-prod-vpc/id}}"
  DefaultSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Default Security Group
      SecurityGroupIngress:
        - IpProtocol: -1
          SourcePrefixListId: !Sub "{{resolve:ssm:/sample/vpc/cidr/prefix}}"
      VpcId: !Sub "{{resolve:ssm:/sample/vpc/sample-dev-prod-vpc/id}}"
      Tags:
        - Key: "deploymentType"
          Value: sample
  MasterSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Cluster Master Security Group
      SecurityGroupIngress:
        - IpProtocol: -1
          SourcePrefixListId: !Sub "{{resolve:ssm:/sample/vpc/cidr/prefix}}"
        - IpProtocol: tcp
          FromPort: "443"
          ToPort: "443"
          SourcePrefixListId: !Sub "{{resolve:ssm:/sample/vpc/cidr/prefix}}"
        - IpProtocol: icmp
          FromPort: 0
          ToPort: 0
          SourcePrefixListId: !Sub "{{resolve:ssm:/sample/vpc/cidr/prefix}}"
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          SourcePrefixListId: !Sub "{{resolve:ssm:/sample/vpc/cidr/prefix}}"
        - IpProtocol: tcp
          ToPort: 6443
          FromPort: 6443
          SourcePrefixListId: !Sub "{{resolve:ssm:/sample/vpc/cidr/prefix}}"
        - IpProtocol: tcp
          FromPort: 22623
          ToPort: 22623
          SourcePrefixListId: !Sub "{{resolve:ssm:/sample/vpc/cidr/prefix}}"
      VpcId: !Sub "{{resolve:ssm:/sample/vpc/sample-dev-prod-vpc/id}}"
      Tags:
        - Key: "deploymentType"
          Value: sample
  WorkerSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Cluster Worker Security Group
      SecurityGroupIngress:
        - IpProtocol: -1
          SourcePrefixListId: !Sub "{{resolve:ssm:/sample/vpc/cidr/prefix}}"
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          SourcePrefixListId: !Sub "{{resolve:ssm:/sample/vpc/cidr/prefix}}"
      VpcId: !Sub "{{resolve:ssm:/sample/vpc/sample-dev-prod-vpc/id}}"
      Tags:
        - Key: "deploymentType"
          Value: sample
  MasterIngressELB:
    Type: AWS::EC2::SecurityGroupIngress
    Properties:
      GroupId: !GetAtt MasterSecurityGroup.GroupId
      SourceSecurityGroupId: !GetAtt DefaultSecurityGroup.GroupId
      Description: elb
      IpProtocol: -1
  MasterIngressEtcd:
    Type: AWS::EC2::SecurityGroupIngress
    Properties:
      GroupId: !GetAtt MasterSecurityGroup.GroupId
      SourceSecurityGroupId: !GetAtt MasterSecurityGroup.GroupId
      Description: etcd
      FromPort: 2379
      ToPort: 2380
      IpProtocol: tcp
  MasterIngressVxlan:
    Type: AWS::EC2::SecurityGroupIngress
    Properties:
      GroupId: !GetAtt MasterSecurityGroup.GroupId
      SourceSecurityGroupId: !GetAtt MasterSecurityGroup.GroupId
      Description: Vxlan packets
      FromPort: 4789
      ToPort: 4789
      IpProtocol: udp
  MasterIngressWorkerVxlan:
    Type: AWS::EC2::SecurityGroupIngress
    Properties:
      GroupId: !GetAtt MasterSecurityGroup.GroupId
      SourceSecurityGroupId: !GetAtt WorkerSecurityGroup.GroupId
      Description: Vxlan packets
      FromPort: 4789
      ToPort: 4789
      IpProtocol: udp
  MasterIngressGeneve:
    Type: AWS::EC2::SecurityGroupIngress
    Properties:
      GroupId: !GetAtt MasterSecurityGroup.GroupId
      SourceSecurityGroupId: !GetAtt MasterSecurityGroup.GroupId
      Description: Geneve packets
      FromPort: 6081
      ToPort: 6081
      IpProtocol: udp
  MasterIngressWorkerGeneve:
    Type: AWS::EC2::SecurityGroupIngress
    Properties:
      GroupId: !GetAtt MasterSecurityGroup.GroupId
      SourceSecurityGroupId: !GetAtt WorkerSecurityGroup.GroupId
      Description: Geneve packets
      FromPort: 6081
      ToPort: 6081
      IpProtocol: udp
  MasterIngressIpsecIke:
    Type: AWS::EC2::SecurityGroupIngress
    Properties:
      GroupId: !GetAtt MasterSecurityGroup.GroupId
      SourceSecurityGroupId: !GetAtt MasterSecurityGroup.GroupId
      Description: IPsec IKE packets
      FromPort: 500
      ToPort: 500
      IpProtocol: udp
  MasterIngressIpsecNat:
    Type: AWS::EC2::SecurityGroupIngress
    Properties:
      GroupId: !GetAtt MasterSecurityGroup.GroupId
      SourceSecurityGroupId: !GetAtt MasterSecurityGroup.GroupId
      Description: IPsec NAT-T packets
      FromPort: 4500
      ToPort: 4500
      IpProtocol: udp
  MasterIngressIpsecEsp:
    Type: AWS::EC2::SecurityGroupIngress
    Properties:
      GroupId: !GetAtt MasterSecurityGroup.GroupId
      SourceSecurityGroupId: !GetAtt MasterSecurityGroup.GroupId
      Description: IPsec ESP packets
      IpProtocol: 50
  MasterIngressWorkerIpsecIke:
    Type: AWS::EC2::SecurityGroupIngress
    Properties:
      GroupId: !GetAtt MasterSecurityGroup.GroupId
      SourceSecurityGroupId: !GetAtt WorkerSecurityGroup.GroupId
      Description: IPsec IKE packets
      FromPort: 500
      ToPort: 500
      IpProtocol: udp
  MasterIngressWorkerIpsecNat:
    Type: AWS::EC2::SecurityGroupIngress
    Properties:
      GroupId: !GetAtt MasterSecurityGroup.GroupId
      SourceSecurityGroupId: !GetAtt WorkerSecurityGroup.GroupId
      Description: IPsec NAT-T packets
      FromPort: 4500
      ToPort: 4500
      IpProtocol: udp
  MasterIngressWorkerIpsecEsp:
    Type: AWS::EC2::SecurityGroupIngress
    Properties:
      GroupId: !GetAtt MasterSecurityGroup.GroupId
      SourceSecurityGroupId: !GetAtt WorkerSecurityGroup.GroupId
      Description: IPsec ESP packets
      IpProtocol: 50
  MasterIngressInternal:
    Type: AWS::EC2::SecurityGroupIngress
    Properties:
      GroupId: !GetAtt MasterSecurityGroup.GroupId
      SourceSecurityGroupId: !GetAtt MasterSecurityGroup.GroupId
      Description: Internal cluster communication
      FromPort: 9000
      ToPort: 9999
      IpProtocol: tcp
  MasterIngressWorkerInternal:
    Type: AWS::EC2::SecurityGroupIngress
    Properties:
      GroupId: !GetAtt MasterSecurityGroup.GroupId
      SourceSecurityGroupId: !GetAtt WorkerSecurityGroup.GroupId
      Description: Internal cluster communication
      FromPort: 9000
      ToPort: 9999
      IpProtocol: tcp
  MasterIngressInternalUDP:
    Type: AWS::EC2::SecurityGroupIngress
    Properties:
      GroupId: !GetAtt MasterSecurityGroup.GroupId
      SourceSecurityGroupId: !GetAtt MasterSecurityGroup.GroupId
      Description: Internal cluster communication
      FromPort: 9000
      ToPort: 9999
      IpProtocol: udp
  MasterIngressWorkerInternalUDP:
    Type: AWS::EC2::SecurityGroupIngress
    Properties:
      GroupId: !GetAtt MasterSecurityGroup.GroupId
      SourceSecurityGroupId: !GetAtt WorkerSecurityGroup.GroupId
      Description: Internal cluster communication
      FromPort: 9000
      ToPort: 9999
      IpProtocol: udp
  MasterIngressKube:
    Type: AWS::EC2::SecurityGroupIngress
    Properties:
      GroupId: !GetAtt MasterSecurityGroup.GroupId
      SourceSecurityGroupId: !GetAtt MasterSecurityGroup.GroupId
      Description: Kubernetes kubelet, scheduler and controller manager
      FromPort: 10250
      ToPort: 10259
      IpProtocol: tcp
  MasterIngressWorkerKube:
    Type: AWS::EC2::SecurityGroupIngress
    Properties:
      GroupId: !GetAtt MasterSecurityGroup.GroupId
      SourceSecurityGroupId: !GetAtt WorkerSecurityGroup.GroupId
      Description: Kubernetes kubelet, scheduler and controller manager
      FromPort: 10250
      ToPort: 10259
      IpProtocol: tcp
  MasterIngressIngressServices:
    Type: AWS::EC2::SecurityGroupIngress
    Properties:
      GroupId: !GetAtt MasterSecurityGroup.GroupId
      SourceSecurityGroupId: !GetAtt MasterSecurityGroup.GroupId
      Description: Kubernetes ingress services
      FromPort: 30000
      ToPort: 32767
      IpProtocol: tcp
  MasterIngressWorkerIngressServices:
    Type: AWS::EC2::SecurityGroupIngress
    Properties:
      GroupId: !GetAtt MasterSecurityGroup.GroupId
      SourceSecurityGroupId: !GetAtt WorkerSecurityGroup.GroupId
      Description: Kubernetes ingress services
      FromPort: 30000
      ToPort: 32767
      IpProtocol: tcp
  MasterIngressIngressServicesUDP:
    Type: AWS::EC2::SecurityGroupIngress
    Properties:
      GroupId: !GetAtt MasterSecurityGroup.GroupId
      SourceSecurityGroupId: !GetAtt MasterSecurityGroup.GroupId
      Description: Kubernetes ingress services
      FromPort: 30000
      ToPort: 32767
      IpProtocol: udp
  MasterIngressWorkerIngressServicesUDP:
    Type: AWS::EC2::SecurityGroupIngress
    Properties:
      GroupId: !GetAtt MasterSecurityGroup.GroupId
      SourceSecurityGroupId: !GetAtt WorkerSecurityGroup.GroupId
      Description: Kubernetes ingress services
      FromPort: 30000
      ToPort: 32767
      IpProtocol: udp
  WorkerIngressELB:
    Type: AWS::EC2::SecurityGroupIngress
    Properties:
      GroupId: !GetAtt WorkerSecurityGroup.GroupId
      SourceSecurityGroupId: !GetAtt DefaultSecurityGroup.GroupId
      Description: elb
      IpProtocol: -1
  WorkerIngressVxlan:
    Type: AWS::EC2::SecurityGroupIngress
    Properties:
      GroupId: !GetAtt WorkerSecurityGroup.GroupId
      SourceSecurityGroupId: !GetAtt WorkerSecurityGroup.GroupId
      Description: Vxlan packets
      FromPort: 4789
      ToPort: 4789
      IpProtocol: udp
  WorkerIngressMasterVxlan:
    Type: AWS::EC2::SecurityGroupIngress
    Properties:
      GroupId: !GetAtt WorkerSecurityGroup.GroupId
      SourceSecurityGroupId: !GetAtt MasterSecurityGroup.GroupId
      Description: Vxlan packets
      FromPort: 4789
      ToPort: 4789
      IpProtocol: udp
  WorkerIngressGeneve:
    Type: AWS::EC2::SecurityGroupIngress
    Properties:
      GroupId: !GetAtt WorkerSecurityGroup.GroupId
      SourceSecurityGroupId: !GetAtt WorkerSecurityGroup.GroupId
      Description: Geneve packets
      FromPort: 6081
      ToPort: 6081
      IpProtocol: udp
  WorkerIngressMasterGeneve:
    Type: AWS::EC2::SecurityGroupIngress
    Properties:
      GroupId: !GetAtt WorkerSecurityGroup.GroupId
      SourceSecurityGroupId: !GetAtt MasterSecurityGroup.GroupId
      Description: Geneve packets
      FromPort: 6081
      ToPort: 6081
      IpProtocol: udp
  WorkerIngressIpsecIke:
    Type: AWS::EC2::SecurityGroupIngress
    Properties:
      GroupId: !GetAtt WorkerSecurityGroup.GroupId
      SourceSecurityGroupId: !GetAtt WorkerSecurityGroup.GroupId
      Description: IPsec IKE packets
      FromPort: 500
      ToPort: 500
      IpProtocol: udp
  WorkerIngressIpsecNat:
    Type: AWS::EC2::SecurityGroupIngress
    Properties:
      GroupId: !GetAtt WorkerSecurityGroup.GroupId
      SourceSecurityGroupId: !GetAtt WorkerSecurityGroup.GroupId
      Description: IPsec NAT-T packets
      FromPort: 4500
      ToPort: 4500
      IpProtocol: udp
  WorkerIngressIpsecEsp:
    Type: AWS::EC2::SecurityGroupIngress
    Properties:
      GroupId: !GetAtt WorkerSecurityGroup.GroupId
      SourceSecurityGroupId: !GetAtt WorkerSecurityGroup.GroupId
      Description: IPsec ESP packets
      IpProtocol: 50
  WorkerIngressMasterIpsecIke:
    Type: AWS::EC2::SecurityGroupIngress
    Properties:
      GroupId: !GetAtt WorkerSecurityGroup.GroupId
      SourceSecurityGroupId: !GetAtt MasterSecurityGroup.GroupId
      Description: IPsec IKE packets
      FromPort: 500
      ToPort: 500
      IpProtocol: udp
  WorkerIngressMasterIpsecNat:
    Type: AWS::EC2::SecurityGroupIngress
    Properties:
      GroupId: !GetAtt WorkerSecurityGroup.GroupId
      SourceSecurityGroupId: !GetAtt MasterSecurityGroup.GroupId
      Description: IPsec NAT-T packets
      FromPort: 4500
      ToPort: 4500
      IpProtocol: udp
  WorkerIngressMasterIpsecEsp:
    Type: AWS::EC2::SecurityGroupIngress
    Properties:
      GroupId: !GetAtt WorkerSecurityGroup.GroupId
      SourceSecurityGroupId: !GetAtt MasterSecurityGroup.GroupId
      Description: IPsec ESP packets
      IpProtocol: 50
  WorkerIngressInternal:
    Type: AWS::EC2::SecurityGroupIngress
    Properties:
      GroupId: !GetAtt WorkerSecurityGroup.GroupId
      SourceSecurityGroupId: !GetAtt WorkerSecurityGroup.GroupId
      Description: Internal cluster communication
      FromPort: 9000
      ToPort: 9999
      IpProtocol: tcp
  WorkerIngressMasterInternal:
    Type: AWS::EC2::SecurityGroupIngress
    Properties:
      GroupId: !GetAtt WorkerSecurityGroup.GroupId
      SourceSecurityGroupId: !GetAtt MasterSecurityGroup.GroupId
      Description: Internal cluster communication
      FromPort: 9000
      ToPort: 9999
      IpProtocol: tcp
  WorkerIngressInternalUDP:
    Type: AWS::EC2::SecurityGroupIngress
    Properties:
      GroupId: !GetAtt WorkerSecurityGroup.GroupId
      SourceSecurityGroupId: !GetAtt WorkerSecurityGroup.GroupId
      Description: Internal cluster communication
      FromPort: 9000
      ToPort: 9999
      IpProtocol: udp
  WorkerIngressMasterInternalUDP:
    Type: AWS::EC2::SecurityGroupIngress
    Properties:
      GroupId: !GetAtt WorkerSecurityGroup.GroupId
      SourceSecurityGroupId: !GetAtt MasterSecurityGroup.GroupId
      Description: Internal cluster communication
      FromPort: 9000
      ToPort: 9999
      IpProtocol: udp
  WorkerIngressKube:
    Type: AWS::EC2::SecurityGroupIngress
    Properties:
      GroupId: !GetAtt WorkerSecurityGroup.GroupId
      SourceSecurityGroupId: !GetAtt WorkerSecurityGroup.GroupId
      Description: Kubernetes secure kubelet port
      FromPort: 10250
      ToPort: 10250
      IpProtocol: tcp
  WorkerIngressWorkerKube:
    Type: AWS::EC2::SecurityGroupIngress
    Properties:
      GroupId: !GetAtt WorkerSecurityGroup.GroupId
      SourceSecurityGroupId: !GetAtt MasterSecurityGroup.GroupId
      Description: Internal Kubernetes communication
      FromPort: 10250
      ToPort: 10250
      IpProtocol: tcp
  WorkerIngressIngressServices:
    Type: AWS::EC2::SecurityGroupIngress
    Properties:
      GroupId: !GetAtt WorkerSecurityGroup.GroupId
      SourceSecurityGroupId: !GetAtt WorkerSecurityGroup.GroupId
      Description: Kubernetes ingress services
      FromPort: 30000
      ToPort: 32767
      IpProtocol: tcp
  WorkerIngressMasterIngressServices:
    Type: AWS::EC2::SecurityGroupIngress
    Properties:
      GroupId: !GetAtt WorkerSecurityGroup.GroupId
      SourceSecurityGroupId: !GetAtt MasterSecurityGroup.GroupId
      Description: Kubernetes ingress services
      FromPort: 30000
      ToPort: 32767
      IpProtocol: tcp
  WorkerIngressIngressServicesUDP:
    Type: AWS::EC2::SecurityGroupIngress
    Properties:
      GroupId: !GetAtt WorkerSecurityGroup.GroupId
      SourceSecurityGroupId: !GetAtt WorkerSecurityGroup.GroupId
      Description: Kubernetes ingress services
      FromPort: 30000
      ToPort: 32767
      IpProtocol: udp
  WorkerIngressMasterIngressServicesUDP:
    Type: AWS::EC2::SecurityGroupIngress
    Properties:
      GroupId: !GetAtt WorkerSecurityGroup.GroupId
      SourceSecurityGroupId: !GetAtt MasterSecurityGroup.GroupId
      Description: Kubernetes ingress services
      FromPort: 30000
      ToPort: 32767
      IpProtocol: udp
  BootstrapIamRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: "Allow"
            Principal:
              Service:
                - "ec2.amazonaws.com"
            Action:
              - "sts:AssumeRole"
      Path: "/"
      Policies:
        - PolicyName:
            !Join ["-", ["sample", "bootstrap", "policy"]]
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: "Allow"
                Action: "ec2:Describe*"
                Resource: "*"
              - Effect: "Allow"
                Action: "ec2:AttachVolume"
                Resource: "*"
              - Effect: "Allow"
                Action: "ec2:DetachVolume"
                Resource: "*"
              - Effect: "Allow"
                Action: "s3:GetObject"
                Resource: "*"
  BootstrapRoleAdditionalPolicy:
    Type: AWS::IAM::ManagedPolicy
    Properties:
      Description: "ec2DefaultRoleAdditionalPolicy"
      ManagedPolicyName: !Sub dev-sample-BootstrapRoleAdditionalPolicy
      PolicyDocument:
        Version: 2012-10-17
        Statement:
          - Sid: VisualEditor0
            Effect: Allow
            Action: secretsmanager:GetRandomPassword
            Resource: "*"
          - Sid: VisualEditor1
            Effect: Allow
            Action: s3:*
            Resource: "*"
          - Sid: VisualEditor2
            Effect: Allow
            Action: ssm:GetParameter
            Resource: "*"
      Roles:
        - !Ref BootstrapIamRole
  BootstrapInstanceProfile:
    Type: AWS::IAM::InstanceProfile
    Properties:
      Path: "/"
      Roles:
        - Ref: "BootstrapIamRole"
  MasterIamRole:
    Type: AWS::IAM::Role
    Properties:
      ManagedPolicyArns:
        - !Sub arn:${AWS::Partition}:iam::aws:policy/service-role/AmazonEFSCSIDriverPolicy
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: "Allow"
            Principal:
              Service:
                - "ec2.amazonaws.com"
            Action:
              - "sts:AssumeRole"
      Policies:
        - PolicyName:
            !Join [
              "-",
              ["ocp", "sample", "cp", "policy"],
            ]
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: "Allow"
                Action:
                  - "ssm:GetParameter"
                  - "ec2:AttachVolume"
                  - "ec2:AuthorizeSecurityGroupIngress"
                  - "ec2:CreateSecurityGroup"
                  - "ec2:CreateTags"
                  - "ec2:CreateVolume"
                  - "ec2:DeleteSecurityGroup"
                  - "ec2:DeleteVolume"
                  - "ec2:Describe*"
                  - "ec2:DetachVolume"
                  - "ec2:ModifyInstanceAttribute"
                  - "ec2:ModifyVolume"
                  - "ec2:RevokeSecurityGroupIngress"
                  - "elasticloadbalancing:AddTags"
                  - "elasticloadbalancing:AttachLoadBalancerToSubnets"
                  - "elasticloadbalancing:ApplySecurityGroupsToLoadBalancer"
                  - "elasticloadbalancing:CreateListener"
                  - "elasticloadbalancing:CreateLoadBalancer"
                  - "elasticloadbalancing:CreateLoadBalancerPolicy"
                  - "elasticloadbalancing:CreateLoadBalancerListeners"
                  - "elasticloadbalancing:CreateTargetGroup"
                  - "elasticloadbalancing:ConfigureHealthCheck"
                  - "elasticloadbalancing:DeleteListener"
                  - "elasticloadbalancing:DeleteLoadBalancer"
                  - "elasticloadbalancing:DeleteLoadBalancerListeners"
                  - "elasticloadbalancing:DeleteTargetGroup"
                  - "elasticloadbalancing:DeregisterInstancesFromLoadBalancer"
                  - "elasticloadbalancing:DeregisterTargets"
                  - "elasticloadbalancing:Describe*"
                  - "elasticloadbalancing:DetachLoadBalancerFromSubnets"
                  - "elasticloadbalancing:ModifyListener"
                  - "elasticloadbalancing:ModifyLoadBalancerAttributes"
                  - "elasticloadbalancing:ModifyTargetGroup"
                  - "elasticloadbalancing:ModifyTargetGroupAttributes"
                  - "elasticloadbalancing:RegisterInstancesWithLoadBalancer"
                  - "elasticloadbalancing:RegisterTargets"
                  - "elasticloadbalancing:SetLoadBalancerPoliciesForBackendServer"
                  - "elasticloadbalancing:SetLoadBalancerPoliciesOfListener"
                  - "kms:DescribeKey"
                  - "secretsmanager:GetResourcePolicy"
                  - "secretsmanager:GetSecretValue"
                  - "secretsmanager:DescribeSecret"
                  - "secretsmanager:ListSecretVersionIds"
                Resource: "*"
        - PolicyName:
            !Join [
              "-",
              ["ocp", "sample", "cp", "policy", "s3"],
            ]
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: "Allow"
                Action:
                  - "s3:PutObject"
                Resource: !Sub arn:${AWS::Partition}:s3:::sample-sample-prod-dev-ocp/*
  MasterRoleAdditionalPolicy:
    Type: AWS::IAM::ManagedPolicy
    Properties:
      Description: "ec2DefaultRoleAdditionalPolicy"
      ManagedPolicyName: !Sub dev-sample-MasterRoleAdditionalPolicy
      PolicyDocument:
        Version: 2012-10-17
        Statement:
          - Sid: VisualEditor0
            Effect: Allow
            Action: secretsmanager:GetRandomPassword
            Resource: "*"
          - Sid: VisualEditor1
            Effect: Allow
            Action: s3:*
            Resource: "*"
          - Sid: VisualEditor2
            Effect: Allow
            Action: ssm:GetParameter
            Resource: "*"
      Roles:
        - !Ref MasterIamRole
  MasterInstanceProfile:
    Type: AWS::IAM::InstanceProfile
    Properties:
      Roles:
        - Ref: "MasterIamRole"
  WorkerIamRole:
    Type: AWS::IAM::Role
    Properties:
      ManagedPolicyArns:
        - !Sub arn:${AWS::Partition}:iam::aws:policy/service-role/AmazonEFSCSIDriverPolicy
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: "Allow"
            Principal:
              Service:
                - "ec2.amazonaws.com"
            Action:
              - "sts:AssumeRole"
      Policies:
        - PolicyName:
            !Join ["-", ["sample", "worker", "policy"]]
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: "Allow"
                Action:
                  - "ec2:DescribeInstances"
                  - "ec2:DescribeRegions"
                Resource: "*"
  WorkerRoleAdditionalPolicy:
    Type: AWS::IAM::ManagedPolicy
    Properties:
      Description: "ec2DefaultRoleAdditionalPolicy"
      ManagedPolicyName: !Sub dev-sample-WorkerRoleAdditionalPolicy
      PolicyDocument:
        Version: 2012-10-17
        Statement:
          - Sid: VisualEditor0
            Effect: Allow
            Action: secretsmanager:GetRandomPassword
            Resource: "*"
          - Sid: VisualEditor1
            Effect: Allow
            Action: s3:*
            Resource: "*"
          - Sid: VisualEditor2
            Effect: Allow
            Action: ssm:GetParameter
            Resource: "*"
      Roles:
        - !Ref WorkerIamRole
  WorkerInstanceProfile:
    Type: AWS::IAM::InstanceProfile
    Properties:
      Roles:
        - Ref: "WorkerIamRole"
## OCP EC2
# Bootstrap
  Boot:
    Condition: DeployBootstrap
    Type: AWS::EC2::Instance
    Properties:
      LaunchTemplate:
        LaunchTemplateId: !Ref BootstrapRHCOSLaunchTemplate
        Version: !GetAtt BootstrapRHCOSLaunchTemplate.LatestVersionNumber
      IamInstanceProfile: !Ref BootstrapInstanceProfile
      InstanceType: t3.xlarge
      SubnetId: !Ref PrivateSubnet0
      PrivateIpAddress: "10.30.6.186"
      SecurityGroupIds:
        - !GetAtt BootstrapSecurityGroup.GroupId
      Tags:
        - Key: ec2DailyStart
          Value: !Ref pEc2DailyStart
        - Key: ec2DailyStop
          Value: !Ref pEc2DailyStop
        - Key: Name
          Value: !Sub "sample-ocp-boot.sample.dev.dev"
# Master (Master)
  Master1:
    Condition: DeployMasters
    Type: AWS::EC2::Instance
    Properties:
      LaunchTemplate:
        LaunchTemplateId: !Ref MasterRHCOSLaunchTemplate
        Version: !GetAtt MasterRHCOSLaunchTemplate.LatestVersionNumber
      IamInstanceProfile: !Ref MasterInstanceProfile
      InstanceType: t3.xlarge
      SubnetId: !Ref PrivateSubnet0
      PrivateIpAddress: "10.30.6.182"
      SecurityGroupIds:
        - !GetAtt MasterSecurityGroup.GroupId
      Tags:
        - Key: ec2DailyStart
          Value: !Ref pEc2DailyStart
        - Key: ec2DailyStop
          Value: !Ref pEc2DailyStop
        - Key: Name
          Value: !Sub "sample-ocp-master1.sample.dev.dev"
  Master2:
    Condition: DeployMasters
    Type: AWS::EC2::Instance
    Properties:
      LaunchTemplate:
        LaunchTemplateId: !Ref MasterRHCOSLaunchTemplate
        Version: !GetAtt MasterRHCOSLaunchTemplate.LatestVersionNumber
      IamInstanceProfile: !Ref MasterInstanceProfile
      InstanceType: t3.xlarge
      SubnetId: !Ref PrivateSubnet0
      PrivateIpAddress: "10.30.6.172"
      SecurityGroupIds:
        - !GetAtt MasterSecurityGroup.GroupId
      Tags:
        - Key: ec2DailyStart
          Value: !Ref pEc2DailyStart
        - Key: ec2DailyStop
          Value: !Ref pEc2DailyStop
        - Key: Name
          Value: !Sub "sample-ocp-master2.sample.dev.dev"
  Master3:
    Condition: DeployMasters
    Type: AWS::EC2::Instance
    Properties:
      LaunchTemplate:
        LaunchTemplateId: !Ref MasterRHCOSLaunchTemplate
        Version: !GetAtt MasterRHCOSLaunchTemplate.LatestVersionNumber
      IamInstanceProfile: !Ref MasterInstanceProfile
      InstanceType: t3.xlarge
      SubnetId: !Ref PrivateSubnet0
      PrivateIpAddress: "10.30.6.166"
      SecurityGroupIds:
        - !GetAtt MasterSecurityGroup.GroupId
      Tags:
        - Key: ec2DailyStart
          Value: !Ref pEc2DailyStart
        - Key: ec2DailyStop
          Value: !Ref pEc2DailyStop
        - Key: Name
          Value: !Sub "sample-ocp-master3.sample.dev.dev"
# Worker
  Worker1:
    Condition: DeployWorkers
    Type: AWS::EC2::Instance
    Properties:
      LaunchTemplate:
        LaunchTemplateId: !Ref WorkerRHCOSLaunchTemplate
        Version: !GetAtt WorkerRHCOSLaunchTemplate.LatestVersionNumber
      IamInstanceProfile: !Ref WorkerInstanceProfile
      InstanceType: t3.2xlarge
      SubnetId: !Ref PrivateSubnet0
      PrivateIpAddress: "10.30.6.190"
      SecurityGroupIds:
        - !GetAtt WorkerSecurityGroup.GroupId
      Tags:
        - Key: ec2DailyStart
          Value: !Ref pEc2DailyStart
        - Key: ec2DailyStop
          Value: !Ref pEc2DailyStop
        - Key: Name
          Value: !Sub "sample-ocp-worker1.sample.dev.dev"
  Worker2:
    Condition: DeployWorkers
    Type: AWS::EC2::Instance
    Properties:
      LaunchTemplate:
        LaunchTemplateId: !Ref WorkerRHCOSLaunchTemplate
        Version: !GetAtt WorkerRHCOSLaunchTemplate.LatestVersionNumber
      IamInstanceProfile: !Ref WorkerInstanceProfile
      InstanceType: t3.2xlarge
      SubnetId: !Ref PrivateSubnet0
      PrivateIpAddress: "10.30.6.175"
      SecurityGroupIds:
        - !GetAtt WorkerSecurityGroup.GroupId
      Tags:
        - Key: ec2DailyStart
          Value: !Ref pEc2DailyStart
        - Key: ec2DailyStop
          Value: !Ref pEc2DailyStop
        - Key: Name
          Value: !Sub "sample-ocp-worker2.sample.dev.dev"
  Worker3:
    Condition: DeployWorkers
    Type: AWS::EC2::Instance
    Properties:
      LaunchTemplate:
        LaunchTemplateId: !Ref WorkerRHCOSLaunchTemplate
        Version: !GetAtt WorkerRHCOSLaunchTemplate.LatestVersionNumber
      IamInstanceProfile: !Ref WorkerInstanceProfile
      InstanceType: t3.2xlarge
      SubnetId: !Ref PrivateSubnet0
      PrivateIpAddress: "10.30.6.167"
      SecurityGroupIds:
        - !GetAtt WorkerSecurityGroup.GroupId
      Tags:
        - Key: ec2DailyStart
          Value: !Ref pEc2DailyStart
        - Key: ec2DailyStop
          Value: !Ref pEc2DailyStop
        - Key: Name
          Value: !Sub "sample-ocp-worker3.sample.dev.dev"
  Worker4:
    Condition: DeployWorkers
    Type: AWS::EC2::Instance
    Properties:
      LaunchTemplate:
        LaunchTemplateId: !Ref WorkerRHCOSLaunchTemplate
        Version: !GetAtt WorkerRHCOSLaunchTemplate.LatestVersionNumber
      IamInstanceProfile: !Ref WorkerInstanceProfile
      InstanceType: t3.2xlarge
      SubnetId: !Ref PrivateSubnet0
      PrivateIpAddress: "10.30.6.185"
      SecurityGroupIds:
        - !GetAtt WorkerSecurityGroup.GroupId
      Tags:
        - Key: ec2DailyStart
          Value: !Ref pEc2DailyStart
        - Key: ec2DailyStop
          Value: !Ref pEc2DailyStop
        - Key: Name
          Value: !Sub "sample-ocp-worker4.sample.dev.dev"
  Worker5:
    Condition: DeployWorkers
    Type: AWS::EC2::Instance
    Properties:
      LaunchTemplate:
        LaunchTemplateId: !Ref WorkerRHCOSLaunchTemplate
        Version: !GetAtt WorkerRHCOSLaunchTemplate.LatestVersionNumber
      IamInstanceProfile: !Ref WorkerInstanceProfile
      InstanceType: t3.2xlarge
      SubnetId: !Ref PrivateSubnet0
      PrivateIpAddress: "10.30.6.168"
      SecurityGroupIds:
        - !GetAtt WorkerSecurityGroup.GroupId
      Tags:
        - Key: ec2DailyStart
          Value: !Ref pEc2DailyStart
        - Key: ec2DailyStop
          Value: !Ref pEc2DailyStop
        - Key: Name
          Value: !Sub "sample-ocp-worker5.sample.dev.dev"
  Worker6:
    Condition: DeployWorkers
    Type: AWS::EC2::Instance
    Properties:
      LaunchTemplate:
        LaunchTemplateId: !Ref WorkerRHCOSLaunchTemplate
        Version: !GetAtt WorkerRHCOSLaunchTemplate.LatestVersionNumber
      IamInstanceProfile: !Ref WorkerInstanceProfile
      InstanceType: t3.2xlarge
      SubnetId: !Ref PrivateSubnet0
      PrivateIpAddress: "10.30.6.179"
      SecurityGroupIds:
        - !GetAtt WorkerSecurityGroup.GroupId
      Tags:
        - Key: ec2DailyStart
          Value: !Ref pEc2DailyStart
        - Key: ec2DailyStop
          Value: !Ref pEc2DailyStop
        - Key: Name
          Value: !Sub "sample-ocp-worker6.sample.dev.dev"
# Dependencies
  Registry1:
    Condition: DeployAuxNodes
    Type: AWS::EC2::Instance
    Properties:
      LaunchTemplate:
        LaunchTemplateId: !Ref DefaultLinuxLaunchTemplate
        Version: !GetAtt DefaultLinuxLaunchTemplate.LatestVersionNumber
      IamInstanceProfile: !Ref iamProfileDefault
      InstanceType: t3.medium
      SubnetId: !Ref PrivateSubnet0
      PrivateIpAddress: "10.30.6.181"
      BlockDeviceMappings:
        - DeviceName: /dev/sda1
          Ebs:
            VolumeType: gp3
            DeleteOnTermination: "true"
            VolumeSize: "500"
      SecurityGroupIds:
        - !GetAtt DefaultSecurityGroup.GroupId
      Tags:
        - Key: ec2DailyStart
          Value: !Ref pEc2DailyStart
        - Key: ec2DailyStop
          Value: !Ref pEc2DailyStop
        - Key: Name
          Value: !Sub "sample-ocp-reg.sample.dev.dev"
  NFS1:
    Condition: DeployAuxNodes
    Type: AWS::EC2::Instance
    Properties:
      LaunchTemplate:
        LaunchTemplateId: !Ref DefaultLinuxLaunchTemplate
        Version: !GetAtt DefaultLinuxLaunchTemplate.LatestVersionNumber
      IamInstanceProfile: !Ref iamProfileDefault
      InstanceType: t3.medium
      SubnetId: !Ref PrivateSubnet0
      PrivateIpAddress: "10.30.6.165"
      BlockDeviceMappings:
        - DeviceName: /dev/sda1
          Ebs:
            VolumeType: gp3
            DeleteOnTermination: "true"
            VolumeSize: "300"
        - DeviceName: /dev/sdb
          Ebs:
            VolumeType: gp3
            DeleteOnTermination: "true"
            VolumeSize: "2000"
      SecurityGroupIds:
        - !GetAtt DefaultSecurityGroup.GroupId
      Tags:
        - Key: ec2DailyStart
          Value: !Ref pEc2DailyStart
        - Key: ec2DailyStop
          Value: !Ref pEc2DailyStop
        - Key: Name
          Value: !Sub "sample-ocp-nfs.sample.dev.dev"
  API1:
    Condition: DeployAuxNodes
    Type: AWS::EC2::Instance
    Properties:
      LaunchTemplate:
        LaunchTemplateId: !Ref DefaultLinuxLaunchTemplate
        Version: !GetAtt DefaultLinuxLaunchTemplate.LatestVersionNumber
      IamInstanceProfile: !Ref iamProfileDefault
      InstanceType: t3.large
      SubnetId: !Ref PrivateSubnet0
      PrivateIpAddress: "10.30.6.183"
      SecurityGroupIds:
        - !GetAtt DefaultSecurityGroup.GroupId
      Tags:
        - Key: ec2DailyStart
          Value: !Ref pEc2DailyStart
        - Key: ec2DailyStop
          Value: !Ref pEc2DailyStop
        - Key: Name
          Value: !Sub "sample-ocp-api.sample.dev.dev"
  Ingress1:
    Condition: DeployAuxNodes
    Type: AWS::EC2::Instance
    Properties:
      LaunchTemplate:
        LaunchTemplateId: !Ref DefaultLinuxLaunchTemplate
        Version: !GetAtt DefaultLinuxLaunchTemplate.LatestVersionNumber
      IamInstanceProfile: !Ref iamProfileDefault
      InstanceType: t3.large
      SubnetId: !Ref PrivateSubnet0
      PrivateIpAddress: "10.30.6.176"
      SecurityGroupIds:
        - !GetAtt DefaultSecurityGroup.GroupId
      Tags:
        - Key: ec2DailyStart
          Value: !Ref pEc2DailyStart
        - Key: ec2DailyStop
          Value: !Ref pEc2DailyStop
        - Key: Name
          Value: !Sub "sample-ocp-ingress.sample.dev.dev"
## Aux EC2
  Management1:
    Condition: DeployManagementNode
    Type: AWS::EC2::Instance
    Properties:
      LaunchTemplate:
        LaunchTemplateId: !Ref DefaultLinuxLaunchTemplate
        Version: !GetAtt DefaultLinuxLaunchTemplate.LatestVersionNumber
      IamInstanceProfile: !Ref iamProfileManagement
      InstanceType: t3.2xlarge
      SubnetId: !Ref PrivateSubnet0
      PrivateIpAddress: "10.30.6.177"
      ImageId: !Ref psampleMGMTAMIId
      BlockDeviceMappings:
        - DeviceName: /dev/sda1
          Ebs:
            VolumeType: gp3
            DeleteOnTermination: "true"
            VolumeSize: "1100"
      SecurityGroupIds:
        - !GetAtt DefaultSecurityGroup.GroupId
      Tags:
        - Key: ec2DailyStart
          Value: !Ref pEc2DailyStart
        - Key: ec2DailyStop
          Value: !Ref pEc2DailyStop
        - Key: Name
          Value: !Sub "sample-mgmt.sample.dev.dev"
  Security1:
    Condition: DeployAuxNodes
    Type: AWS::EC2::Instance
    Properties:
      LaunchTemplate:
        LaunchTemplateId: !Ref DefaultLinuxLaunchTemplate
        Version: !GetAtt DefaultLinuxLaunchTemplate.LatestVersionNumber
      IamInstanceProfile: !Ref iamProfileDefault
      InstanceType: t3.xlarge
      SubnetId: !Ref PrivateSubnet0
      PrivateIpAddress: "10.30.6.188"
      BlockDeviceMappings:
        - DeviceName: /dev/sda1
          Ebs:
            VolumeType: gp3
            DeleteOnTermination: "true"
            VolumeSize: "400"
      SecurityGroupIds:
        - !GetAtt DefaultSecurityGroup.GroupId
      Tags:
        - Key: ec2DailyStart
          Value: !Ref pEc2DailyStart
        - Key: ec2DailyStop
          Value: !Ref pEc2DailyStop
        - Key: Name
          Value: !Sub "sample-security.sample.dev.dev"
  Securitysample:
    Type: AWS::EC2::Instance
    Properties:
      LaunchTemplate:
        LaunchTemplateId: !Ref RHEL8DefaultLinuxLaunchTemplate
        Version: !GetAtt RHEL8DefaultLinuxLaunchTemplate.LatestVersionNumber
      InstanceType: t3.large
      KeyName: !Ref DefaultKey
      SubnetId: !Ref PrivateSubnet0
      SecurityGroupIds:
        - Ref: DefaultSecurityGroup
      Tags:
        - Key: "deploymentType"
          Value: sample
        - Key: "sampleDeploymentNumber"
          Value: !Sub sample${pDeploymentNumber}
        - Key: Name
          Value: !Sub "sec.sample.edge.dev.dev"
        - Key: ec2DailyStop
          Value: !Ref pEc2DailyStop
        - Key: ec2DailyStart
          Value: !Ref pEc2DailyStart
  Logging1:
    Condition: DeployAuxNodes
    Type: AWS::EC2::Instance
    Properties:
      LaunchTemplate:
        LaunchTemplateId: !Ref DefaultLinuxLaunchTemplate
        Version: !GetAtt DefaultLinuxLaunchTemplate.LatestVersionNumber
      IamInstanceProfile: !Ref iamProfileDefault
      InstanceType: t3.2xlarge
      SubnetId: !Ref PrivateSubnet0
      PrivateIpAddress: "10.30.6.187"
      BlockDeviceMappings:
        - DeviceName: /dev/sda1
          Ebs:
            VolumeType: gp3
            DeleteOnTermination: "true"
            VolumeSize: "2500"
        - DeviceName: /dev/sdb
          Ebs:
            VolumeType: gp3
            DeleteOnTermination: "true"
            VolumeSize: "2000"
        - DeviceName: /dev/sdc
          Ebs:
            VolumeType: gp3
            DeleteOnTermination: "true"
            VolumeSize: "50"
      SecurityGroupIds:
        - !GetAtt DefaultSecurityGroup.GroupId
      Tags:
        - Key: ec2DailyStart
          Value: !Ref pEc2DailyStart
        - Key: ec2DailyStop
          Value: !Ref pEc2DailyStop
        - Key: Name
          Value: !Sub "sample-logging.sample.dev.dev"
  Proxy1:
    Condition: DeployAuxNodes
    Type: AWS::EC2::Instance
    Properties:
      LaunchTemplate:
        LaunchTemplateId: !Ref DefaultLinuxLaunchTemplate
        Version: !GetAtt DefaultLinuxLaunchTemplate.LatestVersionNumber
      IamInstanceProfile: !Ref iamProfileDefault
      InstanceType: t3.medium
      SubnetId: !Ref PrivateSubnet0
      PrivateIpAddress: "10.30.6.170"
      SecurityGroupIds:
        - !GetAtt DefaultSecurityGroup.GroupId
      Tags:
        - Key: ec2DailyStart
          Value: !Ref pEc2DailyStart
        - Key: ec2DailyStop
          Value: !Ref pEc2DailyStop
        - Key: Name
          Value: !Sub "sample-proxy.sample.dev.dev"
## Route53
# Bootstrap
  BootEC2HostRoute53Record:
    Type: AWS::Route53::RecordSet
    Properties:
      HostedZoneId:  !Sub "{{resolve:ssm:/sample/route53/dev-dev/id}}"
      Name: !Sub "sample-ocp-boot.sample.dev.dev"
      ResourceRecords:
        - 10.30.6.186
      TTL: 900
      Type: A
# Master
  Master1EC2HostRoute53Record:
    Type: AWS::Route53::RecordSet
    Properties:
      HostedZoneId:  !Sub "{{resolve:ssm:/sample/route53/dev-dev/id}}"
      Name: !Sub "sample-ocp-master1.sample.dev.dev"
      ResourceRecords:
        - 10.30.6.182
      TTL: 900
      Type: A
  Master2EC2HostRoute53Record:
    Type: AWS::Route53::RecordSet
    Properties:
      HostedZoneId:  !Sub "{{resolve:ssm:/sample/route53/dev-dev/id}}"
      Name: !Sub "sample-ocp-master2.sample.dev.dev"
      ResourceRecords:
        - 10.30.6.172
      TTL: 900
      Type: A
  Master3EC2HostRoute53Record:
    Type: AWS::Route53::RecordSet
    Properties:
      HostedZoneId:  !Sub "{{resolve:ssm:/sample/route53/dev-dev/id}}"
      Name: !Sub "sample-ocp-master3.sample.dev.dev"
      ResourceRecords:
        - 10.30.6.166
      TTL: 900
      Type: A
# Worker
  Worker1EC2HostRoute53Record:
    Type: AWS::Route53::RecordSet
    Properties:
      HostedZoneId:  !Sub "{{resolve:ssm:/sample/route53/dev-dev/id}}"
      Name: !Sub "sample-ocp-worker1.sample.dev.dev"
      ResourceRecords:
        - 10.30.6.190
      TTL: 900
      Type: A
  Worker2EC2HostRoute53Record:
    Type: AWS::Route53::RecordSet
    Properties:
      HostedZoneId:  !Sub "{{resolve:ssm:/sample/route53/dev-dev/id}}"
      Name: !Sub "sample-ocp-worker2.sample.dev.dev"
      ResourceRecords:
        - 10.30.6.175
      TTL: 900
      Type: A
  Worker3EC2HostRoute53Record:
    Type: AWS::Route53::RecordSet
    Properties:
      HostedZoneId:  !Sub "{{resolve:ssm:/sample/route53/dev-dev/id}}"
      Name: !Sub "sample-ocp-worker3.sample.dev.dev"
      ResourceRecords:
        - 10.30.6.167
      TTL: 900
      Type: A
  Worker4EC2HostRoute53Record:
    Type: AWS::Route53::RecordSet
    Properties:
      HostedZoneId:  !Sub "{{resolve:ssm:/sample/route53/dev-dev/id}}"
      Name: !Sub "sample-ocp-worker4.sample.dev.dev"
      ResourceRecords:
        - 10.30.6.185
      TTL: 900
      Type: A
  Worker5EC2HostRoute53Record:
    Type: AWS::Route53::RecordSet
    Properties:
      HostedZoneId:  !Sub "{{resolve:ssm:/sample/route53/dev-dev/id}}"
      Name: !Sub "sample-ocp-worker5.sample.dev.dev"
      ResourceRecords:
        - 10.30.6.168
      TTL: 900
      Type: A
  Worker6EC2HostRoute53Record:
    Type: AWS::Route53::RecordSet
    Properties:
      HostedZoneId:  !Sub "{{resolve:ssm:/sample/route53/dev-dev/id}}"
      Name: !Sub "sample-ocp-worker6.sample.dev.dev"
      ResourceRecords:
        - 10.30.6.179
      TTL: 900
      Type: A
# Dependencies
  Registry1EC2HostRoute53Record:
    Condition: DeployAuxNodes
    Type: AWS::Route53::RecordSet
    Properties:
      HostedZoneId:  !Sub "{{resolve:ssm:/sample/route53/dev-dev/id}}"
      Name: !Sub "sample-ocp-reg.sample.dev.dev"
      ResourceRecords:
        - !GetAtt Registry1.PrivateIp
      TTL: 900
      Type: A
  NFS1EC2HostRoute53Record:
    Condition: DeployAuxNodes
    Type: AWS::Route53::RecordSet
    Properties:
      HostedZoneId:  !Sub "{{resolve:ssm:/sample/route53/dev-dev/id}}"
      Name: !Sub "sample-ocp-nfs.sample.dev.dev"
      ResourceRecords:
        - !GetAtt NFS1.PrivateIp
      TTL: 900
      Type: A
  API1EC2HostRoute53Record:
    Condition: DeployAuxNodes
    Type: AWS::Route53::RecordSet
    Properties:
      HostedZoneId:  !Sub "{{resolve:ssm:/sample/route53/dev-dev/id}}"
      Name: !Sub "sample-ocp-api.sample.dev.dev"
      ResourceRecords:
        - !GetAtt API1.PrivateIp
      TTL: 900
      Type: A
  Ingress1EC2HostRoute53Record:
    Condition: DeployAuxNodes
    Type: AWS::Route53::RecordSet
    Properties:
      HostedZoneId:  !Sub "{{resolve:ssm:/sample/route53/dev-dev/id}}"
      Name: !Sub "sample-ocp-ingress.sample.dev.dev"
      ResourceRecords:
        - !GetAtt Ingress1.PrivateIp
      TTL: 900
      Type: A
## Aux
  Management1EC2HostRoute53Record:
    Condition: DeployManagementNode
    Type: AWS::Route53::RecordSet
    Properties:
      HostedZoneId:  !Sub "{{resolve:ssm:/sample/route53/dev-dev/id}}"
      Name: !Sub "sample-mgmt.sample.dev.dev"
      ResourceRecords:
        - !GetAtt Management1.PrivateIp
      TTL: 900
      Type: A
  Security1EC2HostRoute53Record:
    Condition: DeployAuxNodes
    Type: AWS::Route53::RecordSet
    Properties:
      HostedZoneId:  !Sub "{{resolve:ssm:/sample/route53/dev-dev/id}}"
      Name: !Sub "sample-security.sample.dev.dev"
      ResourceRecords:
        - !GetAtt Security1.PrivateIp
      TTL: 900
      Type: A
  SecuritysampleEC2HostRoute53Record:
    Type: AWS::Route53::RecordSet
    Properties:
      HostedZoneId: !Sub "{{resolve:ssm:/sample/route53/dev-dev/id}}"
      Name: !Sub "sec.sample.edge.dev.dev"
      ResourceRecords:
        - !GetAtt Securitysample.PrivateIp
      TTL: 900
      Type: A
  Logging1EC2HostRoute53Record:
    Condition: DeployAuxNodes
    Type: AWS::Route53::RecordSet
    Properties:
      HostedZoneId:  !Sub "{{resolve:ssm:/sample/route53/dev-dev/id}}"
      Name: !Sub "sample-logging.sample.dev.dev"
      ResourceRecords:
        - !GetAtt Logging1.PrivateIp
      TTL: 900
      Type: A
  Proxy1EC2HostRoute53Record:
    Condition: DeployAuxNodes
    Type: AWS::Route53::RecordSet
    Properties:
      HostedZoneId:  !Sub "{{resolve:ssm:/sample/route53/dev-dev/id}}"
      Name: !Sub "sample-proxy.sample.dev.dev"
      ResourceRecords:
        - !GetAtt Proxy1.PrivateIp
      TTL: 900
      Type: A
#CNAME
  APPS1EC2HostRoute53RecordCNAME:
    Type: AWS::Route53::RecordSet
    Properties:
      HostedZoneId:  !Sub "{{resolve:ssm:/sample/route53/dev-dev/id}}"
      Name: !Sub "*.apps.sample.dev.dev"
      ResourceRecords:
        -  !Sub "sample-ocp-ingress.sample.dev.dev"
      TTL: 900
      Type: CNAME
  APPS2EC2HostRoute53RecordCNAME:
    Type: AWS::Route53::RecordSet
    Properties:
      HostedZoneId:  !Sub "{{resolve:ssm:/sample/route53/dev-dev/id}}"
      Name: !Sub "*.apps.sample.ocp.dev.dev"
      ResourceRecords:
        -  !Sub "sample-ocp-ingress.sample.dev.dev"
      TTL: 900
      Type: CNAME
  APIS1EC2HostRoute53RecordCNAME:
    Type: AWS::Route53::RecordSet
    Properties:
      HostedZoneId:  !Sub "{{resolve:ssm:/sample/route53/dev-dev/id}}"
      Name:  !Sub "api-int.sample.dev.dev"
      ResourceRecords:
        - !Sub "sample-ocp-api.sample.dev.dev"
      TTL: 900
      Type: CNAME
  API2EC2HostRoute53RecordCNAME:
    Type: AWS::Route53::RecordSet
    Properties:
      HostedZoneId:  !Sub "{{resolve:ssm:/sample/route53/dev-dev/id}}"
      Name: !Sub "api.sample.dev.dev"
      ResourceRecords:
        - !Sub "sample-ocp-api.sample.dev.dev"
      TTL: 900
      Type: CNAME
Outputs:
  sampleEC2KeyParameter:
    Value: !Sub "/ec2/keypair/${DefaultKey.KeyPairId}"
