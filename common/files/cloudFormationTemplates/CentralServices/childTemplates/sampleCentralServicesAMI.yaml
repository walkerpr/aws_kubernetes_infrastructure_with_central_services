Parameters:
  pSAMPLEEnv:
    Type: String
    Description: Production? Test?
    AllowedValues:
      - prod
      - test
  pRHELIAMIId:
    Type: AWS::EC2::Image::Id
    Description: The baseline AMI ID.
  pALMsampleMIId:
    Type: AWS::EC2::Image::Id
    Description: The baseline AMI ID.
  pRHEL9IAMIId:
    Type: AWS::EC2::Image::Id
    Description: The baseline AMI ID (used for the other central services EC2s)
  pRHEL10IAMIId:
    Type: AWS::EC2::Image::Id
    Description: The baseline AMI ID (used for the other central services EC2s)
  pAWSAMIId:
    Type: String
    Description: The baseline AMI ID.
  pUbuntuAMIId:
    Type: AWS::EC2::Image::Id
    Description: The baseline Ubuntu image ID.
  pEnvironment:
    Type: String
    Description: Development? Test Upstream? Prod Upstream?
    AllowedValues:
      - dev
      - upprod
      - uptest
  pInstanceType:
    Description: EC2 instance type
    Type: String
    AllowedValues:
      - c4.xlarge
      - c4.2xlarge
      - c4.4xlarge
      - c5.large
      - c5.xlarge
      - c5.2xlarge
      - c5.4xlarge
      - c5n.large
      - c5n.xlarge
      - c5n.2xlarge
      - c5n.4xlarge
      - c6i.large
      - c6i.xlarge
      - c6in.2xlarge
      - c6in.4xlarge
      - m4.large
      - m4.xlarge
      - m4.2xlarge
      - m4.4xlarge
      - m5.large
      - m5.xlarge
      - m5.2xlarge
      - m5.4xlarge
      - m5n.large
      - m5n.xlarge
      - m5n.2xlarge
      - m5n.4xlarge
      - m6i.xlarge
      - r4.large
      - r4.xlarge
      - r5.large
      - r5.xlarge
      - r6i.xlarge
      - r6i.2xlarge
      - r6i.4xlarge
      - r6i.8xlarge
      - r6i.12xlarge
      - r6in.xlarge
      - r6in.2xlarge
      - r6in.4xlarge
      - r6in.8xlarge
      - r6in.12xlarge
      - r7i.large
      - r7i.xlarge
      - t2.small (Testing / Not for Production Use)
      - t2.medium
      - t2.large
      - t3.small (Testing / Not for Production Use)
      - t3.medium
      - t3.large
      - t3.xlarge
      - t3.2xlarge
      - t3a.medium
    ConstraintDescription: Please choose a valid EC2 instance type
  pArmInstanceType:
    Type: String
Conditions:
  DevEnvironment: !Equals
    - !Ref pEnvironment
    - "dev"
Resources:
  ec2DefaultKey:
    Type: AWS::EC2::KeyPair
    Properties:
      KeyName: sample-ami-builder
      KeyFormat: pem
      KeyType: rsa
  imageEC2HostSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Enable access to SSH on port 22
      VpcId: !Sub "{{resolve:ssm:/sample/vpc/sample-${pEnvironment}-${pSAMPLEEnv}-vpc/id}}"
      SecurityGroupIngress:
        - IpProtocol: -1
          SourcePrefixListId: !Sub "{{resolve:ssm:/sample/vpc/cidr/prefix}}"
  imageBuilderLogBucket:
    Type: AWS::S3::Bucket
    DeletionPolicy: Retain
    Properties:
      VersioningConfiguration:
        Status: Enabled
  imageInstanceRole:
    Type: AWS::IAM::Role
    Metadata:
      Comment: Role to be used by instance during image build.
    Properties:
      ManagedPolicyArns:
        - !Sub arn:${AWS::Partition}:iam::aws:policy/AmazonSSMManagedInstanceCore
        - !Sub arn:${AWS::Partition}:iam::aws:policy/EC2InstanceProfileForImageBuilder
      AssumeRolePolicyDocument:
        Statement:
          - Action:
              - sts:AssumeRole
            Effect: Allow
            Principal:
              Service:
                - !Sub "ec2.${AWS::URLSuffix}"
        Version: "2012-10-17"
      Path: /executionServiceEC2Role/
  imageInstanceRoleAdditionalPolicy:
    Type: AWS::IAM::ManagedPolicy
    Properties:
      Description: "imageInstanceRoleAdditionalPolicy"
      PolicyDocument:
        Version: 2012-10-17
        Statement:
          - Sid: VisualEditor0
            Effect: Allow
            Action:
              - ssm:DescribeParameters
              - ssm:GetParameters
              - ssm:GetParameter
            Resource: "*"
          - Sid: VisualEditor1
            Effect: Allow
            Action: secretsmanager:GetRandomPassword
            Resource: "*"
          - Sid: VisualEditor3
            Effect: Allow
            Action: s3:PutObject
            Resource: "*"
      Roles:
        - !Ref imageInstanceRole
  instanceRoleLoggingPolicy:
    Type: AWS::IAM::Policy
    Metadata:
      Comment: Allows the instance to save log files to an S3 bucket.
    Properties:
      PolicyName: !Sub imageBuilderLogPolicy
      Roles:
        - !Ref imageInstanceRole
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Action:
              - s3:PutObject
            Effect: Allow
            Resource:
              - !Sub
                - arn:${AWS::Partition}:s3:::${BUCKET}/*
                - BUCKET: !Ref imageBuilderLogBucket
  imageInstanceProfile:
    Type: AWS::IAM::InstanceProfile
    Properties:
      Path: /executionServiceEC2Role/
      Roles:
        - !Ref imageInstanceRole
  defaultImageComponentInstallPackages:
    Type: AWS::ImageBuilder::Component
    Properties:
      ChangeDescription: String
      Description: Installs packages from the Linux repository.
      Name: install-packages-from-repository
      Platform: Linux
      Version: 1.0.1
      Uri: !Sub s3://sample-${pSAMPLEEnv}-${pEnvironment}-cloud-formation-templates/supportingFiles/ec2ImageBuilderComponentFiles/installPackages.yaml
  defaultImageComponentSCAP:
    Type: AWS::ImageBuilder::Component
    Properties:
      ChangeDescription: String
      Description: Scap Scan Linux
      Name: !Sub scap-linux-sample
      Platform: Linux
      SupportedOsVersions:
        - "Amazon Linux 2023"
        - "Ubuntu 18"
        - "Ubuntu 20"
        - "Ubuntu 22"
        - "Ubuntu 24.04"
        - "Red Hat Enterprise Linux 7"
        - "Red Hat Enterprise Linux 8"
        - "Red Hat Enterprise Linux 9"
      Version: 1.0.7
      Uri: !Sub s3://sample-${pSAMPLEEnv}-${pEnvironment}-cloud-formation-templates/supportingFiles/ec2ImageBuilderComponentFiles/scapLinux.yaml
  defaultImageComponentNetSkope:
    Type: AWS::ImageBuilder::Component
    Properties:
      ChangeDescription: String
      Description: Netskope Cert Linux
      Name: !Sub netskope-linux-sample
      Platform: Linux
      Version: 1.0.9
      Uri: !Sub s3://sample-${pSAMPLEEnv}-${pEnvironment}-cloud-formation-templates/supportingFiles/ec2ImageBuilderComponentFiles/netskopeCert.yaml
  defaultImageComponentMirror:
    Type: AWS::ImageBuilder::Component
    Properties:
      ChangeDescription: String
      Description: SSM Mirror Install
      Name: !Sub mirror-linux-sample
      Platform: Linux
      Version: 1.0.8
      Uri: !Sub s3://sample-${pSAMPLEEnv}-${pEnvironment}-cloud-formation-templates/supportingFiles/ec2ImageBuilderComponentFiles/mirrorInstall.yaml
  defaultImageInfrastructureConfiguration:
    Type: AWS::ImageBuilder::InfrastructureConfiguration
    Properties:
      Name: !Sub baselineConfiguration
      SubnetId: !Sub "{{resolve:ssm:/sample/vpc/sample-${pEnvironment}-${pSAMPLEEnv}-vpc/sample-central-services-subnet/e/id}}"
      KeyPair: !Ref ec2DefaultKey
      InstanceTypes:
        - !Ref pInstanceType
      SecurityGroupIds:
        - !Ref imageEC2HostSecurityGroup
      InstanceProfileName: !Ref imageInstanceProfile
      Logging:
        S3Logs:
          S3BucketName: !Ref imageBuilderLogBucket
  defaultArmImageInfrastructureConfiguration:
    Type: AWS::ImageBuilder::InfrastructureConfiguration
    Properties:
      Name: !Sub baselineArmConfiguration
      SubnetId: !Sub "{{resolve:ssm:/sample/vpc/sample-${pEnvironment}-${pSAMPLEEnv}-vpc/sample-central-services-subnet/e/id}}"
      KeyPair: !Ref ec2DefaultKey
      InstanceTypes:
        - !Ref pArmInstanceType
      SecurityGroupIds:
        - !Ref imageEC2HostSecurityGroup
      InstanceProfileName: !Ref imageInstanceProfile
      Logging:
        S3Logs:
          S3BucketName: !Ref imageBuilderLogBucket
  defaultImageInfrastructureConfigurationParameter:
    Type: AWS::SSM::Parameter
    Properties:
      Description: Default image configuration
      Name: /sample/ec2/ami/default/configuration
      Type: String
      Value: !Ref defaultImageInfrastructureConfiguration
  defaultAmazonLinux2LogGroup:
    Type: AWS::Logs::LogGroup
    DeletionPolicy: Delete
    UpdateReplacePolicy: Delete
    Properties:
      LogGroupName: !Sub /aws/imagebuilder
      RetentionInDays: 3
  defaultAmazonLinuxImageRecipe:
    Type: AWS::ImageBuilder::ImageRecipe
    Properties:
      Name: !Sub Amazon-Linux-2023-Baseline
      Version: 0.0.9
      ParentImage: !Ref pAWSAMIId
      Components:
        - ComponentArn: !Ref defaultImageComponentNetSkope
        - ComponentArn: !Sub arn:${AWS::Partition}:imagebuilder:${AWS::Region}:aws:component/update-linux/1.0.2/1
        - ComponentArn: !Sub arn:${AWS::Partition}:imagebuilder:${AWS::Region}:aws:component/reboot-linux/1.0.1/1
        - ComponentArn: !Sub arn:${AWS::Partition}:imagebuilder:${AWS::Region}:aws:component/amazon-cloudwatch-agent-linux/1.0.1/1
        - ComponentArn: !Sub arn:${AWS::Partition}:imagebuilder:${AWS::Region}:aws:component/aws-cli-version-2-linux/1.0.4/1
        # - ComponentArn: !Sub arn:${AWS::Partition}:imagebuilder:${AWS::Region}:aws:component/stig-build-linux/1.0.4/1
        #   Parameters:
        #     - Name: Level
        #       Value:
        #         - "High"
        #     - Name: InstallPackages
        #       Value:
        #         - "Yes"
        #     - Name: SetDoDConsentBanner
        #       Value:
        #         - "Yes"
        - ComponentArn: !Ref defaultImageComponentInstallPackages
          Parameters:
            - Name: packageNames
              Value:
                - "python3.12,jq"
  defaultAmazonLinux2023Baseline:
    Type: AWS::ImageBuilder::Image
    UpdateReplacePolicy: Retain
    Properties:
      EnhancedImageMetadataEnabled: False
      ImageTestsConfiguration:
        ImageTestsEnabled: False
      ImageRecipeArn: !Ref defaultAmazonLinuxImageRecipe
      InfrastructureConfigurationArn: !Ref defaultImageInfrastructureConfiguration
  defaultAmazonLinux2023BaselineParameter:
    Type: AWS::SSM::Parameter
    UpdateReplacePolicy: Retain
    Properties:
      Description: Baseline Image for Amazon Linux 2023
      Name: !Join [ "/", [ "/sample/ec2/ami/AmazonLinux2023/baseline/ami", !Select [2, !Split [ "/",  !GetAtt defaultAmazonLinux2023Baseline.LatestVersion.Patch ] ], "id", ], ]
      Type: String
      Value: !GetAtt defaultAmazonLinux2023Baseline.ImageId
  defaultUbuntuImageRecipe:
    Type: AWS::ImageBuilder::ImageRecipe
    Properties:
      Name: Ubuntu-Baseline
      Version: 0.0.10
      ParentImage: !Ref pUbuntuAMIId
      Components:
        - ComponentArn: !Ref defaultImageComponentNetSkope
        - ComponentArn: !Sub arn:${AWS::Partition}:imagebuilder:${AWS::Region}:aws:component/update-linux/1.0.2/1
        - ComponentArn: !Sub arn:${AWS::Partition}:imagebuilder:${AWS::Region}:aws:component/reboot-linux/1.0.1/1
        - ComponentArn: !Sub arn:${AWS::Partition}:imagebuilder:${AWS::Region}:aws:component/amazon-cloudwatch-agent-linux/1.0.1/1
        - ComponentArn: !Sub arn:${AWS::Partition}:imagebuilder:${AWS::Region}:aws:component/aws-cli-version-2-linux/1.0.4/1
        # - ComponentArn: !Sub arn:${AWS::Partition}:imagebuilder:${AWS::Region}:aws:component/stig-build-linux/1.0.4/1
        #   Parameters:
        #     - Name: Level
        #       Value:
        #         - "High"
        #     - Name: InstallPackages
        #       Value:
        #         - "Yes"
        #     - Name: SetDoDConsentBanner
        #       Value:
        #         - "Yes"
        - ComponentArn: !Ref defaultImageComponentInstallPackages
          Parameters:
            - Name: packageNames
              Value:
                - "python3.12,jq"
  defaultUbuntu2023Baseline:
    Type: AWS::ImageBuilder::Image
    UpdateReplacePolicy: Retain
    Properties:
      EnhancedImageMetadataEnabled: False
      ImageTestsConfiguration:
        ImageTestsEnabled: False
      ImageRecipeArn: !Ref defaultUbuntuImageRecipe
      InfrastructureConfigurationArn: !Ref defaultImageInfrastructureConfiguration
  defaultUbuntu2023BaselineParameter:
    Type: AWS::SSM::Parameter
    UpdateReplacePolicy: Retain
    Properties:
      Description: Baseline Image for Ubuntu
      Name: !Join [ "/", [ "/sample/ec2/ami/UBUNTU/baseline/ami", !Select [2, !Split [ "/",  !GetAtt defaultUbuntu2023Baseline.LatestVersion.Patch ] ], "id", ], ]
      Type: String
      Value: !GetAtt defaultUbuntu2023Baseline.ImageId
  defaultRHELImageRecipe:
    Type: AWS::ImageBuilder::ImageRecipe
    Properties:
      Name: RHEL-Baseline
      Version: 0.0.8
      ParentImage: !Ref pRHELIAMIId
      Components:
        - ComponentArn: !Ref defaultImageComponentNetSkope
        - ComponentArn: !Sub arn:${AWS::Partition}:imagebuilder:${AWS::Region}:aws:component/update-linux/1.0.2/1
        - ComponentArn: !Sub arn:${AWS::Partition}:imagebuilder:${AWS::Region}:aws:component/reboot-linux/1.0.1/1
        - ComponentArn: !Sub arn:${AWS::Partition}:imagebuilder:${AWS::Region}:aws:component/amazon-cloudwatch-agent-linux/1.0.1/1
        - ComponentArn: !Sub arn:${AWS::Partition}:imagebuilder:${AWS::Region}:aws:component/aws-cli-version-2-linux/1.0.4/1
        # - ComponentArn: !Sub arn:${AWS::Partition}:imagebuilder:${AWS::Region}:aws:component/stig-build-linux/1.0.4/1
        #   Parameters:
        #     - Name: Level
        #       Value:
        #         - "High"
        #     - Name: InstallPackages
        #       Value:
        #         - "Yes"
        #     - Name: SetDoDConsentBanner
        #       Value:
        #         - "Yes"
        - ComponentArn: !Ref defaultImageComponentInstallPackages
          Parameters:
            - Name: packageNames
              Value:
                - "python3.12,jq"
      AdditionalInstanceConfiguration:
        UserDataOverride:
          Fn::Base64:
            Fn::Sub: |
              #!/bin/bash
              dnf install -y https://s3.${AWS::Region}.${AWS::URLSuffix}/amazon-ssm-${AWS::Region}/latest/linux_amd64/amazon-ssm-agent.rpm
  defaultRHELBaseline:
    Type: AWS::ImageBuilder::Image
    UpdateReplacePolicy: Retain
    Properties:
      EnhancedImageMetadataEnabled: False
      ImageTestsConfiguration:
        ImageTestsEnabled: False
      ImageRecipeArn: !Ref defaultRHELImageRecipe
      InfrastructureConfigurationArn: !Ref defaultImageInfrastructureConfiguration
  defaultRHELBaselineParameter:
    Type: AWS::SSM::Parameter
    UpdateReplacePolicy: Retain
    Properties:
      Description: Baseline Image for RHEL
      Name: !Join [ "/", [ "/sample/ec2/ami/RHEL/baseline/ami", !Select [2, !Split [ "/",  !GetAtt defaultRHELBaseline.LatestVersion.Patch ] ], "id", ], ]
      Type: String
      Value: !GetAtt defaultRHELBaseline.ImageId
  defaultRHEL9ImageRecipe:
    Type: AWS::ImageBuilder::ImageRecipe
    Properties:
      Name: RHEL9-Baseline
      Version: 0.0.10
      ParentImage: !Ref pRHEL9IAMIId
      Components:
        - ComponentArn: !Ref defaultImageComponentNetSkope
        - ComponentArn: !Sub arn:${AWS::Partition}:imagebuilder:${AWS::Region}:aws:component/update-linux/1.0.2/1
        - ComponentArn: !Sub arn:${AWS::Partition}:imagebuilder:${AWS::Region}:aws:component/reboot-linux/1.0.1/1
        - ComponentArn: !Sub arn:${AWS::Partition}:imagebuilder:${AWS::Region}:aws:component/amazon-cloudwatch-agent-linux/1.0.1/1
        - ComponentArn: !Sub arn:${AWS::Partition}:imagebuilder:${AWS::Region}:aws:component/aws-cli-version-2-linux/1.0.4/1
        # - ComponentArn: !Sub arn:${AWS::Partition}:imagebuilder:${AWS::Region}:aws:component/stig-build-linux/1.0.4/1
        #   Parameters:
        #     - Name: Level
        #       Value:
        #         - "High"
        #     - Name: InstallPackages
        #       Value:
        #         - "Yes"
        #     - Name: SetDoDConsentBanner
        #       Value:
        #         - "Yes"
        - ComponentArn: !Ref defaultImageComponentInstallPackages
          Parameters:
            - Name: packageNames
              Value:
                - "python3.12,jq"
      AdditionalInstanceConfiguration:
        UserDataOverride:
          Fn::Base64:
            Fn::Sub: |
              #!/bin/bash
              dnf install -y https://s3.${AWS::Region}.${AWS::URLSuffix}/amazon-ssm-${AWS::Region}/latest/linux_amd64/amazon-ssm-agent.rpm
  defaultRHEL9Baseline:
    Type: AWS::ImageBuilder::Image
    UpdateReplacePolicy: Retain
    Properties:
      EnhancedImageMetadataEnabled: False
      ImageTestsConfiguration:
        ImageTestsEnabled: False
      ImageRecipeArn: !Ref defaultRHEL9ImageRecipe
      InfrastructureConfigurationArn: !Ref defaultImageInfrastructureConfiguration
  defaultRHEL9BaselineParameter:
    Type: AWS::SSM::Parameter
    UpdateReplacePolicy: Retain
    Properties:
      Description: Baseline Image for RHEL9
      Name: !Join [ "/", [ "/sample/ec2/ami/RHEL9/baseline/ami", !Select [2, !Split [ "/",  !GetAtt defaultRHEL9Baseline.LatestVersion.Patch ] ], "id", ], ]
      Type: String
      Value: !GetAtt defaultRHEL9Baseline.ImageId
  defaultRHEL10ImageRecipe:
    Type: AWS::ImageBuilder::ImageRecipe
    Properties:
      Name: RHEL10-Baseline
      Version: 0.0.1
      ParentImage: !Ref pRHEL10IAMIId
      Components:
        - ComponentArn: !Ref defaultImageComponentNetSkope
        - ComponentArn: !Sub arn:${AWS::Partition}:imagebuilder:${AWS::Region}:aws:component/update-linux/1.0.2/1
        - ComponentArn: !Sub arn:${AWS::Partition}:imagebuilder:${AWS::Region}:aws:component/reboot-linux/1.0.1/1
        - ComponentArn: !Sub arn:${AWS::Partition}:imagebuilder:${AWS::Region}:aws:component/amazon-cloudwatch-agent-linux/1.0.1/1
        - ComponentArn: !Sub arn:${AWS::Partition}:imagebuilder:${AWS::Region}:aws:component/aws-cli-version-2-linux/1.0.4/1
        # - ComponentArn: !Sub arn:${AWS::Partition}:imagebuilder:${AWS::Region}:aws:component/stig-build-linux/1.0.4/1
        #   Parameters:
        #     - Name: Level
        #       Value:
        #         - "High"
        #     - Name: InstallPackages
        #       Value:
        #         - "Yes"
        #     - Name: SetDoDConsentBanner
        #       Value:
        #         - "Yes"
        - ComponentArn: !Ref defaultImageComponentInstallPackages
          Parameters:
            - Name: packageNames
              Value:
                - "python3.12,jq"
      AdditionalInstanceConfiguration:
        UserDataOverride:
          Fn::Base64:
            Fn::Sub: |
              #!/bin/bash
              dnf install -y https://s3.${AWS::Region}.${AWS::URLSuffix}/amazon-ssm-${AWS::Region}/latest/linux_amd64/amazon-ssm-agent.rpm
  defaultRHEL10Baseline:
    Type: AWS::ImageBuilder::Image
    UpdateReplacePolicy: Retain
    Properties:
      EnhancedImageMetadataEnabled: False
      ImageTestsConfiguration:
        ImageTestsEnabled: False
      ImageRecipeArn: !Ref defaultRHEL10ImageRecipe
      InfrastructureConfigurationArn: !Ref defaultImageInfrastructureConfiguration
  defaultRHEL10BaselineParameter:
    Type: AWS::SSM::Parameter
    UpdateReplacePolicy: Retain
    Properties:
      Description: Baseline Image for RHEL10
      Name: !Join [ "/", [ "/sample/ec2/ami/RHEL10/baseline/ami", !Select [2, !Split [ "/",  !GetAtt defaultRHEL10Baseline.LatestVersion.Patch ] ], "id", ], ]
      Type: String
      Value: !GetAtt defaultRHEL10Baseline.ImageId
  defaultALMAImageRecipe:
    Type: AWS::ImageBuilder::ImageRecipe
    Properties:
      Name: ALMA-Baseline
      Version: 0.0.4
      ParentImage: !Ref pALMsampleMIId
      Components:
        - ComponentArn: !Ref defaultImageComponentNetSkope
        - ComponentArn: !Sub arn:${AWS::Partition}:imagebuilder:${AWS::Region}:aws:component/update-linux/1.0.2/1
        - ComponentArn: !Sub arn:${AWS::Partition}:imagebuilder:${AWS::Region}:aws:component/reboot-linux/1.0.1/1
        - ComponentArn: !Ref defaultImageComponentInstallPackages
          Parameters:
            - Name: packageNames
              Value:
                - "python3.12,jq"
      AdditionalInstanceConfiguration:
        UserDataOverride:
          Fn::Base64:
            Fn::Sub: |
              #!/bin/bash
              dnf install -y https://s3.${AWS::Region}.${AWS::URLSuffix}/amazon-ssm-${AWS::Region}/latest/linux_arm64/amazon-ssm-agent.rpm
              timedatectl set-timezone UTC
  defaultALMABaseline:
    Type: AWS::ImageBuilder::Image
    UpdateReplacePolicy: Retain
    Properties:
      EnhancedImageMetadataEnabled: False
      ImageTestsConfiguration:
        ImageTestsEnabled: False
      ImageRecipeArn: !Ref defaultALMAImageRecipe
      InfrastructureConfigurationArn: !Ref defaultArmImageInfrastructureConfiguration
  defaultALMABaselineParameter:
    Type: AWS::SSM::Parameter
    UpdateReplacePolicy: Retain
    Properties:
      Description: Baseline Image for ALMA
      Name: !Join [ "/", [ "/sample/ec2/ami/ALMA/baseline/ami", !Select [2, !Split [ "/",  !GetAtt defaultALMABaseline.LatestVersion.Patch ] ], "id", ], ]
      Type: String
      Value: !GetAtt defaultALMABaseline.ImageId
