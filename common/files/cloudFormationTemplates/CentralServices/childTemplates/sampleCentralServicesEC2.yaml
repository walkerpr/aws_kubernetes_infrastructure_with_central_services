AWSTemplateFormatVersion: 2010-09-09
Parameters:
  pSampleEnv:
    Type: String
    Description: Production? Test?
    AllowedValues:
      - prod
      - test
  pRoute53ID:
    Type: String
  pEnvironment:
    Type: String
    Description: Development? Test Upstream? Prod Upstream?
    AllowedValues:
      - dev
      - upprod
      - uptest
  pDomain:
    Description: The domain representing the environment (ex. sample.sample.dev or sample.sample.dev)
    Type: String
    AllowedValues:
      - sample
      - sample
  pEc2DailyStop:
    Type: String
    Description: Do you want the EC2 resources to stop automatically Monday-Friday at 10PM EST, 7PM PST?
    AllowedValues:
      - "true"
      - "false"
  pEc2DailyStart:
    Type: String
    Description: Do you want the EC2 resources to stop automatically Monday-Friday at 4AM EST, 1AM PST?
    AllowedValues:
      - "true"
      - "false"
  pInstanceType:
    Description: EC2 instance type
    Type: String
    AllowedValues:
      - c4.xlarge
      - c4.2xlarge
      - c4.4xlarge
      - c5.large
      - c5.xlarge
      - c5.2xlarge
      - c5.4xlarge
      - c5n.large
      - c5n.xlarge
      - c5n.2xlarge
      - c5n.4xlarge
      - c6i.large
      - c6i.xlarge
      - c6in.2xlarge
      - c6in.4xlarge
      - m4.large
      - m4.xlarge
      - m4.2xlarge
      - m4.4xlarge
      - m5.large
      - m5.xlarge
      - m5.2xlarge
      - m5.4xlarge
      - m5n.large
      - m5n.xlarge
      - m5n.2xlarge
      - m5n.4xlarge
      - m6i.xlarge
      - r4.large
      - r4.xlarge
      - r5.large
      - r5.xlarge
      - r6i.xlarge
      - r6i.2xlarge
      - r6i.4xlarge
      - r6i.8xlarge
      - r6i.12xlarge
      - r6in.xlarge
      - r6in.2xlarge
      - r6in.4xlarge
      - r6in.8xlarge
      - r6in.12xlarge
      - r7i.large
      - r7i.xlarge
      - t2.small (Testing / Not for Production Use)
      - t2.medium
      - t2.large
      - t3.small (Testing / Not for Production Use)
      - t3.medium
      - t3.large
      - t3.xlarge
      - t3.2xlarge
      - t3a.medium
    ConstraintDescription: Please choose a valid EC2 instance type
Conditions:
  DevEnvironment: !Equals
    - !Ref pEnvironment
    - "dev"
  Upstream: !Or
    - !Equals
      - upprod
      - !Ref pEnvironment
    - !Equals
      - uptest
      - !Ref pEnvironment
Resources:
  ec2DefaultKey:
    Type: AWS::EC2::KeyPair
    Properties:
      KeyName: sample-central-services
      KeyFormat: pem
      KeyType: rsa
  # redhatmirrorRegistrySecret:
  #   Type: AWS::SecretsManager::Secret
  #   Properties:
  #     Name: sample-central-services/ec2/redhatmirrorsregistry/registry-secret
  #     Description: "This secret has a dynamically generated secret password."
  #     GenerateSecretString:
  #       SecretStringTemplate: '{"username": "init"}'
  #       GenerateStringKey: "password"
  #       PasswordLength: 15
  #       ExcludeCharacters: '"@/\`'
  # bastionVNCSecret:
  #   Type: AWS::SecretsManager::Secret
  #   Properties:
  #     Name: sample-central-services/ec2/bastionVNCSecret/vnc-secret
  #     Description: "This secret has a dynamically generated secret password."
  #     GenerateSecretString:
  #       SecretStringTemplate: '{"username": "ec2"}'
  #       GenerateStringKey: "password"
  #       PasswordLength: 15
  #       ExcludeCharacters: '"@/\`'
  bastionEC2HostSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Enable access to SSH on port 22
      VpcId: !Sub "{{resolve:ssm:/sample/vpc/sample-${pEnvironment}-${pSampleEnv}-vpc/id}}"
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: "22"
          ToPort: "22"
          SourcePrefixListId: !Sub "{{resolve:ssm:/sample/vpc/cidr/prefix}}"
  # redhatmirrorsEC2HostSecurityGroup:
  #   Type: AWS::EC2::SecurityGroup
  #   Properties:
  #     GroupDescription: "Enable access from devices within the VPC"
  #     VpcId: !Sub "{{resolve:ssm:/sample/vpc/sample-${pEnvironment}-${pSampleEnv}-vpc/id}}"
  #     SecurityGroupIngress:
  #       - IpProtocol: tcp
  #         FromPort: "22"
  #         ToPort: "22"
  #         SourceSecurityGroupId: !Ref bastionEC2HostSecurityGroup
  #       - IpProtocol: tcp
  #         FromPort: "5000"
  #         ToPort: "5000"
  #         SourcePrefixListId: !Sub "{{resolve:ssm:/sample/vpc/cidr/prefix}}"
  #       - IpProtocol: tcp
  #         FromPort: "8443"
  #         ToPort: "8443"
  #         SourcePrefixListId: !Sub "{{resolve:ssm:/sample/vpc/cidr/prefix}}"
  automationEC2HostSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: "Enable access from devices within the VPC"
      VpcId: !Sub "{{resolve:ssm:/sample/vpc/sample-${pEnvironment}-${pSampleEnv}-vpc/id}}"
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: "22"
          ToPort: "22"
          SourceSecurityGroupId: !Ref bastionEC2HostSecurityGroup
  automationEC2HostSecurityGroupUpstream:
    Type: AWS::EC2::SecurityGroupIngress
    Condition: Upstream
    Properties:
      GroupId: !Ref automationEC2HostSecurityGroup
      IpProtocol: tcp
      SourcePrefixListId: !Sub "{{resolve:ssm:/sample/vpc/prod/prefix/dev/id}}"
      FromPort: "22"
      ToPort: "22"
  nfsEC2HostSecurityGroup:
    Condition: DevEnvironment
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: "Enable access from devices within the VPC"
      VpcId: !Sub "{{resolve:ssm:/sample/vpc/sample-${pEnvironment}-${pSampleEnv}-vpc/id}}"
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: "22"
          ToPort: "22"
          SourceSecurityGroupId: !Ref bastionEC2HostSecurityGroup
        - IpProtocol: -1
          SourcePrefixListId: !Sub "{{resolve:ssm:/sample/vpc/cidr/prefix}}"
  builderEC2HostSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Condition: DevEnvironment
    Properties:
      GroupDescription: "Enable access from devices within the VPC"
      VpcId: !Sub "{{resolve:ssm:/sample/vpc/sample-${pEnvironment}-${pSampleEnv}-vpc/id}}"
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: "22"
          ToPort: "22"
          SourceSecurityGroupId: !Ref bastionEC2HostSecurityGroup
        - IpProtocol: -1
          SourcePrefixListId: !Sub "{{resolve:ssm:/sample/vpc/cidr/prefix}}"
  jiraEC2HostSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Condition: DevEnvironment
    Properties:
      GroupDescription: "Enable access from devices within the VPC"
      VpcId: !Sub "{{resolve:ssm:/sample/vpc/sample-${pEnvironment}-${pSampleEnv}-vpc/id}}"
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: "22"
          ToPort: "22"
          SourcePrefixListId: !Sub "{{resolve:ssm:/sample/vpc/cidr/prefix}}"
        - IpProtocol: tcp
          FromPort: "8080"
          ToPort: "8080"
          SourcePrefixListId: !Sub "{{resolve:ssm:/sample/vpc/cidr/prefix}}"
        - IpProtocol: tcp
          FromPort: "443"
          ToPort: "443"
          SourcePrefixListId: !Sub "{{resolve:ssm:/sample/vpc/cidr/prefix}}"
  # bastionAmazonLinuxImageRecipe:
  #   Type: AWS::ImageBuilder::ImageRecipe
  #   Properties:
  #     Name: Amazon-Linux-2023-Bastion
  #     Version: 0.0.7
  #     ParentImage: !Sub "{{resolve:ssm:/sample/ec2/ami/AmazonLinux2023/baseline/ami/0.0.7/id}}"
  #     Components:
  #       - ComponentArn: !Sub arn:${AWS::Partition}:imagebuilder:${AWS::Region}:aws:component/update-linux/1.0.2
  #     AdditionalInstanceConfiguration:
  #       UserDataOverride:
  #         Fn::Base64: !Sub |
  #           #!/bin/bash
  #           sleep 60
  #           dnf groupinstall "Desktop" -y
  #           dnf install -y xterm
  #           sudo sed -i '/^\[daemon\]/a WaylandEnable=false' /etc/gdm/custom.conf
  #           cat >> /etc/tigervnc/vncserver-config-defaults << "EOF"
  #           session=gnome
  #           securitytypes=vncauth,tlsvnc
  #           geometry=1920x1080
  #           localhost
  #           alwaysshared
  #           EOF
  #           cat >> /etc/tigervnc/vncserver.users << "EOF"
  #           :1=ec2-user
  #           EOF
  #           mkdir -p /etc/X11
  #           cat >> /etc/X11/Xwrapper.config << "EOF"
  #           allowed_users = anybody
  #           EOF
  #           sed -i 's/#X11Forwarding no/X11Forwarding yes/g' /etc/ssh/sshd_config
  #           aws ssm get-parameter --name /ec2/keypair/${ec2DefaultKey.KeyPairId} --query Parameter.Value --with-decryption --output=text > /home/ec2-user/sample-central-services.pem
  #           chmod 600 /home/ec2-user/sample-central-services.pem
  #           chown ec2-user:ec2-user /home/ec2-user/sample-central-services.pem
  # bastionAmazonLinux2023Baseline:
  #   Type: AWS::ImageBuilder::Image
  #   DependsOn: bastionAmazonLinuxImageRecipe
  #   Properties:
  #     EnhancedImageMetadataEnabled: False
  #     ImageTestsConfiguration:
  #       ImageTestsEnabled: False
  #     ImageRecipeArn: !Ref bastionAmazonLinuxImageRecipe
  #     InfrastructureConfigurationArn: !Sub "{{resolve:ssm:/sample/ec2/ami/default/configuration}}"
  # bastionAmazonLinux2023BaselineParameter:
  #   Type: AWS::SSM::Parameter
  #   DependsOn: bastionAmazonLinux2023Baseline
  #   Properties:
  #     Description: Baseline Image for Amazon Linux 2023
  #     Name: /sample/ec2/ami/AmazonLinux2023/bastion/id
  #     Type: String
  #     Value: !GetAtt bastionAmazonLinux2023Baseline.ImageId
  automationRedHatImageRecipe:
    Type: AWS::ImageBuilder::ImageRecipe
    Properties:
      Name: RHELAutomation
      Version: 0.0.2
      ParentImage: !Sub "{{resolve:ssm:/sample/ec2/ami/RHEL/baseline/ami/0.0.7/id}}"
      Components:
        - ComponentArn: !Sub arn:${AWS::Partition}:imagebuilder:${AWS::Region}:aws:component/update-linux/1.0.2
      AdditionalInstanceConfiguration:
        UserDataOverride:
          Fn::Base64: !Sub |
            #!/bin/bash
            sleep 60
            fips-mode-setup --enable
            dnf install wget -y
            dnf install python3.12 -y
            dnf install tmux -y
            rm /usr/bin/python
            ln -s /usr/bin/python3.12 /usr/bin/python
  automationRedHatBaseline:
    Type: AWS::ImageBuilder::Image
    DeletionPolicy: Retain
    DependsOn: automationRedHatImageRecipe
    Properties:
      EnhancedImageMetadataEnabled: False
      ImageTestsConfiguration:
        ImageTestsEnabled: False
      ImageRecipeArn: !Ref automationRedHatImageRecipe
      InfrastructureConfigurationArn: !Sub "{{resolve:ssm:/sample/ec2/ami/default/configuration}}"
  automationRedHatBaselineParameter:
    Type: AWS::SSM::Parameter
    DependsOn: automationRedHatBaseline
    Properties:
      Description: Baseline Image for Amazon Linux 2023
      Name: /sample/ec2/ami/RHEL/automation/id
      Type: String
      Value: !GetAtt automationRedHatBaseline.ImageId
  # redhatMirrorImageRecipe:
  #   Type: AWS::ImageBuilder::ImageRecipe
  #   Properties:
  #     Name: RHELMirror
  #     Version: 0.0.7
  #     ParentImage: !Sub "{{resolve:ssm:/sample/ec2/ami/RHEL/baseline/ami/0.0.7/id}}"
  #     Components:
  #       - ComponentArn: !Sub arn:${AWS::Partition}:imagebuilder:${AWS::Region}:aws:component/update-linux/1.0.2/1
  #       - ComponentArn: !Sub arn:${AWS::Partition}:imagebuilder:${AWS::Region}:${AWS::AccountId}:component/mirror-linux-sample/1.0.8/1
  #     AdditionalInstanceConfiguration:
  #       UserDataOverride:
  #         Fn::Base64: !Sub |
  #           #!/bin/bash
  #           aws ssm get-parameter --name /ec2/keypair/${ec2DefaultKey.KeyPairId} --query Parameter.Value --with-decryption --output=text > /home/ec2-user/sample-central-services.pem
  #           chmod 600 /home/ec2-user/sample-central-services.pem
  # redhatMirrorBaseline:
  #   Type: AWS::ImageBuilder::Image
  #   DependsOn: redhatMirrorImageRecipe
  #   Properties:
  #     EnhancedImageMetadataEnabled: False
  #     ImageTestsConfiguration:
  #       ImageTestsEnabled: False
  #     ImageRecipeArn: !Ref redhatMirrorImageRecipe
  #     InfrastructureConfigurationArn: !Sub "{{resolve:ssm:/sample/ec2/ami/default/configuration}}"
  # redhatMirrorBaselineParameter:
  #   Type: AWS::SSM::Parameter
  #   DependsOn: redhatMirrorBaseline
  #   Properties:
  #     Description: Baseline Image for RHEL
  #     Name: /sample/ec2/ami/RHEL/redhatMirror/id
  #     Type: String
  #     Value: !GetAtt redhatMirrorBaseline.ImageId
  ec2DefaultRole:
    Type: AWS::IAM::Role
    Properties:
      ManagedPolicyArns:
        - "arn:aws-us-gov:iam::aws:policy/AmazonSSMManagedInstanceCore"
      AssumeRolePolicyDocument:
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - ec2.amazonaws.com
            Action:
              - sts:AssumeRole
      Path: /
      RoleName: sampleCentralServicesDefaultEC2Role
  # ec2BastionRole:
  #   Type: AWS::IAM::Role
  #   Properties:
  #     ManagedPolicyArns:
  #       - "arn:aws-us-gov:iam::aws:policy/AmazonSSMManagedInstanceCore"
  #     AssumeRolePolicyDocument:
  #       Statement:
  #         - Effect: Allow
  #           Principal:
  #             Service:
  #               - ec2.amazonaws.com
  #           Action:
  #             - sts:AssumeRole
  #     Path: /
  #     RoleName: sampleCentralServicesBastionEC2Role
  # ec2RHELMirrorRole:
  #   Type: AWS::IAM::Role
  #   Properties:
  #     ManagedPolicyArns:
  #       - "arn:aws-us-gov:iam::aws:policy/AmazonSSMManagedInstanceCore"
  #     AssumeRolePolicyDocument:
  #       Statement:
  #         - Effect: Allow
  #           Principal:
  #             Service:
  #               - ec2.amazonaws.com
  #           Action:
  #             - sts:AssumeRole
  #     Path: /
  #     RoleName: sampleCentralServicesRHELMirrorEC2Role
  ec2RHELAutomationRole:
    Type: AWS::IAM::Role
    Properties:
      ManagedPolicyArns:
        - "arn:aws-us-gov:iam::aws:policy/AmazonSSMManagedInstanceCore"
        - "arn:aws-us-gov:iam::aws:policy/AdministratorAccess"
      AssumeRolePolicyDocument:
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - ec2.amazonaws.com
            Action:
              - sts:AssumeRole
      Path: /
      RoleName: sampleCentralServicesRHELAutomationEC2Role
  ec2RHELAutomationRoleAdditionalPolicy:
    Type: AWS::IAM::ManagedPolicy
    Properties:
      Description: "ec2RHELAutomationRoleAdditionalPolicy"
      ManagedPolicyName: ec2RHELAutomationRoleAdditionalPolicy
      PolicyDocument:
        Version: 2012-10-17
        Statement:
          - Sid: VisualEditor0
            Effect: Allow
            Action: secretsmanager:GetRandomPassword
            Resource: "*"
          - Sid: VisualEditor1
            Effect: Allow
            Action: s3:PutObject
            Resource: "*"
          - Sid: VisualEditor2
            Effect: Allow
            Action: ssm:GetParameter
            Resource: "*"
      Roles:
        - !Ref ec2RHELAutomationRole
  # sampleCentralServicesRHELMirrorEC2RoleAdditionalPolicy:
  #   Type: AWS::IAM::ManagedPolicy
  #   Properties:
  #     Description: "sampleCentralServicesRHELMirrorEC2RoleAdditionalPolicy"
  #     ManagedPolicyName: sampleCentralServicesRHELMirrorEC2RoleAdditionalPolicy
  #     PolicyDocument:
  #       Version: 2012-10-17
  #       Statement:
  #         - Sid: VisualEditor0
  #           Effect: Allow
  #           Action:
  #             - secretsmanager:GetResourcePolicy
  #             - secretsmanager:GetSecretValue
  #             - secretsmanager:DescribeSecret
  #             - secretsmanager:ListSecretVersionIds
  #           Resource: !Ref redhatmirrorRegistrySecret
  #         - Sid: VisualEditor1
  #           Effect: Allow
  #           Action: secretsmanager:GetRandomPassword
  #           Resource: "*"
  #         - Sid: VisualEditor3
  #           Effect: Allow
  #           Action: s3:PutObject
  #           Resource: "*"
  #     Roles:
  #       - !Ref ec2RHELMirrorRole
  ec2DefaultRoleAdditionalPolicy:
    Type: AWS::IAM::ManagedPolicy
    Properties:
      Description: "ec2DefaultRoleAdditionalPolicy"
      ManagedPolicyName: ec2DefaultRoleAdditionalPolicy
      PolicyDocument:
        Version: 2012-10-17
        Statement:
          - Sid: VisualEditor0
            Effect: Allow
            Action: secretsmanager:GetRandomPassword
            Resource: "*"
          - Sid: VisualEditor1
            Effect: Allow
            Action: s3:PutObject
            Resource: "*"
          - Sid: VisualEditor2
            Effect: Allow
            Action: ssm:GetParameter
            Resource: "*"
      Roles:
        - !Ref ec2DefaultRole
  # ec2BastionRoleAdditionalPolicy:
  #   Type: AWS::IAM::ManagedPolicy
  #   Properties:
  #     Description: "ec2BastionRoleAdditionalPolicy"
  #     ManagedPolicyName: ec2BastionRoleAdditionalPolicy
  #     PolicyDocument:
  #       Version: 2012-10-17
  #       Statement:
  #         - Sid: VisualEditor0
  #           Effect: Allow
  #           Action:
  #             - ssm:DescribeParameters
  #             - ssm:GetParameters
  #             - ssm:GetParameter
  #           Resource: "*"
  #         - Sid: VisualEditor1
  #           Effect: Allow
  #           Action: secretsmanager:GetRandomPassword
  #           Resource: "*"
  #         - Sid: VisualEditor2
  #           Effect: Allow
  #           Action:
  #             - secretsmanager:GetResourcePolicy
  #             - secretsmanager:GetSecretValue
  #             - secretsmanager:DescribeSecret
  #             - secretsmanager:ListSecretVersionIds
  #           Resource: !Ref bastionVNCSecret
  #         - Sid: VisualEditor3
  #           Effect: Allow
  #           Action: s3:PutObject
  #           Resource: "*"
  #     Roles:
  #       - !Ref ec2BastionRole
  iamProfileDefault:
    Type: AWS::IAM::InstanceProfile
    Properties:
      Roles:
        - Ref: ec2DefaultRole
  # iamProfileBastion:
  #   Type: AWS::IAM::InstanceProfile
  #   Properties:
  #     Roles:
  #       - Ref: ec2BastionRole
  # iamProfileRHELMirror:
  #   Type: AWS::IAM::InstanceProfile
  #   Properties:
  #     Roles:
  #       - Ref: ec2RHELMirrorRole
  iamProfileRHELAutomation:
    Type: AWS::IAM::InstanceProfile
    Properties:
      Roles:
        - Ref: ec2RHELAutomationRole
  ec2DefaultLinuxLaunchTemplate:
    Type: AWS::EC2::LaunchTemplate
    Properties:
      LaunchTemplateName: ec2DefaultLinuxLaunchTemplate
      LaunchTemplateData:
        IamInstanceProfile:
          Name: !Ref iamProfileDefault
        InstanceType: !Ref pInstanceType
        KeyName: !Ref ec2DefaultKey
        MetadataOptions:
          InstanceMetadataTags: enabled
          HttpTokens: required
        BlockDeviceMappings:
          - DeviceName: /dev/xvda
            Ebs:
              VolumeType: gp3
              DeleteOnTermination: "true"
              VolumeSize: "100"
        TagSpecifications:
          - ResourceType: instance
            Tags:
              - Key: "deploymentType"
                Value: centralServices
              - Key: "ec2DailyStart"
                Value: "True"
              - Key: "ec2DailyStop"
                Value: "True"
              - Key: "systemGroup"
                Value: "Amazon Linux"
              - Key: ec2DailyStop
                Value: !Ref pEc2DailyStop
              - Key: ec2DailyStart
                Value: !Ref pEc2DailyStart
  ec2RHELLinuxLaunchTemplate:
    Type: AWS::EC2::LaunchTemplate
    Properties:
      LaunchTemplateName: ec2RHELLinuxLaunchTemplate
      LaunchTemplateData:
        IamInstanceProfile:
          Name: !Ref iamProfileDefault
        InstanceType: !Ref pInstanceType
        KeyName: !Ref ec2DefaultKey
        MetadataOptions:
          InstanceMetadataTags: enabled
          HttpTokens: required
        BlockDeviceMappings:
          - DeviceName: /dev/sda1
            Ebs:
              VolumeType: gp3
              DeleteOnTermination: "true"
              VolumeSize: "100"
        TagSpecifications:
          - ResourceType: instance
            Tags:
              - Key: "deploymentType"
                Value: centralServices
              - Key: "ec2DailyStart"
                Value: "True"
              - Key: "ec2DailyStop"
                Value: "True"
              - Key: "systemGroup"
                Value: "Red Hat Enterprise Linux"
  # bastionEC2Host:
  #   Type: AWS::EC2::Instance
  #   Properties:
  #     LaunchTemplate:
  #       LaunchTemplateId: !Ref ec2DefaultLinuxLaunchTemplate
  #       Version: !GetAtt ec2DefaultLinuxLaunchTemplate.LatestVersionNumber
  #     ImageId: !GetAtt bastionAmazonLinux2023Baseline.ImageId
  #     KeyName: !Ref ec2DefaultKey
  #     InstanceType: !Ref pInstanceType
  #     SubnetId: !Sub "{{resolve:ssm:/sample/vpc/sample-${pEnvironment}-${pSampleEnv}-vpc/sample-central-services-subnet/a/id}}"
  #     SecurityGroupIds:
  #       - Ref: bastionEC2HostSecurityGroup
  #     IamInstanceProfile: !Ref iamProfileBastion
  #     UserData:
  #       Fn::Base64: !Sub |
  #         #!/bin/bash
  #         TOKEN=`curl -X PUT "http://169.254.169.254/latest/api/token" -H "X-aws-ec2-metadata-token-ttl-seconds: 21600"`
  #         InstanceName=`curl -H "X-aws-ec2-metadata-token: $TOKEN" http://169.254.169.254/latest/meta-data/tags/instance/Name`
  #         hostnamectl set-hostname $InstanceName --static
  #         mkdir -p /home/ec2-user/.config/tigervnc
  #         aws secretsmanager get-secret-value --secret-id ${bastionVNCSecret.Id} --query SecretString --output text | jq '."password"' | sed 's/\"//g' | vncpasswd -f > /home/ec2-user/.config/tigervnc/passwd
  #         chmod 600 /home/ec2-user/.config/tigervnc/passwd
  #         chown ec2-user:ec2-user /home/ec2-user/.config/tigervnc/passwd
  #         systemctl enable vncserver@:1 --now
  #         aws secretsmanager get-secret-value --secret-id ${bastionVNCSecret.Id} --query SecretString --output text | jq '."password"' | sed 's/\"//g' | passwd ec2-user  --stdin

  #     Tags:
  #       - Key: Name
  #         Value: !Sub "bastion.${pEnvironment}.${pDomain}.dev"
  #       - Key: "systemGroup"
  #         Value: "Amazon Linux"
  # redhatmirrorsEC2Host:
  #   Type: AWS::EC2::Instance
  #   Properties:
  #     LaunchTemplate:
  #       LaunchTemplateId: !Ref ec2RHELLinuxLaunchTemplate
  #       Version: !GetAtt ec2RHELLinuxLaunchTemplate.LatestVersionNumber
  #     ImageId: !GetAtt redhatMirrorBaseline.ImageId
  #     SubnetId: !Sub "{{resolve:ssm:/sample/vpc/sample-${pEnvironment}-${pSampleEnv}-vpc/sample-central-services-subnet/a/id}}"
  #     IamInstanceProfile: !Ref iamProfileRHELMirror
  #     SecurityGroupIds:
  #       - Ref: redhatmirrorsEC2HostSecurityGroup
  #     UserData:
  #       Fn::Base64: !Sub |
  #         #!/bin/bash
  #         TOKEN=`curl -X PUT "http://169.254.169.254/latest/api/token" -H "X-aws-ec2-metadata-token-ttl-seconds: 21600"`
  #         InstanceName=`curl -H "X-aws-ec2-metadata-token: $TOKEN" http://169.254.169.254/latest/meta-data/tags/instance/Name`
  #         hostnamectl set-hostname $InstanceName --static
  #         sleep 15
  #         InitPass=$(aws secretsmanager get-secret-value --secret-id ${redhatmirrorRegistrySecret.Id} --query SecretString --output text | jq '."password"' | sed s/\"//g)
  #         /opt/redhat-mirror/mirror-registry install -i /opt/redhat-mirror/image-archive.tar --initPassword "$InitPass" -v -u ec2-user -k /home/ec2-user/sample-central-services.pem
  #     Tags:
  #       - Key: Name
  #         Value: !Sub "redhat-mirror.${pEnvironment}.${pDomain}.dev"
  automationEC2Host:
    Type: AWS::EC2::Instance
    Properties:
      LaunchTemplate:
        LaunchTemplateId: !Ref ec2RHELLinuxLaunchTemplate
        Version: !GetAtt ec2RHELLinuxLaunchTemplate.LatestVersionNumber
      BlockDeviceMappings:
        - DeviceName: /dev/sda1
          Ebs:
            VolumeType: gp3
            DeleteOnTermination: "true"
            VolumeSize: "1000"
      IamInstanceProfile: !Ref iamProfileRHELAutomation
      ImageId: !GetAtt automationRedHatBaseline.ImageId
      SubnetId: !Sub "{{resolve:ssm:/sample/vpc/sample-${pEnvironment}-${pSampleEnv}-vpc/sample-central-services-subnet/a/id}}"
      DisableApiTermination: "true"
      SecurityGroupIds:
        - Ref: automationEC2HostSecurityGroup
      UserData:
        Fn::Base64: !Sub |
          #!/bin/bash
          TOKEN=`curl -X PUT "http://169.254.169.254/latest/api/token" -H "X-aws-ec2-metadata-token-ttl-seconds: 21600"`
          OSVERSION=$(grep -E '^(VERSION_ID)=' /etc/os-release | awk -F"\"" '{print $2}' | awk -F"." '{print $1}')
          COMPLIANCEID=$(aws ssm get-parameter --name /redhat/insights/rhel$OSVERSION/complianceid --query Parameter.Value --with-decryption --output=text)
          REDHATPASSWORD=$(aws ssm get-parameter --name /redhat/samplerheladmin/password --query Parameter.Value --with-decryption --output=text)
          ROOTPASSWORD=$(aws ssm get-parameter --name /sample/ec2/root/password --query Parameter.Value --with-decryption --output=text)
          InstanceName=`curl -H "X-aws-ec2-metadata-token: $TOKEN" http://169.254.169.254/latest/meta-data/tags/instance/Name`
          hostnamectl set-hostname $InstanceName --static
          dnf install git -y
          wget https://bootstrap.pypa.io/get-pip.py
          su ec2-user -c 'python get-pip.py --trusted-host pypi.org --trusted-host files.pythonhosted.org'
          su ec2-user -c '/home/ec2-user/.local/bin/pip install pipx --trusted-host pypi.org --trusted-host files.pythonhosted.org'
          su ec2-user -c '/home/ec2-user/.local/bin/pipx install --include-deps ansible==8.7.0'
          su ec2-user -c '/home/ec2-user/.local/bin/pipx ensurepath'
          su ec2-user -c 'git config --global core.autocrlf false'
          su ec2-user -c 'git config --global credential.helper "cache"'
          su ec2-user -c 'git config --global http.sslVerify false'
          sudo ln -s /usr/bin/python3.12 /usr/bin/python
          dnf install insights-client scap-security-guide openscap-scanner openscap -y
          subscription-manager register --force --username samplerheladmin --password "$REDHATPASSWORD"
          insights-client --register
          insights-client  --compliance-assign  "$COMPLIANCEID"
          echo "root:$ROOTPASSWORD" | chpasswd
      Tags:
        - Key: Name
          Value: !Sub "automation.${pEnvironment}.${pDomain}.dev"
        - Key: dailyBackup
          Value: "true"
        - Key: centralServicesResource
          Value: "true"
  nfssampleEC2Host:
    DeletionPolicy: Delete
    Type: AWS::EC2::Instance
    Condition: DevEnvironment
    Properties:
      LaunchTemplate:
        LaunchTemplateId: !Ref ec2RHELLinuxLaunchTemplate
        Version: !GetAtt ec2RHELLinuxLaunchTemplate.LatestVersionNumber
      BlockDeviceMappings:
        - DeviceName: /dev/sda1
          Ebs:
            VolumeType: gp3
            DeleteOnTermination: "true"
            VolumeSize: "5000"
      IamInstanceProfile: !Ref iamProfileRHELAutomation
      ImageId:  !Sub "ami-0a99123b9651552f5"
      SubnetId: !Sub "{{resolve:ssm:/sample/vpc/sample-${pEnvironment}-${pSampleEnv}-vpc/sample-central-services-subnet/b/id}}"
      DisableApiTermination: "true"
      SecurityGroupIds:
        - Ref: nfsEC2HostSecurityGroup
      UserData:
        Fn::Base64: !Sub |
          #!/bin/bash
          TOKEN=`curl -X PUT "http://169.254.169.254/latest/api/token" -H "X-aws-ec2-metadata-token-ttl-seconds: 21600"`
          OSVERSION=$(grep -E '^(VERSION_ID)=' /etc/os-release | awk -F"\"" '{print $2}' | awk -F"." '{print $1}')
          COMPLIANCEID=$(aws ssm get-parameter --name /redhat/insights/rhel$OSVERSION/complianceid --query Parameter.Value --with-decryption --output=text)
          REDHATPASSWORD=$(aws ssm get-parameter --name /redhat/samplerheladmin/password --query Parameter.Value --with-decryption --output=text)
          ROOTPASSWORD=$(aws ssm get-parameter --name /sample/ec2/root/password --query Parameter.Value --with-decryption --output=text)
          InstanceName=`curl -H "X-aws-ec2-metadata-token: $TOKEN" http://169.254.169.254/latest/meta-data/tags/instance/Name`
          hostnamectl set-hostname $InstanceName --static
          sleep 30
          dnf install python3.12 -y
          dnf install wget -y
          ln -s /usr/bin/python3.12 /usr/bin/python
          wget https://bootstrap.pypa.io/get-pip.py
          su ec2-user -c 'python3 get-pip.py'
          su ec2-user -c '/home/ec2-user/.local/bin/pip install pipx --trusted-host pypi.org --trusted-host files.pythonhosted.org'
          su ec2-user -c '/home/ec2-user/.local/bin/pipx install --include-deps ansible'
          su ec2-user -c '/home/ec2-user/.local/bin/pipx ensurepath'
          dnf install insights-client scap-security-guide openscap-scanner openscap -y
          subscription-manager register --force --username samplerheladmin --password "$REDHATPASSWORD"
          insights-client --register
          insights-client  --compliance-assign  "$COMPLIANCEID"
          echo "root:$ROOTPASSWORD" | chpasswd
      Tags:
        - Key: Name
          Value: !Sub "nfs.${pEnvironment}.${pDomain}.dev"
        - Key: purpose
          Value: nfs
        - Key: "ec2DailyStart"
          Value: "true"
        - Key: "ec2DailyStop"
          Value: "false"
        - Key: dailyBackup
          Value: "true"
        - Key: centralServicesResource
          Value: "true"
  builderEC2Host:
    Type: AWS::EC2::Instance
    Condition: DevEnvironment
    Properties:
      LaunchTemplate:
        LaunchTemplateId: !Ref ec2RHELLinuxLaunchTemplate
        Version: !GetAtt ec2RHELLinuxLaunchTemplate.LatestVersionNumber
      ImageId: !Sub "{{resolve:ssm:/sample/ec2/ami/RHEL9/baseline/ami/0.0.7/id}}"
      SubnetId: !Sub "{{resolve:ssm:/sample/vpc/sample-${pEnvironment}-${pSampleEnv}-vpc/sample-central-services-subnet/a/id}}"
      SecurityGroupIds:
        - Ref: builderEC2HostSecurityGroup
      UserData:
        Fn::Base64: !Sub |
          #!/bin/bash
          TOKEN=`curl -X PUT "http://169.254.169.254/latest/api/token" -H "X-aws-ec2-metadata-token-ttl-seconds: 21600"`
          OSVERSION=$(grep -E '^(VERSION_ID)=' /etc/os-release | awk -F"\"" '{print $2}' | awk -F"." '{print $1}')
          COMPLIANCEID=$(aws ssm get-parameter --name /redhat/insights/rhel$OSVERSION/complianceid --query Parameter.Value --with-decryption --output=text)
          REDHATPASSWORD=$(aws ssm get-parameter --name /redhat/samplerheladmin/password --query Parameter.Value --with-decryption --output=text)
          ROOTPASSWORD=$(aws ssm get-parameter --name /sample/ec2/root/password --query Parameter.Value --with-decryption --output=text)
          InstanceName=`curl -H "X-aws-ec2-metadata-token: $TOKEN" http://169.254.169.254/latest/meta-data/tags/instance/Name`
          hostnamectl set-hostname $InstanceName --static
          dnf install insights-client scap-security-guide openscap-scanner openscap -y
          subscription-manager register --force --username samplerheladmin --password "$REDHATPASSWORD"
          insights-client --register
          insights-client  --compliance-assign  "$COMPLIANCEID"
          echo "root:$ROOTPASSWORD" | chpasswd
      Tags:
        - Key: Name
          Value: !Sub "builder.${pEnvironment}.${pDomain}.dev"
        - Key: centralServicesResource
          Value: "true"
  jiraEC2Host:
    Type: AWS::EC2::Instance
    Condition: DevEnvironment
    Properties:
      LaunchTemplate:
        LaunchTemplateId: !Ref ec2RHELLinuxLaunchTemplate
        Version: !GetAtt ec2RHELLinuxLaunchTemplate.LatestVersionNumber
      ImageId: ami-053d0ebf771289e23
      SubnetId: !Sub "{{resolve:ssm:/sample/vpc/sample-${pEnvironment}-${pSampleEnv}-vpc/sample-central-services-subnet/a/id}}"
      SecurityGroupIds:
        - Ref: jiraEC2HostSecurityGroup
      UserData:
        Fn::Base64: !Sub |
          #!/bin/bash
          TOKEN=`curl -X PUT "http://169.254.169.254/latest/api/token" -H "X-aws-ec2-metadata-token-ttl-seconds: 21600"`
          OSVERSION=$(grep -E '^(VERSION_ID)=' /etc/os-release | awk -F"\"" '{print $2}' | awk -F"." '{print $1}')
          COMPLIANCEID=$(aws ssm get-parameter --name /redhat/insights/rhel$OSVERSION/complianceid --query Parameter.Value --with-decryption --output=text)
          REDHATPASSWORD=$(aws ssm get-parameter --name /redhat/samplerheladmin/password --query Parameter.Value --with-decryption --output=text)
          ROOTPASSWORD=$(aws ssm get-parameter --name /sample/ec2/root/password --query Parameter.Value --with-decryption --output=text)
          InstanceName=`curl -H "X-aws-ec2-metadata-token: $TOKEN" http://169.254.169.254/latest/meta-data/tags/instance/Name`
          hostnamectl set-hostname $InstanceName --static
          dnf install insights-client scap-security-guide openscap-scanner openscap -y
          subscription-manager register --force --username samplerheladmin --password "$REDHATPASSWORD"
          insights-client --register
          insights-client  --compliance-assign  "$COMPLIANCEID"
          echo "root:$ROOTPASSWORD" | chpasswd
      Tags:
        - Key: Name
          Value: !Sub "jira.${pEnvironment}.${pDomain}.dev"
        - Key: centralServicesResource
          Value: "true"


  # bastionEC2HostRoute53Record:
  #   Type: AWS::Route53::RecordSet
  #   DependsOn: bastionEC2Host
  #   Properties:
  #     HostedZoneId: !Ref pRoute53ID
  #     Name: !Sub "bastion.${pEnvironment}.${pDomain}.dev"
  #     ResourceRecords:
  #       - !GetAtt bastionEC2Host.PrivateIp
  #     TTL: 900
  #     Type: A
  # redhatmirrorsEC2HostRoute53Record:
  #   Type: AWS::Route53::RecordSet
  #   DependsOn: redhatmirrorsEC2Host
  #   Properties:
  #     HostedZoneId: !Ref pRoute53ID
  #     Name: !Sub "redhatmirror.${pEnvironment}.${pDomain}.dev"
  #     ResourceRecords:
  #       - !GetAtt redhatmirrorsEC2Host.PrivateIp
  #     TTL: 900
  #     Type: A
  automationEC2HostRoute53Record:
    Type: AWS::Route53::RecordSet
    DependsOn: automationEC2Host
    Properties:
      HostedZoneId: !Ref pRoute53ID
      Name: !Sub "automation.${pEnvironment}.${pDomain}.dev"
      ResourceRecords:
        - !GetAtt automationEC2Host.PrivateIp
      TTL: 900
      Type: A
  nfsEC2HostRoute53Record:
    Condition: DevEnvironment
    Type: AWS::Route53::RecordSet
    DependsOn: nfssampleEC2Host
    Properties:
      HostedZoneId: !Ref pRoute53ID
      Name: !Sub "nfs.${pEnvironment}.${pDomain}.dev"
      ResourceRecords:
        - !GetAtt nfssampleEC2Host.PrivateIp
      TTL: 900
      Type: A
  builderEC2HostRoute53Record:
    Type: AWS::Route53::RecordSet
    Condition: DevEnvironment
    DependsOn: builderEC2Host
    Properties:
      HostedZoneId: !Ref pRoute53ID
      Name: !Sub "builder.${pEnvironment}.${pDomain}.dev"
      ResourceRecords:
        - !GetAtt builderEC2Host.PrivateIp
      TTL: 900
      Type: A
  jiraEC2HostRoute53Record:
    Type: AWS::Route53::RecordSet
    Condition: DevEnvironment
    DependsOn: jiraEC2Host
    Properties:
      HostedZoneId: !Ref pRoute53ID
      Name: !Sub "jira.${pEnvironment}.${pDomain}.dev"
      ResourceRecords:
        - !GetAtt jiraEC2Host.PrivateIp
      TTL: 900
      Type: A
  # bastionEC2HostSecurityGroupParameter:
  #   Type: AWS::SSM::Parameter
  #   DependsOn: bastionEC2Host
  #   Properties:
  #     Name: !Sub "/sample/ec2/sample-central-services/bastion/securitygroup/id"
  #     Type: String
  #     Value: !Ref bastionEC2HostSecurityGroup
  #     Description: SSM Parameter for bastionEC2HostSecurityGroup
  ec2DefaultLinuxLaunchTemplateParameterID:
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub "/sample/ec2/sample-central-services/launchtemplate/aws-linux/id"
      Type: String
      Value: !Ref ec2DefaultLinuxLaunchTemplate
      Description: SSM Parameter for ec2DefaultLinuxLaunchTemplate
  ec2DefaultLinuxLaunchTemplateParameterDefaultVersion:
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub "/sample/ec2/sample-central-services/launchtemplate/aws-linux/ver"
      Type: String
      Value: !GetAtt ec2DefaultLinuxLaunchTemplate.LatestVersionNumber
      Description: SSM Parameter for ec2DefaultLinuxLaunchTemplate latest version number.
  ec2DefaultKeyParameter:
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub "/sample/ec2/sample-central-services/ec2/default-key/id"
      Type: String
      Value: !GetAtt ec2DefaultKey.KeyPairId
      Description: SSM Parameter for ec2DefaultKey.KeyPairId.

Outputs:
  ec2DefaultKeyOutput:
      Value: !GetAtt ec2DefaultKey.KeyPairId
  builderEC2IPOutput:
      Condition: DevEnvironment
      Value: !GetAtt builderEC2Host.PrivateIp
