Parameters:
  pEnvironment:
    Type: String
    Description: Development? Test Upstream? Prod Upstream?
    AllowedValues:
      - dev
      - upprod
      - uptest
  pSampleEnv:
    Type: String
    Description: Production? Test?
    AllowedValues:
      - prod
      - test
  pBuilderIp:
    Type: String
  pDomain:
    Description: The domain representing the environment (ex. sample.sample.dev or sample.sample.dev).
    Type: String
    AllowedValues:
      - sample
      - sample
Conditions:
  Dev: !Equals
    - !Ref pEnvironment
    - "dev"
Resources:
  BuildAppElb:
    Type: AWS::ElasticLoadBalancingV2::LoadBalancer
    Properties:
      Name: !Sub  sample-${pEnvironment}-${pSampleEnv}-build-elb
      Scheme: internal
      IpAddressType: ipv4
      Subnets:
        - !Sub "{{resolve:ssm:/sample/vpc/sample-${pEnvironment}-${pSampleEnv}-vpc/sample-central-services-subnet/d/id}}"
        - !Sub "{{resolve:ssm:/sample/vpc/sample-${pEnvironment}-${pSampleEnv}-vpc/sample-central-services-subnet/e/id}}"
      Type: network
  BuildAppELBServices:
    Type: AWS::EC2::VPCEndpointService
    Properties:
      AcceptanceRequired: false
      NetworkLoadBalancerArns:
        - !Ref BuildAppElb
      SupportedIpAddressTypes:
        - ipv4
      Tags:
        - Key: "Name"
          Value: "build-app"
  BuildAppELBServicePermissions:
    Type: AWS::EC2::VPCEndpointServicePermissions
    DeletionPolicy: Retain
    Properties:
      AllowedPrincipals:
        - arn:aws-us-gov:iam::<PLACEHOLDER>:root
      ServiceId: !GetAtt BuildAppELBServices.ServiceId
  BuildAppELBRecord:
    Type: AWS::Route53::RecordSetGroup
    Properties:
      Comment: Alias record for the API server
      HostedZoneId: !Sub "{{resolve:ssm:/sample/route53/${pEnvironment}-dev/id}}"
      RecordSets:
        - Name: !Sub "app.0.upstream.elb.${pEnvironment}.${pDomain}.dev"
          Type: CNAME
          AliasTarget:
            HostedZoneId: !GetAtt BuildAppElb.CanonicalHostedZoneID
            DNSName: !GetAtt BuildAppElb.DNSName
  BuildAppELBListener:
    Type: AWS::ElasticLoadBalancingV2::Listener
    Properties:
      DefaultActions:
        - Type: forward
          TargetGroupArn:
            Ref: BuildAppELBTargetGroup
      LoadBalancerArn:
        Ref: BuildAppElb
      Port: 443
      Protocol: TCP
  BuildAppELBTargetGroup:
    Type: AWS::ElasticLoadBalancingV2::TargetGroup
    Properties:
      HealthCheckIntervalSeconds: 10
      HealthCheckPath: "/readyz"
      HealthCheckPort: 443
      HealthCheckProtocol: HTTPS
      HealthyThresholdCount: 2
      UnhealthyThresholdCount: 2
      Port: 443
      Protocol: TCP
      TargetType: ip
      VpcId: !Sub "{{resolve:ssm:/sample/vpc/sample-${pEnvironment}-${pSampleEnv}-vpc/id}}"
      TargetGroupAttributes:
        - Key: deregistration_delay.timeout_seconds
          Value: 60
  BuildAppELBSSHListener:
    Type: AWS::ElasticLoadBalancingV2::Listener
    Properties:
      DefaultActions:
        - Type: forward
          TargetGroupArn:
            Ref: BuildAppELBSSHTargetGroup
      LoadBalancerArn:
        Ref: BuildAppElb
      Port: 22
      Protocol: TCP
  BuildAppELBSSHTargetGroup:
    Type: AWS::ElasticLoadBalancingV2::TargetGroup
    Properties:
      HealthCheckIntervalSeconds: 10
      HealthCheckPath: "/readyz"
      HealthCheckPort: 22
      HealthCheckProtocol: HTTPS
      HealthyThresholdCount: 2
      UnhealthyThresholdCount: 2
      Port: 22
      Protocol: TCP
      TargetType: ip
      VpcId: !Sub "{{resolve:ssm:/sample/vpc/sample-${pEnvironment}-${pSampleEnv}-vpc/id}}"
      TargetGroupAttributes:
        - Key: deregistration_delay.timeout_seconds
          Value: 60
  BuildAppELBLoadBalancerNameParameter:
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub "/sample/elb/sample-central-services/elb/BuildAppELBloadbalancer/name"
      Type: String
      Value: !GetAtt BuildAppElb.LoadBalancerFullName
      Description: SSM Parameter for BuildAppELBLoadBalancerName
  BuildAppELBLoadBalancerDNSNameParameter:
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub "/sample/elb/sample-central-services/elb/BuildAppELBloadbalancer/dnsname"
      Type: String
      Value: !Sub "build-elb.${pEnvironment}.${pDomain}.dev"
      Description: SSM Parameter for BuildAppELBLoadBalancer
  BuildAppELBTargetGroupArnParameter:
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub "/sample/lambda/sample-central-services/BuildAppELBtargetgroup/arn"
      Type: String
      Value: !Ref BuildAppELBTargetGroup
      Description: SSM Parameter for BuildAppELBTargetGroup
  BuildAppELBSSHTargetGroupArnParameter:
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub "/sample/lambda/sample-central-services/BuildAppELBSSHtargetgroup/arn"
      Type: String
      Value: !Ref BuildAppELBSSHTargetGroup
      Description: SSM Parameter for BuildAppELBTargetGroup
  UPAppELBTAF:
    Type: AWS::ElasticLoadBalancingV2::LoadBalancer
    Properties:
      Name: !Sub  sample-${pEnvironment}-${pSampleEnv}-upstream-elb
      Scheme: internal
      IpAddressType: ipv4
      Subnets:
        - !Sub "{{resolve:ssm:/sample/vpc/sample-${pEnvironment}-${pSampleEnv}-vpc/sample-central-services-subnet/f/id}}"
        - !Sub "{{resolve:ssm:/sample/vpc/sample-${pEnvironment}-${pSampleEnv}-vpc/sample-central-services-subnet/g/id}}"
      Type: network
  UPAppELBTAFServices:
    Type: AWS::EC2::VPCEndpointService
    Properties:
      AcceptanceRequired: false
      NetworkLoadBalancerArns:
        - !Ref UPAppELBTAF
      SupportedIpAddressTypes:
        - ipv4
      Tags:
        - Key: "sampleDeploymentNumber"
          Value: "3"
        - Key: "Name"
          Value: "taf-upstream-app"
  UPAppELBTAFServicePermissions:
    Type: AWS::EC2::VPCEndpointServicePermissions
    DeletionPolicy: Retain
    Properties:
      AllowedPrincipals:
        - arn:aws-us-gov:iam::<PLACEHOLDER>:root
      ServiceId: !GetAtt UPAppELBTAFServices.ServiceId
  UPAppELBTAFListener:
    Type: AWS::ElasticLoadBalancingV2::Listener
    Properties:
      DefaultActions:
        - Type: forward
          TargetGroupArn:
            Ref: UPAppELBTAFTargetGroup
      LoadBalancerArn:
        Ref: UPAppELBTAF
      Port: 443
      Protocol: TCP
  UPAppELBTAFTargetGroup:
    Type: AWS::ElasticLoadBalancingV2::TargetGroup
    Properties:
      HealthCheckIntervalSeconds: 10
      HealthCheckPath: "/readyz"
      HealthCheckPort: 443
      HealthCheckProtocol: HTTPS
      HealthyThresholdCount: 2
      UnhealthyThresholdCount: 2
      Port: 443
      Protocol: TCP
      TargetType: ip
      VpcId: !Sub "{{resolve:ssm:/sample/vpc/sample-${pEnvironment}-${pSampleEnv}-vpc/id}}"
      TargetGroupAttributes:
        - Key: deregistration_delay.timeout_seconds
          Value: 60
  UPAppELBTAFLoadBalancerNameParameter:
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub "/sample/elb/sample-central-services/elb/UPAppELBTAFloadbalancer/name"
      Type: String
      Value: !GetAtt UPAppELBTAF.LoadBalancerFullName
      Description: SSM Parameter for UPAppELBTAFLoadBalancerName
  UPAppELBTAFLoadBalancerDNSNameParameter:
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub "/sample/elb/sample-central-services/elb/UPAppELBTAFloadbalancer/dnsname"
      Type: String
      Value: !Sub "upstream-elb.${pEnvironment}.${pDomain}.dev"
      Description: SSM Parameter for UPAppELBTAFLoadBalancer
  UPAppELBTAFTargetGroupArnParameter:
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub "/sample/lambda/sample-central-services/elb/UPAppELBTAFtargetgroup/arn"
      Type: String
      Value: !Ref UPAppELBTAFTargetGroup
      Description: SSM Parameter for UPAppELBTAFTargetGroup
  UPSecELBTAF:
    Type: AWS::ElasticLoadBalancingV2::LoadBalancer
    Properties:
      Name: !Sub  sample-${pEnvironment}-${pSampleEnv}-upstream-sec-elb
      Scheme: internal
      IpAddressType: ipv4
      Subnets:
        - !Sub "{{resolve:ssm:/sample/vpc/sample-${pEnvironment}-${pSampleEnv}-vpc/sample-central-services-subnet/f/id}}"
        - !Sub "{{resolve:ssm:/sample/vpc/sample-${pEnvironment}-${pSampleEnv}-vpc/sample-central-services-subnet/g/id}}"
      Type: network
  UPSecELBTAFServices:
    Type: AWS::EC2::VPCEndpointService
    Properties:
      AcceptanceRequired: false
      NetworkLoadBalancerArns:
        - !Ref UPSecELBTAF
      SupportedIpAddressTypes:
        - ipv4
      Tags:
        - Key: "sampleDeploymentNumber"
          Value: "3"
        - Key: "Name"
          Value: "taf-upstream-sec"
  UPSecELBTAFServicePermissions:
    Type: AWS::EC2::VPCEndpointServicePermissions
    DeletionPolicy: Retain
    Properties:
      AllowedPrincipals:
        - arn:aws-us-gov:iam::<PLACEHOLDER>:root
      ServiceId: !GetAtt UPSecELBTAFServices.ServiceId
  UPSecELBTAFRecord:
    Type: AWS::Route53::RecordSetGroup
    Properties:
      Comment: Alias record for the API server
      HostedZoneId: !Sub "{{resolve:ssm:/sample/route53/${pEnvironment}-dev/id}}"
      RecordSets:
        - Name: !Sub "sec.0.upstream.elb.${pEnvironment}.${pDomain}.dev"
          Type: CNAME
          AliasTarget:
            HostedZoneId: !GetAtt UPSecELBTAF.CanonicalHostedZoneID
            DNSName: !GetAtt UPSecELBTAF.DNSName
  UPSecELBTAFListener:
    Type: AWS::ElasticLoadBalancingV2::Listener
    Properties:
      DefaultActions:
        - Type: forward
          TargetGroupArn:
            Ref: UPSecELBTAFTargetGroup
      LoadBalancerArn:
        Ref: UPSecELBTAF
      Port: 443
      Protocol: TCP
  UPSecELBTAFTargetGroup:
    Type: AWS::ElasticLoadBalancingV2::TargetGroup
    Properties:
      HealthCheckIntervalSeconds: 10
      HealthCheckPath: "/readyz"
      HealthCheckPort: 443
      HealthCheckProtocol: HTTPS
      HealthyThresholdCount: 2
      UnhealthyThresholdCount: 2
      Port: 443
      Protocol: TCP
      TargetType: ip
      VpcId: !Sub "{{resolve:ssm:/sample/vpc/sample-${pEnvironment}-${pSampleEnv}-vpc/id}}"
      TargetGroupAttributes:
        - Key: deregistration_delay.timeout_seconds
          Value: 60
  UPSecELBTAFLoadBalancerNameParameter:
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub "/sample/elb/sample-central-services/elb/UPSecELBTAFloadbalancer/name"
      Type: String
      Value: !GetAtt UPSecELBTAF.LoadBalancerFullName
      Description: SSM Parameter for UPSecELBTAFLoadBalancerName
  UPSecELBTAFLoadBalancerDNSNameParameter:
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub "/sample/elb/sample-central-services/elb/UPSecELBTAFloadbalancer/dnsname"
      Type: String
      Value: !Sub "upstream-elb.${pEnvironment}.${pDomain}.dev"
      Description: SSM Parameter for UPSecELBTAFLoadBalancer
  UPSecELBTAFTargetGroupArnParameter:
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub "/sample/lambda/sample-central-services/elb/UPSecELBTAFtargetgroup/arn"
      Type: String
      Value: !Ref UPSecELBTAFTargetGroup
      Description: SSM Parameter for UPSecELBTAFTargetGroup
  DOWNSecELBTAF:

    Type: AWS::ElasticLoadBalancingV2::LoadBalancer
    Properties:
      Name: !Sub  sample-${pEnvironment}-${pSampleEnv}-downstream-sec-elb
      Scheme: internal
      IpAddressType: ipv4
      Subnets:
        - !Sub "{{resolve:ssm:/sample/vpc/sample-${pEnvironment}-${pSampleEnv}-vpc/sample-central-services-subnet/f/id}}"
        - !Sub "{{resolve:ssm:/sample/vpc/sample-${pEnvironment}-${pSampleEnv}-vpc/sample-central-services-subnet/g/id}}"
      Type: network
  DOWNSecELBTAFServices:

    Type: AWS::EC2::VPCEndpointService
    Properties:
      AcceptanceRequired: false
      NetworkLoadBalancerArns:
        - !Ref DOWNSecELBTAF
      SupportedIpAddressTypes:
        - ipv4
      Tags:
        - Key: "sampleDeploymentNumber"
          Value: "3"
        - Key: "Name"
          Value: "taf-downstream-sec"
  DOWNSecELBTAFServicePermissions:

    Type: AWS::EC2::VPCEndpointServicePermissions
    DeletionPolicy: Retain
    Properties:
      AllowedPrincipals:
        - arn:aws-us-gov:iam::<PLACEHOLDER>:root
      ServiceId: !GetAtt DOWNSecELBTAFServices.ServiceId
  DOWNSecELBTAFRecord:

    Type: AWS::Route53::RecordSetGroup
    Properties:
      Comment: Alias record for the API server
      HostedZoneId: !Sub "{{resolve:ssm:/sample/route53/${pEnvironment}-dev/id}}"
      RecordSets:
        - Name: !Sub "sec.taf.downstream.elb.${pEnvironment}.${pDomain}.dev"
          Type: CNAME
          AliasTarget:
            HostedZoneId: !GetAtt DOWNSecELBTAF.CanonicalHostedZoneID
            DNSName: !GetAtt DOWNSecELBTAF.DNSName
  DOWNSecELBTAFListener:

    Type: AWS::ElasticLoadBalancingV2::Listener
    Properties:
      DefaultActions:
        - Type: forward
          TargetGroupArn:
            Ref: DOWNSecELBTAFTargetGroup
      LoadBalancerArn:
        Ref: DOWNSecELBTAF
      Port: 443
      Protocol: TCP
  DOWNSecELBTAFTargetGroup:

    Type: AWS::ElasticLoadBalancingV2::TargetGroup
    Properties:
      HealthCheckIntervalSeconds: 10
      HealthCheckPath: "/readyz"
      HealthCheckPort: 443
      HealthCheckProtocol: HTTPS
      HealthyThresholdCount: 2
      UnhealthyThresholdCount: 2
      Port: 443
      Protocol: TCP
      TargetType: ip
      VpcId: !Sub "{{resolve:ssm:/sample/vpc/sample-${pEnvironment}-${pSampleEnv}-vpc/id}}"
      TargetGroupAttributes:
        - Key: deregistration_delay.timeout_seconds
          Value: 60
  DOWNSecELBTAFLoadBalancerNameParameter:

    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub "/sample/elb/sample-central-services/elb/DOWNSecELBTAFloadbalancer/name"
      Type: String
      Value: !GetAtt DOWNSecELBTAF.LoadBalancerFullName
      Description: SSM Parameter for DOWNSecELBTAFLoadBalancerName
  DOWNSecELBTAFLoadBalancerDNSNameParameter:

    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub "/sample/elb/sample-central-services/elb/DOWNSecELBTAFloadbalancer/dnsname"
      Type: String
      Value: !Sub "upstream-elb.${pEnvironment}.${pDomain}.dev"
      Description: SSM Parameter for DOWNSecELBTAFLoadBalancer
  DOWNSecELBTAFTargetGroupArnParameter:
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub "/sample/lambda/sample-central-services/elb/DOWNSecELBTAFtargetgroup/arn"
      Type: String
      Value: !Ref DOWNSecELBTAFTargetGroup
      Description: SSM Parameter for DOWNSecELBTAFTargetGroup
  DOWNVSTELBTAF:
    Type: AWS::ElasticLoadBalancingV2::LoadBalancer
    Properties:
      Name: !Sub  sample-${pEnvironment}-${pSampleEnv}-downstream-vst-elb
      Scheme: internal
      IpAddressType: ipv4
      Subnets:
        - !Sub "{{resolve:ssm:/sample/vpc/sample-${pEnvironment}-${pSampleEnv}-vpc/sample-central-services-subnet/f/id}}"
        - !Sub "{{resolve:ssm:/sample/vpc/sample-${pEnvironment}-${pSampleEnv}-vpc/sample-central-services-subnet/g/id}}"
      Type: network
  DOWNVSTELBTAFServices:
    Type: AWS::EC2::VPCEndpointService
    Properties:
      AcceptanceRequired: false
      NetworkLoadBalancerArns:
        - !Ref DOWNVSTELBTAF
      SupportedIpAddressTypes:
        - ipv4
      Tags:
        - Key: "sampleDeploymentNumber"
          Value: "3"
        - Key: "Name"
          Value: "taf-downstream-vst"
  DOWNVSTELBTAFServicePermissions:
    Type: AWS::EC2::VPCEndpointServicePermissions
    DeletionPolicy: Retain
    Properties:
      AllowedPrincipals:
        - arn:aws-us-gov:iam::<PLACEHOLDER>:root
      ServiceId: !GetAtt DOWNVSTELBTAFServices.ServiceId
  DOWNVSTELBTAFRecord:
    Type: AWS::Route53::RecordSetGroup
    Properties:
      Comment: Alias record for the API server
      HostedZoneId: !Sub "{{resolve:ssm:/sample/route53/${pEnvironment}-dev/id}}"
      RecordSets:
        - Name: !Sub "vst.taf.downstream.elb.${pEnvironment}.${pDomain}.dev"
          Type: CNAME
          AliasTarget:
            HostedZoneId: !GetAtt DOWNVSTELBTAF.CanonicalHostedZoneID
            DNSName: !GetAtt DOWNVSTELBTAF.DNSName
  DOWNVSTELBTAFListener:

    Type: AWS::ElasticLoadBalancingV2::Listener
    Properties:
      DefaultActions:
        - Type: forward
          TargetGroupArn:
            Ref: DOWNVSTELBTAFTargetGroup
      LoadBalancerArn:
        Ref: DOWNVSTELBTAF
      Port: 443
      Protocol: TCP
  DOWNVSTELBTAFTargetGroup:

    Type: AWS::ElasticLoadBalancingV2::TargetGroup
    Properties:
      HealthCheckIntervalSeconds: 10
      HealthCheckPath: "/readyz"
      HealthCheckPort: 443
      HealthCheckProtocol: HTTPS
      HealthyThresholdCount: 2
      UnhealthyThresholdCount: 2
      Port: 443
      Protocol: TCP
      TargetType: ip
      VpcId: !Sub "{{resolve:ssm:/sample/vpc/sample-${pEnvironment}-${pSampleEnv}-vpc/id}}"
      TargetGroupAttributes:
        - Key: deregistration_delay.timeout_seconds
          Value: 60
  DOWNVSTELBTAFLoadBalancerNameParameter:

    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub "/sample/elb/sample-central-services/elb/DOWNVSTELBTAFloadbalancer/name"
      Type: String
      Value: !GetAtt DOWNVSTELBTAF.LoadBalancerFullName
      Description: SSM Parameter for DOWNVSTELBTAFLoadBalancerName
  DOWNVSTELBTAFLoadBalancerDNSNameParameter:

    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub "/sample/elb/sample-central-services/elb/DOWNVSTELBTAFloadbalancer/dnsname"
      Type: String
      Value: !Sub "upstream-elb.${pEnvironment}.${pDomain}.dev"
      Description: SSM Parameter for DOWNVSTELBTAFLoadBalancer
  DOWNVSTELBTAFTargetGroupArnParameter:

    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub "/sample/lambda/sample-central-services/elb/DOWNVSTELBTAFtargetgroup/arn"
      Type: String
      Value: !Ref DOWNVSTELBTAFTargetGroup
      Description: SSM Parameter for DOWNVSTELBTAFTargetGroup

  DOWNAppELBTAF:

    Type: AWS::ElasticLoadBalancingV2::LoadBalancer
    Properties:
      Name: !Sub  sample-${pEnvironment}-${pSampleEnv}-downstream-app-elb
      Scheme: internal
      IpAddressType: ipv4
      Subnets:
        - !Sub "{{resolve:ssm:/sample/vpc/sample-${pEnvironment}-${pSampleEnv}-vpc/sample-central-services-subnet/f/id}}"
        - !Sub "{{resolve:ssm:/sample/vpc/sample-${pEnvironment}-${pSampleEnv}-vpc/sample-central-services-subnet/g/id}}"
      Type: network
  DOWNAppELBTAFServices:

    Type: AWS::EC2::VPCEndpointService
    Properties:
      AcceptanceRequired: false
      NetworkLoadBalancerArns:
        - !Ref DOWNAppELBTAF
      SupportedIpAddressTypes:
        - ipv4
      Tags:
        - Key: "sampleDeploymentNumber"
          Value: "3"
        - Key: "Name"
          Value: "taf-downstream-app"
  DOWNAppELBTAFServicePermissions:

    Type: AWS::EC2::VPCEndpointServicePermissions
    DeletionPolicy: Retain
    Properties:
      AllowedPrincipals:
        - arn:aws-us-gov:iam::<PLACEHOLDER>:root
      ServiceId: !GetAtt DOWNAppELBTAFServices.ServiceId
  DOWNAppELBTAFRecord:

    Type: AWS::Route53::RecordSetGroup
    Properties:
      Comment: Alias record for the API server
      HostedZoneId: !Sub "{{resolve:ssm:/sample/route53/${pEnvironment}-dev/id}}"
      RecordSets:
        - Name: !Sub "app.taf.downstream.elb.${pEnvironment}.${pDomain}.dev"
          Type: CNAME
          AliasTarget:
            HostedZoneId: !GetAtt DOWNAppELBTAF.CanonicalHostedZoneID
            DNSName: !GetAtt DOWNAppELBTAF.DNSName
  DOWNAppELBTAFListener:

    Type: AWS::ElasticLoadBalancingV2::Listener
    Properties:
      DefaultActions:
        - Type: forward
          TargetGroupArn:
            Ref: DOWNAppELBTAFTargetGroup
      LoadBalancerArn:
        Ref: DOWNAppELBTAF
      Port: 443
      Protocol: TCP
  DOWNAppELBTAFTargetGroup:

    Type: AWS::ElasticLoadBalancingV2::TargetGroup
    Properties:
      HealthCheckIntervalSeconds: 10
      HealthCheckPath: "/readyz"
      HealthCheckPort: 443
      HealthCheckProtocol: HTTPS
      HealthyThresholdCount: 2
      UnhealthyThresholdCount: 2
      Port: 443
      Protocol: TCP
      TargetType: ip
      VpcId: !Sub "{{resolve:ssm:/sample/vpc/sample-${pEnvironment}-${pSampleEnv}-vpc/id}}"
      TargetGroupAttributes:
        - Key: deregistration_delay.timeout_seconds
          Value: 60
  DOWNAppELBTAFLoadBalancerNameParameter:

    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub "/sample/elb/sample-central-services/elb/DOWNAppELBTAFloadbalancer/name"
      Type: String
      Value: !GetAtt DOWNAppELBTAF.LoadBalancerFullName
      Description: SSM Parameter for DOWNAppELBTAFLoadBalancerName
  DOWNAppELBTAFLoadBalancerDNSNameParameter:

    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub "/sample/elb/sample-central-services/elb/DOWNAppELBTAFloadbalancer/dnsname"
      Type: String
      Value: !Sub "upstream-elb.${pEnvironment}.${pDomain}.dev"
      Description: SSM Parameter for DOWNAppELBTAFLoadBalancer
  DOWNAppELBTAFTargetGroupArnParameter:

    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub "/sample/lambda/sample-central-services/elb/DOWNAppELBTAFtargetgroup/arn"
      Type: String
      Value: !Ref DOWNAppELBTAFTargetGroup
      Description: SSM Parameter for DOWNAppELBTAFTargetGroup
  TAFOCPELBTAFServices:
    Type: AWS::EC2::VPCEndpointService
    DeletionPolicy: Delete
    Properties:
      AcceptanceRequired: false
      SupportedIpAddressTypes:
        - ipv4
      Tags:
        - Key: "sampleDeploymentNumber"
          Value: "3"
        - Key: "Name"
          Value: "taf-ocp"
  RegisterTargetLambdaIamRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub sample-${pEnvironment}-${pSampleEnv}-build-elb-lambda-role
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: "Allow"
            Principal:
              Service:
                - "lambda.amazonaws.com"
            Action:
              - "sts:AssumeRole"
      Path: "/"
      ManagedPolicyArns:
        - !Sub arn:${AWS::Partition}:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
      Policies:
        - PolicyName: !Sub sample-${pEnvironment}-${pSampleEnv}-build-elb-lambda-policy
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: "Allow"
                Action:
                  [
                    "elasticloadbalancing:RegisterTargets",
                    "elasticloadbalancing:DeregisterTargets",
                  ]
                Resource: "*"
              - Effect: "Allow"
                Action:
                  [
                    "elasticloadbalancing:RegisterTargets",
                    "elasticloadbalancing:DeregisterTargets",
                  ]
                Resource: "*"
  RegisterNlbIpTargets:
    Type: AWS::Lambda::Function
    Properties:
      Handler: "index.handler"
      Role: !GetAtt
        - "RegisterTargetLambdaIamRole"
        - "Arn"
      Code:
        ZipFile: |
          import json
          import boto3
          import cfnresponse
          def handler(event, context):
            elb = boto3.client('elbv2')
            if event['RequestType'] == 'Delete':
              elb.deregister_targets(TargetGroupArn=event['ResourceProperties']['TargetArn'],Targets=[{'Id': event['ResourceProperties']['TargetIp']}])
            elif event['RequestType'] == 'Create':
              elb.register_targets(TargetGroupArn=event['ResourceProperties']['TargetArn'],Targets=[{'Id': event['ResourceProperties']['TargetIp']}])
            elif event['RequestType'] == 'Update':
              elb.register_targets(TargetGroupArn=event['ResourceProperties']['TargetArn'],Targets=[{'Id': event['ResourceProperties']['TargetIp']}])
            responseData = {}
            cfnresponse.send(event, context, cfnresponse.SUCCESS, responseData, event['ResourceProperties']['TargetArn']+event['ResourceProperties']['TargetIp'])
      Runtime: "python3.11"
      Timeout: 120
  RegisterNlbIpTargetsLambdaParameter:
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub "/sample/lambda/sample-central-services/elb/registernlbiptargetslambda/arn"
      Type: String
      Value: !GetAtt RegisterNlbIpTargets.Arn
      Description: SSM Parameter for ApiServerDnsName
  BuilderEC2HostRegisterTarget:
    Type: Custom::NLBRegister
    Properties:
      ServiceTimeout: 300
      ServiceToken: !GetAtt RegisterNlbIpTargets.Arn
      TargetArn: !Ref BuildAppELBTargetGroup
      TargetIp: !Ref pBuilderIp
  BuilderEC2HostRegisterSSHTarget:
    Type: Custom::NLBRegister
    Properties:
      ServiceTimeout: 300
      ServiceToken: !GetAtt RegisterNlbIpTargets.Arn
      TargetArn: !Ref BuildAppELBSSHTargetGroup
      TargetIp: !Ref pBuilderIp